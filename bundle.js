(()=>{"use strict";var t=function(){function t(t,e,i){this.palette=t,this.tiles=e,this.map=i,this.cellMode=null!=this.map.cebk,this.tileCache=new Map,this.zero=[0,0,0,0],this.emptyTile=new Uint8ClampedArray(64),this.texture=gl.createTexture(),this.textures=new Map,this.program=gl.createProgram();var s=gl.createShader(gl.VERTEX_SHADER),a=gl.createShader(gl.FRAGMENT_SHADER);s&&a&&(gl.shaderSource(s,"\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  gl_Position = u_matrix * a_position;\n  v_texcoord = a_texcoord;\n}\n"),gl.compileShader(s),gl.shaderSource(a,"\nprecision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord);\n}\n"),gl.compileShader(a),gl.attachShader(this.program,s),gl.attachShader(this.program,a),gl.linkProgram(this.program)),this.positionLocation=gl.getAttribLocation(this.program,"a_position"),this.texcoordLocation=gl.getAttribLocation(this.program,"a_texcoord"),this.matrixLocation=gl.getUniformLocation(this.program,"u_matrix"),this.textureLocation=gl.getUniformLocation(this.program,"u_texture"),this.positionBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.positionBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),gl.STATIC_DRAW),this.texcoordBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.texcoordBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),gl.STATIC_DRAW),this.proj=mat4.create(),this.pos=vec3.clone([0,0,0])}return t.prototype.getTileImg=function(t,e,i){var s=e+":"+i;if(this.tileCache.has(s))return this.tileCache.get(s);var a=document.createElement("canvas");a.width=8,a.height=8;var r=a.getContext("2d");if(null!==a&&null!==r){for(var n=new Uint8ClampedArray(256),o=new ImageData(n,8,8),h=0,l=this.palette.pltt.palettes[i]||[],c=this.tiles.char.tiles[e]||this.emptyTile,d=0;d<64;d++){var u,m=c[d];u=t&&0==m?this.zero:l[m]||this.zero,n[h++]=u[0],n[h++]=u[1],n[h++]=u[2],n[h++]=u[3]}r.putImageData(o,0,0),this.tileCache.set(s,a)}return a},t.prototype.calcImageSize=function(t){for(var e=65536,i=65536,s=0,a=0,r=0;r<t.cells.length;r++){var n=t.cells[r],o=n.size,h=n.x+o[0];h>s&&(s=h),(h-=o[0])<e&&(e=h);var l=n.y+o[1];l>a&&(a=l),(l-=o[1])<i&&(i=l)}return[e,i,s,a]},t.prototype.toCanvas=function(t,e){var i=document.createElement("canvas");if(this.cellMode){var s=this.map.cebk.images[e],a=this.calcImageSize(s);i.width=a[2]-a[0],i.height=a[3]-a[1];var r=i.getContext("2d");if(null!==r){var n=this.tiles.char.tilesX;s.cells.sort((function(t,e){return e.priority-t.priority}));for(var o=s.cells.length-1;o>=0;o--){var h=s.cells[o],l=h.size,c=l[0]/2,d=l[1]/2;r.save(),r.translate(h.x+c-a[0],h.y+d-a[1]),r.scale(h.xFlip?-1:1,h.yFlip?-1:1);var u=h.tileOffset,m=h.pal;if(r.strokeStyle="white",!h.disable){for(var f=u,p=0;p<l[1];p+=8){for(var v=0;v<l[0];v+=8){var _=this.getTileImg(t,u++,m);_&&r.drawImage(_,v-c,p-d)}65535!=n&&(u=f+=n)}r.restore()}}}}return i},t.prototype.toTexture=function(t,e){var i=new Image;i.crossOrigin="Anonymous",i.src=this.toCanvas(t,e).toDataURL();var s=gl.createTexture();return s.width=0,s.height=0,i.onload=function(){gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,s),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,i),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),s.width=i.width,s.height=i.height},s},t.prototype.loadTextue=function(t){if(this.textures.has(t))this.texture=this.textures.get(t);else{var e=this.toTexture(!0,t);this.textures.set(t,e),this.texture=e}return this.texture},t.prototype.debugTileSet=function(){for(var t=0;t<this.map.cebk.imageCount;t++){var e=this.toCanvas(!0,t);e.setAttribute("tile","".concat(t)),document.body.appendChild(e)}},t.prototype.draw=function(t,e,i){void 0===i&&(i=1),this.drawTexture(this.texture,i*this.texture.width,i*this.texture.height,t,e)},t.prototype.drawTexture=function(t,e,i,s,a){gl.useProgram(this.program),gl.bindTexture(gl.TEXTURE_2D,t),gl.bindBuffer(gl.ARRAY_BUFFER,this.positionBuffer),gl.enableVertexAttribArray(this.positionLocation),gl.vertexAttribPointer(this.positionLocation,2,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,this.texcoordBuffer),gl.enableVertexAttribArray(this.texcoordLocation),gl.vertexAttribPointer(this.texcoordLocation,2,gl.FLOAT,!1,0,0),mat4.ortho(this.proj,0,gl.canvas.width,gl.canvas.height,0,-1,1),this.pos[0]=s,this.pos[1]=a,mat4.translate(this.proj,this.proj,this.pos),mat4.scale(this.proj,this.proj,[e,i,1]),gl.uniformMatrix4fv(this.matrixLocation,!1,this.proj),gl.uniform1i(this.textureLocation,0),gl.drawArrays(gl.TRIANGLES,0,6)},t}(),e=function(){function t(){}return t.asciiFromCharCode=function(t){return t<1||t>127?"":String.fromCharCode(t)},t.asciireadChar=function(e,i){var s=e.getUint8(i);return t.asciiFromCharCode(s)},t}(),i=function(){function t(){}return t.readHeader=function(e){for(var i=t.readChar(e,0)+t.readChar(e,1)+t.readChar(e,2)+t.readChar(e,3),s=e.getUint32(4,!0),a=e.getUint32(8,!0),r=e.getUint16(12,!0),n=e.getUint16(14,!0),o=[],h=0;h<n;h++)o.push(e.getUint32(16+4*h,!0));return{stamp:i,unknown1:s,filesize:a,headsize:r,numSections:n,sectionOffsets:o}},t.read3dInfo=function(e,i,s){var a=i;i+=1;var r=e.getUint8(i++);e.getUint16(i,!0),i+=2,e.getUint16(i,!0),i+=2,e.getUint16(i,!0),i+=2;var n=e.getUint32(i,!0);i+=4;for(var o=[],h=0;h<r;h++){var l=e.getUint16(i,!0),c=e.getUint16(i+2,!0);o.push({uk1:l,uk2:c}),i+=4}e.getUint16(i,!0),i+=2,e.getUint16(i,!0),i+=2;var d=[];for(h=0;h<r;h++){var u=s(e,i,a,h);d.push(u),i=u.nextoff}var m=[];for(h=0;h<r;h++){for(var f="",p=0;p<16;p++)f+=t.readChar(e,i++);d[h].name=f,m.push(f)}return{numObjects:r,unknown:n,objectUnk:o,objectData:d,names:m,nextoff:i}},t.readChar=function(t,i){return e.asciireadChar(t,i)},t}(),s=function(){function t(t){this.input=t,this.dimensions=[[[8,8],[16,8],[8,16]],[[16,16],[32,8],[8,32]],[[32,32],[32,16],[16,32]],[[64,64],[64,32],[32,64]]],this.mainOff=void 0,null!=this.input&&this.load(this.input),this.load=this.load}return t.prototype.load=function(t){var e,s=new DataView(t);if("RECN"!=(e=i.readHeader(s)).stamp)throw"NCER invalid. Expected RECN, found "+e.stamp;if(e.numSections<1||e.numSections>3)throw"NCER invalid. Too many sections - should have 1-3.";this.sectionOffsets=e.sectionOffsets,this.sectionOffsets[0]=24,this.mainOff=0,this.cebk=this._loadCEBK(s)},t.prototype._getSize=function(t,e,i){var s=this.dimensions[e][t];return i?[2*s[0],2*s[1]]:[s[0],s[1]]},t.prototype._readOAM=function(t,e){var i=t.getUint16(e,!0),s=t.getUint16(e+2,!0),a=t.getUint16(e+4,!0),r=(256&i)>0,n=511&s,o=255&i,h=s>>14&3,l=i>>14&3,c=r&&(512&i)>0;return{y:o>128?o-256:o,rsFlag:r,disable:!r&&(512&i)>0,doubleSize:c,objMode:i>>10&3,mosaic:(4096&i)>0,depth:(8192&i)>0,shape:l,x:n>256?n-512:n,xFlip:!r&&(4096&s)>0,yFlip:!r&&(8192&s)>0,selectParam:r?s>>9&31:0,size:this._getSize(l,h,c),tileOffset:1023&a,priority:a>>10&3,pal:a>>12&15}},t.prototype._loadCEBK=function(t){var i=this.sectionOffsets[0]-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("KBEC"!=s)throw"NCER invalid. Expected KBEC, found "+s;for(var a,r,n=t.getUint32(i+4,!0),o=t.getUint16(i+8,!0),h=t.getUint16(i+10,!0),l=t.getUint32(i+12,!0),c=64*t.getUint32(i+16,!0),d=t.getUint32(i+20,!0),u=[],m=(i+=32)+o*(8+8*h),f=0;f<o;f++){var p=t.getUint16(i,!0),v=t.getUint16(i+2,!0),_=t.getInt32(i+4,!0),g=void 0,T=void 0,b=void 0,y=void 0;i+=8,1==h&&(g=t.getInt16(i,!0),T=t.getInt16(i+2,!0),b=t.getInt16(i+4,!0),y=t.getInt16(i+6,!0),i+=8);for(var M=m+_,A=[],w=0;w<p;w++){var S=this._readOAM(t,M);M+=6,A.push(S)}u.push({offset:_,numCells:p,readOnlyInfo:v,xMax:g,yMax:T,xMin:b,yMin:y,cells:A,partitionOffset:void 0,partitionSize:void 0})}if(0!=d){var R=this.sectionOffsets[0]+d;for(a=t.getUint32(R,!0),R+=r=t.getUint32(R+4,!0),f=0;f<o;f++)u[f].partitionOffset=t.getUint32(R,!0),u[f].partitionSize=t.getUint32(R+4,!0),R+=8}return{type:s,blockSize:n,imageCount:o,bankType:h,unknown:l,boundarySize:c,partitionDataOffset:d,images:u,maxPartitionSize:a,firstOffset:r}},t}(),a=function(){function t(t){this.input=t,this.mainOff=void 0,null!=this.input&&this.load(this.input),this.load=this.load}return t.prototype.load=function(t){var e,s=new DataView(t),a=i.readHeader(s);if("RGCN"!=a.stamp)throw"NCGR invalid. Expected RGCN, found "+a.stamp;if(a.numSections<1||a.numSections>2)throw"NCGR invalid. Too many sections - should have 2.";e=a.sectionOffsets[0],this.sectionOffsets=a.sectionOffsets,this.sectionOffsets[0]=24,this.mainOff=e,this.char=this._loadCHAR(s),a.numSections>1&&(this.cpos=this._loadCPOS(s))},t.prototype._loadCHAR=function(t){var i=this.sectionOffsets[0]-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("RAHC"!=s)throw"NCGR invalid. Expected RAHC, found "+s;var a=t.getUint32(i+4,!0);this.sectionOffsets[1]=this.sectionOffsets[0]+a;var r=t.getUint16(i+8,!0),n=t.getUint16(i+10,!0),o=t.getUint32(i+12,!0),h=t.getUint32(i+20,!0),l=t.getUint32(i+24,!0),c=t.getUint32(i+28,!0);i+=32;for(var d=(a-32)/(4==o?64:32),u=[],m=0;m<d;m++){var f=[];if(4==o)for(var p=0;p<64;p++)f.push(t.getUint8(i++));else for(p=0;p<32;p++){var v=t.getUint8(i++);f.push(15&v),f.push(v>>4)}u.push(new Uint8ClampedArray(f))}return{type:s,blockSize:a,tilesY:r,tilesX:n,bitDepth:o,tiledFlag:h,tileDataSize:l,unknown:c,tiles:u}},t.prototype._loadCPOS=function(t){var i=this.sectionOffsets[1]-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("SOPC"!=s)throw"NCLR invalid. Expected SOPC, found ";return{type:s,blockSize:t.getUint32(i+4,!0),tileSize:t.getUint16(i+12,!0),tileCount:t.getUint16(i+14,!0)}},t}(),r=function(){function t(t){this.input=t,this.mainOff=void 0,null!=this.input&&this.load(this.input),this.load=this.load}return t.prototype.load=function(t){var e,s=new DataView(t),a=i.readHeader(s);if("RLCN"!=a.stamp)throw"NCLR invalid. Expected RLCN, found "+a.stamp;if(a.numSections<1||a.numSections>2)throw"NCLR invalid. Too many sections - should have 2.";e=a.sectionOffsets[0],this.sectionOffsets=a.sectionOffsets,this.sectionOffsets[0]=24,this.mainOff=e,this.pltt=this._loadPLTT(s),a.numSections>1&&(this.pcmp=this._loadPCMP(s))},t.prototype._loadPLTT=function(t){var i=this.sectionOffsets[0]-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("TTLP"!=s)throw"NCLR invalid. Expected TTLP, found "+s;var a=t.getUint32(i+4,!0);this.sectionOffsets[1]=this.sectionOffsets[0]+a;var r=t.getUint32(i+8,!0),n=t.getUint32(i+12,!0),o=t.getUint32(i+16,!0)/2,h=t.getUint32(i+20,!0),l=4==r?256:16,c=(a-24)/2;i+=24;for(var d=[],u=[],m=0;m<c;m++)u.push(this._readPalColour(t,i)),u.length>=l&&(d.push(u),u=[]),i+=2;return u.length>0&&d.push(u),{type:s,blockSize:a,bitDepth:r,padding:n,palEntries:o,colorsPerPal:h,palettes:d}},t.prototype._loadPCMP=function(t){var i=this.sectionOffsets[1]-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("PMCP"!=s)throw"NCLR invalid. Expected PMCP, found ";var a=t.getUint32(i+4,!0),r=t.getUint16(i+8,!0),n=t.getUint32(i+12,!0);i+=16;for(var o=[],h=0;h<r;h++)o.push(t.getUint16(i,!0)),i+=2;return{type:s,blockSize:a,palCount:r,unknown:n,palIDs:o}},t.prototype._readPalColour=function(t,e){var i=t.getUint16(e,!0),s=255/31;return[Math.round((31&i)*s),Math.round((i>>5&31)*s),Math.round((i>>10&31)*s),255]},t}(),n=function(){function t(t){this.input=t,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){for(var e=new DataView(t),i=0,s=[],a=0;a<37;a++){var r=this.readString(e,i,16);i+=16;var n=e.getInt32(i,!0)/4096;i+=4;for(var o=[],h=0;h<4;h++)(c=vec3.create())[0]=e.getInt32(i,!0)/4096,c[1]=e.getInt32(i+4,!0)/4096,c[2]=e.getInt32(i+8,!0)/4096,i+=12,o.push(c);var l=[];for(h=0;h<13;h++){var c;(c=vec3.create())[0]=e.getInt32(i,!0)/4096,c[1]=e.getInt32(i+4,!0)/4096,c[2]=e.getInt32(i+8,!0)/4096,i+=12,l.push(c)}s.push({name:r,frontTireSize:n,wheels:o,chars:l})}this.karts=s},t.prototype.readString=function(t,i,s){for(var a="",r=0;r<s;r++){var n=t.getUint8(i++);0!=n&&(a+=e.asciiFromCharCode(n))}return a},t}(),o=function(){function t(t){this.input=t,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var e=new DataView(t),i=0;this.karts=[];for(var s=0;s<50;s++){for(var a=[],r=i+56,n=i+104,o=0;o<12;o++){var h=e.getInt32(r,!0)/4096,l=e.getInt32(n,!0)/4096;a.push({handling:h,topSpeedMul:l}),r+=4,n+=4}this.karts.push({colRadius:e.getInt32(i,!0)/4096,unknown1:e.getInt32(i+4,!0)/4096,unknown2:e.getInt32(i+8,!0)/4096,weight:e.getInt16(i+12,!0)/4096,miniTurbo:e.getUint16(i+14,!0),topSpeed:e.getInt32(i+16,!0)/4096,accel1:e.getInt32(i+20,!0)/4096,accel2:e.getInt32(i+24,!0)/4096,accelSwitch:e.getInt32(i+28,!0)/4096,driftAccel1:e.getInt32(i+32,!0)/4096,driftAccel2:e.getInt32(i+36,!0)/4096,driftAccelSwitch:e.getInt32(i+40,!0)/4096,decel:e.getInt32(i+44,!0)/4096,turnRate:e.getInt16(i+48,!0)/32768*Math.PI,driftTurnRate:e.getInt16(i+50,!0)/32768*Math.PI,driftOffRestore:e.getInt16(i+52,!0)/32768*Math.PI,unknown3:e.getInt16(i+54,!0),colParam:a}),i+=152}},t}(),h=function(){function t(){}return t.decompress=function(t){for(var e=new DataView(t),i=(e.getUint8(0),e.getUint32(0,!0)>>8),s=new ArrayBuffer(i),a=new Uint8Array(s),r=4,n=0,o=t.byteLength;r<o;)for(var h=e.getUint8(r++),l=7;l>=0&&!(r>=o);l--)if(h>>l&1){var c=e.getUint16(r);r+=2;for(var d=n-(4095&c)-1,u=3+(c>>12),m=0;m<u;m++)a[n++]=a[d++]}else a[n++]=e.getUint8(r++);return s},t}(),l=function(){function t(t){var e=this;if(this.input=t,this._handlers={},this._handlers.BTAF=function(t,e,i){i.numFiles=t.getUint16(e,!0),i.reserved=t.getUint16(e+2,!0),i.files=[],e+=4;for(var s=0;s<i.numFiles;s++)i.files.push({start:t.getUint32(e,!0),end:t.getUint32(e+4,!0)}),e+=8},this._handlers.BTNF=function(t,i,s){var a=i;s.directories=[];var r=a+t.getUint32(i,!0),n={firstFile:t.getUint16(i+4,!0),numDir:t.getUint16(i+6,!0)};e._populateDir(t,r,n),i+=8,s.directories.push(n);for(var o=n.numDir-1,h=0;h<o;h++){r=a+t.getUint32(i,!0);var l={firstFile:t.getUint16(i+4,!0),parent:t.getUint16(i+6,!0)};e._populateDir(t,r,l),i+=8,s.directories.push(l)}},this._handlers.GMIF=function(t,e,i){i.baseOff=e},null!=this.input)if("string"==typeof this.input){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",this.input,!0),i.onload=function(){e.load(i.response)},i.send()}else this.load(this.input)}return t.prototype.load=function(t){this.input=t;var i=new DataView(t);if(this.stamp=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3),"NARC"!=this.stamp)throw"File provided is not a NARC archive! Expected NARC, found "+this.stamp+".";this.byteOrder=i.getUint16(4,!0),this.version=i.getUint16(6,!0),this.size=i.getUint32(8,!0),this.headSize=i.getUint16(12,!0),this.numBlocks=i.getUint16(14,!0);var s=this.headSize;this.sections={};for(var a=0;a<this.numBlocks;a++){var r=this._readSection({view:i,off:s});this.sections[r.type]=r,s=4*Math.ceil(r.nextOff/4)}},t.prototype._readSection=function(t){var i=t.view,s=t.off,a=e.asciireadChar(i,s+0)+e.asciireadChar(i,s+1)+e.asciireadChar(i,s+2)+e.asciireadChar(i,s+3),r=i.getUint32(s+4,!0),n={type:a,size:r,nextOff:s+r};if(null==this._handlers[a])throw"Unknown NARC section "+a+"!";return this._handlers[a](i,s+8,n),n},t.prototype.getFile=function(t){for(var e=t.split("/"),i=""==e[0]?1:0,s=this.sections.BTNF.directories,a=s[0].entries,r=i;r<e.length;r++){for(var n=!1,o=0;o<a.length;o++)if(a[o].name==e[r]){if(a[o].dir){n=!0,a=s[a[o].id-61440].entries;break}return this._readFileWithID(a[o].id)}if(!n)return console.error("File not found: "+t+", could not find "+e[r]),null}return console.error("Path is not a file: "+t),null},t.prototype.list=function(t,e,i){i=i||"/",t=t||[];var s=this.sections.BTNF.directories;e=e||s[0].entries;for(var a=0;a<e.length;a++)e[a].dir?this.list(t,s[e[a].id-61440].entries,i+e[a].name+"/"):t.push(i+e[a].name);return t},t.prototype._readFileWithID=function(t){var e=this.sections.BTAF.files[t],i=this.sections.GMIF.baseOff;return null==e?(console.error("File ID invalid: "+t),null):this.input.slice(e.start+i,e.end+i)},t.prototype._populateDir=function(t,e,i){var s=i.firstFile;for(i.entries=[];;){var a=t.getUint8(e++),r=127&a;if(128&a){var n=t.getUint16(e+r,!0);i.entries.push({dir:!0,id:n,name:this._readString(t,e,r)}),e+=r+2}else{if(0==r)return;i.entries.push({dir:!1,id:s++,name:this._readString(t,e,r)}),e+=r}}},t.prototype._readString=function(t,i,s){for(var a="",r=0;r<s;r++)a+=e.asciireadChar(t,i++);return a},t}(),c=function(){function t(t){this.files=t}return t.prototype.getFile=function(t){for(var e=0;e<this.files.length;e++){var i=this.files[e].getFile(t);if(null!=i)return i}return console.error("File not found: "+t),null},t.prototype.list=function(){for(var t=[],e=0;e<this.files.length;e++)this.files[e].list(t);return t},t}(),d=function(){function t(t){this.input=t,this.mainOff,this.info=void 0,this.charMap={},null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var s=new DataView(t),a=i.readHeader(s);if("RTFN"!=a.stamp)throw"NFTR invalid. Expected RTFN, found "+a.stamp;var r=e.asciireadChar(s,16)+e.asciireadChar(s,17)+e.asciireadChar(s,18)+e.asciireadChar(s,19),n=s.getUint32(20,!0),o=s.getUint8(24),h=s.getUint8(25),l=s.getUint16(26,!0),c=s.getUint8(28),d=s.getUint8(29),u=s.getUint8(30),m=s.getUint8(31),f=s.getUint32(32,!0),p=s.getUint32(36,!0),v=s.getUint32(40,!0),_=void 0,g=void 0,T=void 0,b=void 0;32==n&&(_=s.getUint8(44),g=s.getUint8(45),T=s.getUint8(46),b=s.getUint8(47)),this.info={type:r,blockSize:n,unknown1:o,height:h,nullCharIndex:l,unknown2:c,width:d,widthBis:u,encoding:m,offsetCGLP:f,offsetCWDH:p,offsetCMAP:v,fontHeight:_,fontWidth:g,bearingX:T,bearingY:b},this._loadCGLP(s),this._loadCWDH(s),this._loadCMAP(s),this.mainOff=16},t.prototype._loadCGLP=function(t){var i=this.info.offsetCGLP-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3),a=t.getUint32(i+4,!0),r=t.getUint8(i+8),n=t.getUint8(i+9),o=t.getUint16(i+10,!0),h=t.getUint16(i+12,!0),l=t.getUint8(i+14),c=t.getUint8(i+15);i+=16;for(var d=[],u=(a-16)/o,m=0;m<u;m++)d.push(new Uint8Array(t.buffer.slice(i,i+o))),i+=o;this.cglp={type:s,blockSize:a,tileWidth:r,tileHeight:n,tileLength:o,unknown:h,depth:l,rotateMode:c,tiles:d}},t.prototype._loadCWDH=function(t){var i=this.info.offsetCWDH-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3),a=t.getUint32(i+4,!0),r=t.getUint16(i+8,!0),n=t.getUint16(i+10,!0),o=t.getUint32(i+12,!0),h=[];i+=16;for(var l=0;l<this.cglp.tiles.length;l++)h.push({pixelStart:t.getInt8(i),pixelWidth:t.getUint8(i+1),pixelLength:t.getUint8(i+2)}),i+=3;this.cwdh={type:s,blockSize:a,firstCode:r,lastCode:n,unknown:o,info:h}},t.prototype._loadCMAP=function(t){var i=this.info.offsetCMAP-8;for(this.cmaps=[];i>0&&i<t.byteLength;){var s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3),a=t.getUint32(i+4,!0),r=t.getUint16(i+8,!0),n=t.getUint16(i+10,!0),o=t.getUint32(i+12,!0),h=t.getUint32(i+16,!0),l=void 0,c=void 0,d=void 0,u=void 0;switch(i+=20,65535&o){case 1:l=[];for(var m=n-r+1,f=r,p=0;p<m;p++){var v=t.getUint16(i,!0);l.push(v),65535!=v&&(this.charMap[e.asciiFromCharCode(f)]=v),f++,i+=2}break;case 2:for(c=t.getUint16(i,!0),i+=2,d=[],p=0;p<c;p++)f=t.getUint16(i,!0),v=t.getUint16(i+2,!0),d.push([f,v]),this.charMap[e.asciiFromCharCode(f)]=v,i+=4;break;default:for(m=n-r+1,f=r,v=u=t.getUint16(i,!0),p=0;p<m;p++)this.charMap[e.asciiFromCharCode(f++)]=v++}this.cmaps.push({type:s,blockSize:a,firstChar:r,lastChar:n,typeSection:o,charCodes:l,numChars:c,charMap:d,firstCharCode:u,nextOffset:h}),i=h-8}},t.prototype.mapText=function(t,e){null==e&&(e="*");for(var i=this.charMap,s=[],a=0;a<t.length;a++){var r=i[t[a]];null==r&&(r=i[e]),s.push(r)}return s},t.prototype.measureText=function(t,e,i){return this.measureMapped(this.mapText(t,e),i)},t.prototype.measureMapped=function(t,e){null==e&&(e=1);for(var i=0,s=this.cwdh.info,a=0;a<t.length;a++)i+=s[t[a]].pixelLength+e;return[i,this.info.height]},t.prototype.drawToCanvas=function(t,e,i){null==i&&(i=1);var s=this.mapText(t,""),a=this.measureMapped(s,i),r=document.createElement("canvas");r.width=a[0],r.height=a[1];for(var n=r.getContext("2d"),o=this.cwdh.info,h=0,l=0;l<s.length;l++){var c=s[l],d=o[c],u=this._getCharData(c,e);n.putImageData(u,h+d.pixelStart,0,0,0,d.pixelWidth,u.height),h+=d.pixelLength+i}return r},t.prototype._getCharData=function(t,e){for(var i=this.cglp,s=i.tiles[t],a=i.tileWidth*i.tileHeight,r=new Uint8ClampedArray(4*a),n=new ImageData(r,i.tileWidth,i.tileHeight),o=this.cglp.depth,h=(1<<o)-1,l=8,c=0,d=s[c],u=0,m=0;m<a;m++){var f=0;(l-=o)<0?(l+8<8&&(f=d<<-l&h),f|=(d=s[++c])>>(l+=8)&h):f=d>>l&h;var p=e[f];r[u++]=p[0],r[u++]=p[1],r[u++]=p[2],r[u++]=p[3]}return n},t}(),u=function(){function t(t){this.input=t,this.mainOff=void 0,this.animData=void 0,this.speeds=[1,.5,1/4],null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var s,a,r=this,n=new DataView(t);if("BCA0"!=(s=i.readHeader(n)).stamp)throw"NSBCA invalid. Expected BCA0, found "+s.stamp;if(s.numSections>1)throw"NSBCA invalid. Too many sections - should have 1 maximum.";a=s.sectionOffsets[0],this.mainOff=a;var o=e.asciireadChar(n,a+0)+e.asciireadChar(n,a+1)+e.asciireadChar(n,a+2)+e.asciireadChar(n,a+3);if("JNT0"!=o)throw"NSBCA invalid. Expected JNT0, found "+o;this.animData=i.read3dInfo(n,this.mainOff+8,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r._animInfoHandler(t[0],t[1])}))},t.prototype._animInfoHandler=function(t,i){var s=this.mainOff+t.getUint32(i,!0),a={baseOff:s,stamp:e.asciireadChar(t,s+0)+e.asciireadChar(t,s+2)+e.asciireadChar(t,s+3),frames:t.getUint16(s+4,!0),numObj:t.getUint16(s+6,!0),unknown:t.getUint32(s+8,!0),off1:t.getUint32(s+12,!0),off2:t.getUint32(s+16,!0),nextoff:i+4,trans:void 0};s+=20;for(var r=[],n=0;n<a.numObj;n++){var o=t.getUint16(s,!0)+a.baseOff;r.push(this._readTrans(t,o,a)),s+=2}return a.trans=r,a},t.prototype._readTrans=function(t,e,i){var s=t.getUint16(e,!0);e+=4;var a={flag:void 0,translate:void 0,tlExtra:void 0,rotate:void 0,rotExtra:void 0,scale:void 0,scExtra:void 0};if(a.flag=s,!(s>>1&1)){for(var r=[[],[],[]],n=[],o=0;o<3;o++)if(s>>3+o&1)r[o].push(t.getInt32(e,!0)/4096),e+=4;else{(_={startFrame:void 0,endFrame:void 0,halfSize:void 0,speed:void 0,off:void 0}).startFrame=t.getUint16(e,!0);var h=t.getUint16(e+2,!0);_.endFrame=4095&h,_.halfSize=h>>12&3,_.speed=this.speeds[h>>14&3],_.off=t.getUint32(e+4,!0),3!=i.unknown||(i.frames,_.endFrame);for(var l=Math.ceil((_.endFrame-_.startFrame)*_.speed),c=_.halfSize?2:4,d=i.baseOff+_.off,u=0;u<l;u++)r[o].push((_.halfSize?t.getInt16(d,!0):t.getInt32(d,!0))/4096),d+=c;n[o]=_,e+=8}a.translate=r,a.tlExtra=n}if(!(s>>6&1)){var m,f=[];if(s>>8&1)f.push(this._readRotation(t,e,i)),e+=4;else{(_={startFrame:void 0,endFrame:void 0,halfSize:void 0,speed:void 0,off:void 0}).startFrame=t.getUint16(e,!0),h=t.getUint16(e+2,!0),_.endFrame=4095&h,_.halfSize=h>>12&3,_.speed=this.speeds[h>>14&3],_.off=t.getUint32(e+4,!0),3!=i.unknown||(i.frames,_.endFrame),l=Math.ceil((_.endFrame-_.startFrame)*_.speed),d=i.baseOff+_.off;try{for(u=0;u<l;u++)f.push(this._readRotation(t,d,i)),d+=2}catch(t){}m=_,e+=8}a.rotate=f,a.rotExtra=m}if(!(s>>9&1)){var p=[[],[],[]],v=[];for(o=0;o<3;o++)if(s>>11+o&1)p[o].push({s1:t.getInt32(e,!0)/4096,s2:t.getInt32(e,!0)/4096}),e+=8;else{var _;for((_={startFrame:void 0,endFrame:void 0,halfSize:void 0,speed:void 0,off:void 0}).startFrame=t.getUint16(e,!0),h=t.getUint16(e+2,!0),_.endFrame=4095&h,_.halfSize=h>>12&3,_.speed=this.speeds[h>>14&3],_.off=t.getUint32(e+4,!0),3!=i.unknown||(i.frames,_.endFrame),l=Math.ceil((_.endFrame-_.startFrame)*_.speed),c=_.halfSize?2:4,d=i.baseOff+_.off,u=0;u<l;u++)p[o].push({s1:(_.halfSize?t.getInt16(d,!0):t.getInt32(d,!0))/4096,s2:(_.halfSize?t.getInt16(d+c,!0):t.getInt32(d+c,!0))/4096}),d+=2*c;v[o]=_,e+=8}a.scale=p,a.scExtra=v}return a},t.prototype._readRotation=function(t,e,i){var s=t.getInt16(e,!0),a=32767&s;if(s>>15){var r=i.baseOff+i.off1+6*a;return{pivot:!0,param:t.getUint16(r,!0),a:t.getInt16(r+2,!0)/4096,b:t.getInt16(r+4,!0)/4096}}r=i.baseOff+i.off2+10*a;for(var n=t.getUint16(r,!0),o=t.getUint16(r+2,!0),h=t.getUint16(r+4,!0),l=t.getUint16(r+6,!0),c=t.getUint16(r+8,!0),d=[n>>3,o>>3,h>>3],u=[l>>3,c>>3,(7&c)<<12|(7&n)<<9|(7&o)<<6|(7&h)<<3|7&l],m=0;m<3;m++)4096&d[m]&&(d[m]-=8192),4096&u[m]&&(u[m]-=8192);vec3.scale(d,d,1/4096),vec3.scale(u,u,1/4096);var f=vec3.cross([0,0,0],d,u);return{pivot:!1,mat:mat3.clone([d[0],d[1],d[2],u[0],u[1],u[2],f[0],f[1],f[2]])}},t}(),m=function(){function t(t,e){this.input=t,this.tex0=e,this.texDataSize=void 0,this.texInfoOff=void 0,this.texOffset=void 0,this.compTexSize=void 0,this.compTexOffset=void 0,this.compTexInfoDataOff=void 0,this.palSize=void 0,this.palInfoOff=void 0,this.palOffset=void 0,this.mainOff=void 0,this.textureInfo=void 0,this.paletteInfo=void 0,this.palData=void 0,this.texData=void 0,this.compData=void 0,this.compInfoData=void 0,this.colourBuffer=void 0,null!=this.input&&this.load(this.input,this.tex0),this.cache={}}return t.prototype.load=function(t,s){var a=this;this.colourBuffer=new Uint32Array(4);var r=new DataView(t),n=null,o=0;if(!s){if("BTX0"!=(n=i.readHeader(r)).stamp)throw"nsbtx invalid. Expected BTX0, found "+n.stamp;if(n.numSections>1)throw"NSBTX invalid. Too many sections - should only have one.";o=n.sectionOffsets[0]}this.mainOff=o;var h=e.asciireadChar(r,o+0)+e.asciireadChar(r,o+1)+e.asciireadChar(r,o+2)+e.asciireadChar(r,o+3);if("TEX0"!=h)throw"NSBTX invalid. Expected TEX0, found "+h;r.getUint32(o+4,!0),this.texDataSize=r.getUint16(o+12,!0)<<3,this.texInfoOff=r.getUint16(o+14,!0),this.texOffset=r.getUint16(o+20,!0),this.compTexSize=r.getUint16(o+28,!0)<<3,r.getUint16(o+30,!0),this.compTexOffset=r.getUint32(o+36,!0),this.compTexInfoDataOff=r.getUint32(o+40,!0),this.palSize=r.getUint32(o+48,!0)<<3,this.palInfoOff=r.getUint32(o+52,!0),this.palOffset=r.getUint32(o+56,!0);var l=this.mainOff+this.palOffset;this.palData=t.slice(l,l+this.palSize);var c=this.mainOff+this.texOffset;this.texData=t.slice(c,c+this.texDataSize);var d=this.mainOff+this.compTexOffset;this.compData=t.slice(d,d+this.compTexSize);var u=this.mainOff+this.compTexInfoDataOff;this.compInfoData=t.slice(u,u+this.compTexSize/2),this.paletteInfo=i.read3dInfo(r,this.mainOff+this.palInfoOff,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return a._palInfoHandler(t[0],t[1])})),this.textureInfo=i.read3dInfo(r,this.mainOff+this.texInfoOff,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return a._texInfoHandler(t[0],t[1])})),this.paletteInfoNameToIndex=this._buildNameToIndex(this.paletteInfo),this.textureInfoNameToIndex=this._buildNameToIndex(this.textureInfo)},t.prototype.readTexWithPal=function(t,e){var i=this.textureInfo.objectData[t],s=this.paletteInfo.objectData[e],a=i.format,r=i.pal0trans;if(5==a)return this._readCompressedTex(i,s);var n=i.texOffset,o=new DataView(this.palData),h=new DataView(this.texData),l=s.palOffset,c=document.createElement("canvas");c.width=i.width,c.height=i.height;for(var d,u=c.getContext("2d"),m=u.getImageData(0,0,i.width,i.height),f=i.width*i.height,p=0;p<f;p++){var v;if(1==a){var _=h.getUint8(n++);(v=this._readPalColour(o,l,31&_,r))[3]=255/7*(_>>5),this._premultiply(v)}else if(2==a)p%4==0&&(d=h.getUint8(n++)),v=this._readPalColour(o,l,d>>p%4*2&3,r);else if(3==a)p%2==0?(d=h.getUint8(n++),v=this._readPalColour(o,l,15&d,r)):v=this._readPalColour(o,l,d>>4,r);else if(4==a)v=this._readPalColour(o,l,h.getUint8(n++),r);else if(6==a)_=h.getUint8(n++),(v=this._readPalColour(o,l,7&_,r))[3]=255/31*(_>>3),this._premultiply(v);else{if(7!=a)return console.warn("texture format is none, ignoring"),c;v=h.getUint16(n,!0),this.colourBuffer[0]=Math.round((31&v)/31*255),this.colourBuffer[1]=Math.round((v>>5&31)/31*255),this.colourBuffer[2]=Math.round((v>>10&31)/31*255),this.colourBuffer[3]=Math.round(255*(v>>15)),v=this.colourBuffer,this._premultiply(v),n+=2}m.data.set(v,4*p)}return u.putImageData(m,0,0),c},t.prototype._buildNameToIndex=function(t){for(var e={},i=0;i<t.names.length;i++)e["$"+t.names[i]]=i;return e},t.prototype._premultiply=function(t){t[0]*=t[3]/255,t[1]*=t[3]/255,t[2]*=t[3]/255},t.prototype._readCompressedTex=function(t,e){var i=t.texOffset,s=new DataView(this.compData),a=new DataView(this.compInfoData),r=new DataView(this.palData),n=i/2,o=e.palOffset,h=new Uint8Array([0,0,0,0]),l=document.createElement("canvas");l.width=t.width,l.height=t.height;for(var c=l.getContext("2d"),d=c.getImageData(0,0,t.width,t.height),u=t.width>>2,m=t.height>>2,f=0;f<m;f++)for(var p=0;p<u;p++){for(var v=a.getUint16(n,!0),_=v>>14&3,g=o+4*(16383&v),T=4*p+f*u*16,b=0;b<4;b++){for(var y=s.getUint8(i++),M=0;M<4;M++){var A,w=y>>2*M&3;switch(_){case 0:A=3==w?h:this._readPalColour(r,g,w,!1);break;case 1:A=3==w?h:2==w?this._readFractionalPal(r,g,.5):this._readPalColour(r,g,w,!1);break;case 2:A=this._readPalColour(r,g,w,!1);break;case 3:A=3==w?this._readFractionalPal(r,g,3/8):2==w?this._readFractionalPal(r,g,5/8):this._readPalColour(r,g,w,!1)}d.data.set(A,4*T++)}T+=t.width-4}n+=2}return c.putImageData(d,0,0),l},t.prototype._readPalColour=function(t,e,i,s){var a=t.getUint16(e+2*i,!0),r=255/31;return this.colourBuffer[0]=Math.round((31&a)*r),this.colourBuffer[1]=Math.round((a>>5&31)*r),this.colourBuffer[2]=Math.round((a>>10&31)*r),this.colourBuffer[3]=s&&0==i?0:255,this.colourBuffer},t.prototype._readFractionalPal=function(t,e,i){var s=t.getUint16(e,!0),a=t.getUint16(e+2,!0),r=1-i,n=255/31;return this.colourBuffer[0]=Math.round((31&s)*n*i+(31&a)*n*r),this.colourBuffer[1]=Math.round((s>>5&31)*n*i+(a>>5&31)*n*r),this.colourBuffer[2]=Math.round((s>>10&31)*n*i+(a>>10&31)*n*r),this.colourBuffer[3]=255,this.colourBuffer},t.prototype._palInfoHandler=function(t,e){return{palOffset:t.getUint16(e,!0)<<3,unknown:t.getUint16(e+2,!0),nextoff:e+4}},t.prototype._texInfoHandler=function(t,e){var i=t.getUint16(e,!0)<<3,s=t.getUint16(e+2,!0);return{texOffset:i,pal0trans:!!(s>>13&1),format:s>>10&7,height:8<<(s>>7&7),width:8<<(s>>4&7),repeatX:1&s,repeatY:s>>1&1,flipX:s>>2&1,flipY:s>>3&1,unkWidth:t.getUint8(e+4),unk1:t.getUint8(e+5),unkHeight:t.getUint8(e+6),unk2:t.getUint8(e+7),nextoff:e+8}},t}(),f=function(){function t(t){this._input=t,this._mainOff=void 0,this.modelData=void 0,this._texPalOff=void 0,this._materials=void 0,null!=this._input&&this.load(this._input)}return t.prototype.load=function(t){var s=this;this.hasBillboards=!1;var a,r,n,o=new DataView(t);if("BMD0"!=(a=i.readHeader(o)).stamp)throw"NSBMD invalid. Expected BMD0, found "+a.stamp;if(a.numSections>2)throw"NSBMD invalid. Too many sections - should have 2 maximum.";2==a.numSections&&(n=new m(t.slice(a.sectionOffsets[1]),!0)),r=a.sectionOffsets[0],this._mainOff=r;var h=e.asciireadChar(o,r+0)+e.asciireadChar(o,r+1)+e.asciireadChar(o,r+2)+e.asciireadChar(o,r+3);if("MDL0"!=h)throw"NSBMD invalid. Expected MDL0, found "+h;this.tex=n,this.modelData=i.read3dInfo(o,this._mainOff+8,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return s._modelInfoHandler(t[0],t[1])}))},t.prototype._modelInfoHandler=function(t,e){var s=this,a=t.getUint32(e,!0),r=this._mainOff+a,n=e+4,o=this._parseHeadModelData(t,r);this._texPalOff=o.materialsOffset;var h=i.read3dInfo(t,r+64,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return s._objInfoHandler(t[0],t[1],t[2])})),l=i.read3dInfo(t,o.polyStartOffset,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return s._polyInfoHandler(t[0],t[1],t[2])}));this._materials=i.read3dInfo(t,o.materialsOffset+4,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return s._matInfoHandler(t[0],t[1],t[2])}));for(var c=i.read3dInfo(t,o.materialsOffset+t.getUint16(o.materialsOffset,!0),(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return s._texInfoHandler(t[0],t[1],t[2],t[3])})),d=i.read3dInfo(t,o.materialsOffset+t.getUint16(o.materialsOffset+2,!0),(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return s._palInfoHandler(t[0],t[1],t[2],t[3])})),u=0;u<this._materials.objectData.length;u++){var m=this._materials.objectData[u],f=c.names[m.tex],p=d.names[m.pal];m.texName=f,m.palName=p}var v=this._parseBones(o.bonesOffset,t,l,h,o.maxStack);return{head:o,objects:h,polys:l,materials:this._materials,tex:c,palt:d,commands:v,nextoff:n,lastStackID:void 0}},t.prototype._parseHeadModelData=function(t,e){return{blockSize:t.getUint32(e,!0),bonesOffset:e+t.getUint32(e+4,!0),materialsOffset:e+t.getUint32(e+8,!0),polyStartOffset:e+t.getUint32(e+12,!0),polyEndOffset:e+t.getUint32(e+16,!0),numObjects:t.getUint8(e+23),numMaterials:t.getUint8(e+24),numPolys:t.getUint8(e+25),maxStack:t.getUint8(e+26),scale:t.getInt32(e+28,!0)/4096,downScale:t.getInt32(e+32,!0)/4096,numVerts:t.getUint16(e+36,!0),numSurfaces:t.getUint16(e+38,!0),numTriangles:t.getUint16(e+40,!0),numQuads:t.getUint16(e+42,!0),bboxX:t.getInt16(e+44,!0)/4096,bboxY:t.getInt16(e+46,!0)/4096,bboxZ:t.getInt16(e+48,!0)/4096,bboxWidth:t.getInt16(e+50,!0)/4096,bboxHeight:t.getInt16(e+52,!0)/4096,bboxDepth:t.getInt16(e+54,!0)/4096}},t.prototype._parseBones=function(t,e,i,s,a){for(var r,n=[],o=a,h=null,l=null,c=[];t<this._texPalOff;)switch(r=e.getUint8(t++)){case 6:var d=e.getUint8(t++),u=e.getUint8(t++);e.getUint8(t++),s.objectData[d].parent=u,n.push({obj:d,parent:u,stackID:o++});break;case 38:case 70:case 102:d=e.getUint8(t++),u=e.getUint8(t++),e.getUint8(t++);var m=e.getUint8(t++),f=null;102==r&&(f=e.getUint8(t++)),70==r&&(f=m,m=o++),s.objectData[d].parent=u;var p={obj:d,parent:u,stackID:m,restoreID:f};if(c[m]){console.log("!! Already bound !! Moving old matrix at "+m+" to "+o);for(var v=i.objectData,_=0;_<v.length;_++)v[_].stackID==m&&(v[_].stackID=o);n.push({copy:m,dest:o++})}n.push(p);break;case 4:case 36:case 68:var g=e.getUint8(t++);l=g,e.getUint8(t++);var T=e.getUint8(t++);c[M=null==h?n[n.length-1].stackID:h]=!0,i.objectData[T].stackID=M,i.objectData[T].mat=g;break;case 1:break;case 2:var b=e.getUint8(t++),y=e.getUint8(t++);s.objectData[b].vis=y;break;case 3:h=e.getUint8(t++);case 0:break;case 5:var M;T=e.getUint8(t++),c[M=null==h?n[n.length-1].stackID:h]=!0,i.objectData[T].stackID=M,i.objectData[T].mat=l;break;case 7:d=e.getUint8(t++),s.objectData[d].billboardMode=1,this.hasBillboards=!0;break;case 8:d=e.getUint8(t++),s.objectData[d].billboardMode=2,this.hasBillboards=!0;break;case 9:case 11:case 43:break;default:console.log("bone transform unknown: 0x"+r.toString(16))}return n},t.prototype._matInfoHandler=function(t,e,i){var s,a=this._texPalOff+t.getUint32(e,!0),r=t.getUint16(a+12,!0),n=t.getUint16(a+22,!0);switch(a+=44,n>>14&3){case 0:s=mat3.create();break;case 1:s=mat3.create(),mat3.scale(s,s,[t.getInt32(a,!0)/4096,t.getInt32(a+4,!0)/4096]);break;case 2:case 3:s=mat3.create(),alert("custom");for(var o=0;o<16;o++)s[o]=t.getInt32(a,!0)/4096,a+=4}var h=(r>>16&31)/31;return 0==h&&(h=1),{height:8<<(n>>7&7),width:8<<(n>>4&7),repeatX:1&n,repeatY:n>>1&1,flipX:n>>2&1,flipY:n>>3&1,texMat:s,alpha:h,cullMode:r>>6&3,texName:void 0,tex:void 0,palName:void 0,pal:void 0,texInd:void 0,nextoff:e+4}},t.prototype._texInfoHandler=function(t,e,i,s){for(var a=this._texPalOff+t.getUint16(e,!0),r=t.getUint8(e+2),n=[],o=0;o<r;o++){var h=t.getUint8(a++);this._materials.objectData[h].tex=s,n.push(h)}return{mats:n,nextoff:e+4}},t.prototype._palInfoHandler=function(t,e,i,s){for(var a=this._texPalOff+t.getUint16(e,!0),r=t.getUint8(e+2),n=[],o=0;o<r;o++){var h=t.getUint8(a++);this._materials.objectData[h].pal=s,n.push(h)}return{mats:n,nextoff:e+4}},t.prototype._polyInfoHandler=function(t,e,i){var s=i+t.getUint32(e,!0),a=s+t.getUint32(s+8,!0);return{stackID:void 0,mat:void 0,nextoff:e+4,disp:t.buffer.slice(a,a+t.getUint32(s+12,!0))}},t.prototype._objInfoHandler=function(t,e,i){var s,a,r,n,o,h=i+t.getUint32(e,!0),l=t.getUint16(h,!0),c=t.getInt16(h+2,!0)/4096,d=vec3.create();if(1&l||(d[0]=t.getInt32(h+4,!0)/4096,d[1]=t.getInt32(h+8,!0)/4096,d[2]=t.getInt32(h+12,!0)/4096,h+=12),8&l){s=new Float32Array([0,0,0,0,0,0,0,0,0]),o=l>>4&15,n=l>>8&15,a=t.getInt16(h+4,!0)/4096,r=t.getInt16(h+6,!0)/4096,s[o]=1&n?-1:1;var u=o%3,m=Math.floor(o/3),f=0==u?1:0,p=3*(0==m?1:0),v=2==u?1:2,_=3*(2==m?1:2);s[f+p]=a,s[v+p]=r,s[f+_]=2&n?-r:r,s[v+_]=4&n?-a:a,h+=4}else s=mat3.create();var g=vec3.create();4&l?(g[0]=1,g[1]=1,g[2]=1):(g[0]=t.getInt32(h+4,!0)/4096,g[1]=t.getInt32(h+8,!0)/4096,g[2]=t.getInt32(h+12,!0)/4096,h+=12),8&l||2&l||(s[0]=c,s[1]=t.getInt16(h+4,!0)/4096,s[2]=t.getInt16(h+6,!0)/4096,s[3]=t.getInt16(h+8,!0)/4096,s[4]=t.getInt16(h+10,!0)/4096,s[5]=t.getInt16(h+12,!0)/4096,s[6]=t.getInt16(h+14,!0)/4096,s[7]=t.getInt16(h+16,!0)/4096,s[8]=t.getInt16(h+18,!0)/4096,h+=16);var T=mat4.create();return mat4.translate(T,T,d),mat4.multiply(T,T,this._mat4FromMat3(s)),mat4.scale(T,T,g),{parent:void 0,vis:void 0,translate:d,pivot:s,pA:a,pB:r,pMode:o,pNeg:n,scale:g,flag:l,mat:T,billboardMode:0,nextoff:e+4}},t.prototype._mat4FromMat3=function(t){var e=mat4.create();return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t}(),p=function(){function t(t){this.input=t,this.colourBuffer=new Uint32Array(4),null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var i=new DataView(t),s=0,a=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3);if(" APS"!=a)throw"SPA invalid. Expected 'APS', found "+a;s+=4;var r=e.asciireadChar(i,s)+e.asciireadChar(i,s+1)+e.asciireadChar(i,s+2)+e.asciireadChar(i,s+3);s+=4;var n=i.getUint16(s,!0),o=i.getUint16(s+2,!0),h=(i.getUint32(s+4,!0),i.getUint32(s+8,!0),i.getUint32(s+12,!0),i.getUint32(s+16,!0));if(i.getUint32(s+20,!0),s+=24,"12_1"==r){this.particles=[];for(var l=0;l<n;l++)this.particles[l]=this._readParticle(i,s),this.particles[l].parent=this,s=this.particles[l].nextOff}for(s=h,this.particleTextures=[],l=0;l<o;l++)this.particleTextures[l]=this._readParticleTexture(i,s),s=this.particleTextures[l].nextOff;if(window.debugParticle)for(l=0;l<n;l++){var c=document.createElement("textarea"),d=this.particles[l];d.parent=null,c.value=JSON.stringify(d),d.parent=this,c.style.width="500px",c.style.height="200px";var u=this.particleTextures[d.textureId];if(d.texAnim&&(u=this.particleTextures[d.texAnim.textures[0]]),null!=u){var m=this._readTexWithPal(u.info,u);document.body.appendChild(document.createElement("br")),document.body.appendChild(document.createTextNode(l+":")),document.body.appendChild(m),document.body.appendChild(c)}}},t.prototype.getTexture=function(t,e){var i=this.particleTextures[t];if(null==i)return null;if(null==i.glTex){var s=this._readTexWithPal(i.info,i),a=i.info;if(a.flipX||a.flipY){var r=document.createElement("canvas"),n=r.getContext("2d");r.width=a.flipX?2*s.width:s.width,r.height=a.flipY?2*s.height:s.height,n.drawImage(s,0,0),n.save(),a.flipX&&(n.translate(2*s.width,0),n.scale(-1,1),n.drawImage(s,0,0),n.restore(),n.save()),a.flipY&&(n.translate(0,2*s.height),n.scale(1,-1),n.drawImage(r,0,0),n.restore()),(o=this._loadTex(r,e,!a.repeatX,!a.repeatY)).realWidth=s.width,o.realHeight=s.height,i.glTex=o}else{var o;(o=this._loadTex(s,e,!a.repeatX,!a.repeatY)).realWidth=s.width,o.realHeight=s.height,i.glTex=o}}return i.glTex},t.prototype._loadTex=function(t,e,i,s){var a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),i&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),s&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a.width=t.width,a.height=t.height,e.bindTexture(e.TEXTURE_2D,null),a},t.prototype._readParticle=function(t,e){var i={Type0:0,Type1:16,Type2:32,Type3:48,Type4:64,Type5:128,ScaleAnim:256,ColorAnimation:512,OpacityAnimation:1024,TextureAnimation:2048,Unknown:4096,RandomDirection:8192,CrashGame:16384,AttachedToEmitter:32768,Bit16:65536,Bit21:2097152,Bit22:4194304,Bit23:8388608,Gravity:16777216,Bit25:33554432,Bit26:67108864,Bit27:134217728,Bit28:268435456,Bit29:536870912},s=t.getUint32(e,!0),a=vec3.clone([t.getInt32(e+4,!0)/4096,t.getInt32(e+8,!0)/4096,t.getInt32(e+12,!0)/4096]),r=t.getInt32(e+16,!0)/4096,n=t.getInt32(e+20,!0)/4096,o=t.getInt32(e+24,!0)/4096,h=vec3.clone([t.getInt16(e+28,!0)/4096,t.getInt16(e+30,!0)/4096,t.getInt16(e+32,!0)/4096]),l=t.getUint16(e+34,!0),c=t.getUint32(e+36,!0)/4096,d=t.getUint32(e+40,!0)/4096,u=t.getUint32(e+44,!0)/4096,m=t.getUint16(e+48,!0)/4096,f=t.getUint16(e+50,!0),p=t.getInt16(e+52,!0),v=t.getInt16(e+54,!0),_=t.getInt16(e+56,!0)/32768,g=t.getInt16(e+58,!0)/32768,T=t.getUint16(e+60,!0),b=t.getUint16(e+62,!0),y=t.getUint8(e+64),M=t.getUint8(e+66),A=t.getUint8(e+68),w=t.getUint8(e+70),S=t.getUint8(e+68),R=t.getUint8(e+69),I=t.getUint8(e+70),C=t.getUint8(e+71),x=t.getUint32(e+72,!0),D=t.getUint32(e+76,!0),P=t.getInt16(e+80,!0)/4096,U=t.getInt16(e+82,!0)/4096,k=t.getUint32(e+84,!0);e+=88;var E=void 0;0!=(s&i.ScaleAnim)&&(E={unkBase:t.getUint16(e,!0)/4096,scaleFrom:t.getUint16(e+2,!0)/4096,scaleTo:t.getUint16(e+4,!0)/4096,fromZeroTime:t.getUint8(e+6)/255,holdTime:t.getUint8(e+7)/255,flagParam:t.getUint16(e+8,!0),unk4b:t.getUint16(e+10,!0)},e+=12);var F=void 0;0!=(s&i.ColorAnimation)&&(F={colorFrom:t.getUint16(e,!0),colorTo:t.getUint16(e+2,!0),framePct:t.getUint16(e+4,!0),unknown:t.getUint16(e+6,!0),flags:t.getUint32(e+8,!0)},e+=12);var N=void 0;0!=(s&i.OpacityAnimation)&&(N={intensity:t.getUint16(e,!0),random:t.getUint8(e+2),unk:t.getUint8(e+3),startFade:t.getUint16(e+4,!0),param:t.getUint16(e+6,!0)},e+=8);var O=void 0;if(0!=(s&i.TextureAnimation)){for(var B=[],L=0;L<8;L++)B[L]=t.getUint8(e+L);O={textures:B,frames:t.getUint8(e+8),unknown1:t.getUint8(e+9),unknown2:t.getUint16(e+10,!0)},e+=12}var V=void 0;if(0!=(s&i.Bit16)){for(V=[],L=0;L<20;L++)V[L]=t.getUint8(e+L);e+=20}var j=void 0;0!=(s&i.Gravity)&&(j=[t.getInt16(e,!0)/4096,t.getInt16(e+2,!0)/4096,t.getInt16(e+4,!0)/4096,t.getInt16(e+6,!0)/4096],e+=8);var H=void 0;if(0!=(s&i.Bit25)){for(H=[],L=0;L<8;L++)H[L]=t.getUint8(e+L);e+=8}var z=void 0;if(0!=(s&i.Bit26)){for(z=[],L=0;L<16;L++)z[L]=t.getUint8(e+L);e+=16}var K=void 0;if(0!=(s&i.Bit27)){for(K=[],L=0;L<4;L++)K[L]=t.getUint8(e+L);e+=4}var W=void 0;if(0!=(s&i.Bit28)){for(W=[],L=0;L<8;L++)W[L]=t.getUint8(e+L);e+=8}var G=void 0;if(0!=(s&i.Bit29)){for(G=[],L=0;L<16;L++)G[L]=t.getUint8(e+L);e+=16}return{parent:void 0,nextOff:e,ParticleFlags:i,flag:s,position:a,particleChance:r,areaSpread:n,unknown3:o,vector:h,color:l,randomxz:c,velocity:d,size:u,aspect:m,delay:f,rotVelFrom:p,rotVelTo:v,scX:_,scY:g,emitterLifetime:T,duration:b,varScale:y,varDuration:M,varUnk1:A,varUnk2:w,frequency:S,opacity:R,yOffIntensity:I,textureId:C,unknown21:x,unknown22:D,xScaleDelta:P,yScaleDelta:U,unknown25:k,scaleAnim:E,colorAnim:F,opacityAnim:N,texAnim:O,Bit16:V,gravity:j,Bit25:H,Bit26:z,Bit27:K,Bit28:W,Bit29:G}},t.prototype._readParticleTexture=function(t,i){var s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if(" TPS"!=s)throw"SPT invalid (particle texture in SPA). Expected ' TPS', found "+s;var a=t.getUint16(i+4,!0),r={pal0trans:!0,format:7&a,height:8<<(a>>8&15),width:8<<(a>>4&15),repeatX:a>>12&1,repeatY:a>>13&1,flipX:a>>14&1,flipY:a>>15&1},n=t.getUint16(i+6,!0),o=t.getUint32(i+8,!0),h=t.getUint32(i+12,!0),l=t.getUint32(i+16,!0),c=t.getUint32(i+20,!0),d=t.getUint32(i+24,!0),u=t.getUint32(i+28,!0),m=t.buffer.slice(i+32,i+32+o);return i+=32+o,{stamp:s,info:r,flags:a,unknown:n,texDataLength:o,palOff:h,palDataLength:l,unknown2:c,unknown3:d,unknown4:u,texData:m,palData:t.buffer.slice(i,i+l),nextOff:i+l,glTex:null}},t.prototype._readTexWithPal=function(t,e){var i=t.format,s=t.pal0trans;if(5==i)return this._readCompressedTex(t);var a=0,r=new DataView(e.palData),n=new DataView(e.texData),o=document.createElement("canvas");o.width=t.width,o.height=t.height;for(var h,l=o.getContext("2d"),c=l.getImageData(0,0,t.width,t.height),d=t.width*t.height,u=0;u<d;u++){var m;if(1==i){var f=n.getUint8(a++);(m=this._readPalColour(r,0,31&f,s))[3]=255/7*(f>>5),this._premultiply(m)}else if(2==i)u%4==0&&(h=n.getUint8(a++)),m=this._readPalColour(r,0,h>>u%4*2&3,s);else if(3==i)u%2==0?(h=n.getUint8(a++),m=this._readPalColour(r,0,15&h,s)):m=this._readPalColour(r,0,h>>4,s);else if(4==i)m=this._readPalColour(r,0,n.getUint8(a++),s);else if(6==i)f=n.getUint8(a++),(m=this._readPalColour(r,0,7&f,s))[3]=255/31*(f>>3),this._premultiply(m);else{if(7!=i)return o;m=n.getUint16(a,!0),this.colourBuffer[0]=Math.round((31&m)/31*255),this.colourBuffer[1]=Math.round((m>>5&31)/31*255),this.colourBuffer[2]=Math.round((m>>10&31)/31*255),this.colourBuffer[3]=Math.round(255*(m>>15)),m=this.colourBuffer,this._premultiply(m),a+=2}c.data.set(m,4*u)}return l.putImageData(c,0,0),o},t.prototype._premultiply=function(t){t[0]*=t[3]/255,t[1]*=t[3]/255,t[2]*=t[3]/255},t.prototype._readCompressedTex=function(t){throw"compressed tex not supported for particles! (unknowns for tex data offsets and lengths?)"},t.prototype._readPalColour=function(t,e,i,s){var a=t.getUint16(e+2*i,!0),r=255/31;return this.colourBuffer[0]=Math.round((31&a)*r),this.colourBuffer[1]=Math.round((a>>5&31)*r),this.colourBuffer[2]=Math.round((a>>10&31)*r),this.colourBuffer[3]=s&&0==i?0:255,this.colourBuffer},t.prototype._readFractionalPal=function(t,e,i){var s=t.getUint16(e,!0),a=t.getUint16(e+2,!0),r=1-i,n=255/31;return this.colourBuffer[0]=Math.round((31&s)*n*i+(31&a)*n*r),this.colourBuffer[1]=Math.round((s>>5&31)*n*i+(a>>5&31)*n*r),this.colourBuffer[2]=Math.round((s>>10&31)*n*i+(a>>10&31)*n*r),this.colourBuffer[3]=255,this.colourBuffer},t}(),v=function(){function t(){}return t.compileDefaultShader=function(){var e={frag:t._defaultFrag,vert:t._defaultVert,attributes:{vertexPositionAttribute:"aVertexPosition",textureCoordAttribute:"aTextureCoord",colorAttribute:"aColor",matAttribute:"matrixID",normAttribute:"aNormal"},uniforms:{pMatrixUniform:"uPMatrix",matStackUniform:"matStack",mvMatrixUniform:"uMVMatrix",texMatrixUniform:"texMatrix",samplerUniform:"uSampler",colMultUniform:"colMult"}};return t._compileShader(e)},t.compileShadowShader=function(){var e={frag:t._shadFrag,vert:t._shadVert,attributes:{vertexPositionAttribute:"aVertexPosition",textureCoordAttribute:"aTextureCoord",colorAttribute:"aColor",matAttribute:"matrixID",normAttribute:"aNormal"},uniforms:{pMatrixUniform:"uPMatrix",matStackUniform:"matStack",mvMatrixUniform:"uMVMatrix",texMatrixUniform:"texMatrix",samplerUniform:"uSampler",colMultUniform:"colMult",shadowMatUniform:"shadowMat",farShadowMatUniform:"farShadowMat",lightIntensityUniform:"lightIntensity",shadLightenUniform:"shadLighten",lightDirUniform:"lightDir",normalFlipUniform:"normalFlip",shadOffUniform:"shadOff",farShadOffUniform:"farShadOff",lightSamplerUniform:"lightDSampler",farLightSamplerUniform:"farLightDSampler"}};return t._compileShader(e)},t._compileShader=function(e){var i=t._getShader(gl,e.frag,gl.FRAGMENT_SHADER),s=t._getShader(gl,e.vert,gl.VERTEX_SHADER),a=gl.createProgram();gl.attachShader(a,s),gl.attachShader(a,i),gl.linkProgram(a),gl.getProgramParameter(a,gl.LINK_STATUS)||alert("Could not initialise shaders");var r={program:a,attributes:{},uniforms:{}};for(var n in e.attributes)if(Object.hasOwnProperty.call(e.attributes,n)){var o=e.attributes[n],h=gl.getAttribLocation(a,o);r.attributes[n]=h,gl.enableVertexAttribArray(h)}for(var n in e.uniforms)if(Object.hasOwnProperty.call(e.uniforms,n)){var l=e.uniforms[n],c=gl.getUniformLocation(a,l);r.uniforms[n]=c}return r},t._getShader=function(t,e,i){var s=t.createShader(i);return t.shaderSource(s,e),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(alert(t.getShaderInfoLog(s)),null)},t._defaultFrag="\n\tprecision highp float;\n\t\n\tvarying vec2 vTextureCoord;\n\tvarying vec4 color;\n\t\n\tuniform sampler2D uSampler;\n\t\n\tfloat indexValue() {\n\t    int x = int(mod(gl_FragCoord.x, 4.0));\n\t    int y = int(mod(gl_FragCoord.y, 4.0));\n\t    int i = (x + y * 4);\n\t    if (i == 0) return 0.0;\n\t    else if (i == 1) return 8.0;\n\t    else if (i == 2) return 2.0;\n\t    else if (i == 3) return 10.0;\n\t    else if (i == 4) return 12.0;\n\t    else if (i == 5) return 4.0;\n\t    else if (i == 6) return 14.0;\n\t    else if (i == 7) return 6.0;\n\t    else if (i == 8) return 3.0;\n\t    else if (i == 9) return 11.0;\n\t    else if (i == 10) return 1.0;\n\t    else if (i == 11) return 9.0;\n\t    else if (i == 12) return 15.0;\n\t    else if (i == 13) return 7.0;\n\t    else if (i == 14) return 13.0;\n\t    else if (i == 15) return 5.0;\n\t}\n\t\n\tfloat dither(float color) {\n\t    float closestColor = (color < 0.5) ? 0.0 : 1.0;\n\t    float secondClosestColor = 1.0 - closestColor;\n\t    float d = indexValue();\n\t    float distance = abs(closestColor - color);\n\t    return (distance < d) ? closestColor : secondClosestColor;\n\t}\n\t\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(uSampler, vTextureCoord)*color;\n\t\tif (gl_FragColor.a < 1.0 && (gl_FragColor.a == 0.0 || dither(gl_FragColor.a) == 0.0)) discard;\n\t}\n\t",t._defaultVert="\n\tattribute vec3 aVertexPosition;\n\tattribute vec2 aTextureCoord;\n\tattribute vec4 aColor;\n\tattribute float matrixID;\n\tattribute vec3 aNormal;\n\t\n\tuniform mat4 uMVMatrix;\n\tuniform mat4 uPMatrix;\n\tuniform mat3 texMatrix;\n\tuniform mat4 matStack[16];\n\t\n\tuniform vec4 colMult;\n\t\n\tvarying vec2 vTextureCoord;\n\tvarying vec4 color;\n\t\n\t\n\tvoid main(void) {\n\t\tgl_Position = uPMatrix * uMVMatrix * matStack[int(matrixID)] * vec4(aVertexPosition, 1.0);\n\t\tvTextureCoord = (texMatrix * vec3(aTextureCoord, 1.0)).xy;\n\t\tvec3 adjNorm = normalize(vec3(uMVMatrix * matStack[int(matrixID)] * vec4(aNormal, 0.0)));\n\t\tfloat diffuse = 0.7-dot(adjNorm, vec3(0.0, -1.0, 0.0))*0.3;\n\t\t\n\t\tcolor = aColor*colMult;\n\t\tcolor = vec4(color.x*diffuse, color.y*diffuse, color.z*diffuse, color.w);\n\t}\n\t",t._shadFrag="\n\tprecision highp float;\n\t\n\tvarying vec2 vTextureCoord;\n\tvarying vec4 color;\n\tvarying vec4 lightDist;\n\tvarying vec4 fLightDist;\n\tvarying vec3 normal;\n\t\n\tuniform float shadOff; \n\tuniform float farShadOff; \n\tuniform sampler2D lightDSampler;\n\tuniform sampler2D farLightDSampler;\n\tuniform float shadLighten; \n\t\n\tuniform sampler2D uSampler;\n\tuniform vec3 lightDir;\n\t\n\tfloat shadowCompare(sampler2D map, vec2 pos, float compare, float so) {\n\t\tfloat depth = texture2D(map, pos).r;\n\t\treturn smoothstep(compare-so, compare, depth);\n\t}\n\t\n\tfloat shadowLerp(sampler2D depths, vec2 size, vec2 uv, float compare, float so){\n\t\tvec2 texelSize = vec2(1.0)/size;\n\t\tvec2 f = fract(uv*size+0.5);\n\t\tvec2 centroidUV = floor(uv*size+0.5)/size;\n\t\t\n\t\tfloat lb = shadowCompare(depths, centroidUV+texelSize*vec2(0.0, 0.0), compare, so);\n\t\tfloat lt = shadowCompare(depths, centroidUV+texelSize*vec2(0.0, 1.0), compare, so);\n\t\tfloat rb = shadowCompare(depths, centroidUV+texelSize*vec2(1.0, 0.0), compare, so);\n\t\tfloat rt = shadowCompare(depths, centroidUV+texelSize*vec2(1.0, 1.0), compare, so);\n\t\tfloat a = mix(lb, lt, f.y);\n\t\tfloat b = mix(rb, rt, f.y);\n\t\tfloat c = mix(a, b, f.x);\n\t\treturn c;\n\t}\n\t\n\tvoid main(void) {\n\t\tvec4 colorPM = vec4(color.rgb * color.a, color.a);\n\t\tvec4 col = texture2D(uSampler, vTextureCoord)*colorPM;\n\t\t\n\t\tvec2 ldNorm = abs((lightDist.xy)-vec2(0.5, 0.5));\n\t\tfloat dist = max(ldNorm.x, ldNorm.y);\n\t\tfloat shadIntensity;\n\t\t\n\t\tif (dist > 0.5) {\n\t\t\tshadIntensity = shadowLerp(farLightDSampler, vec2(4096.0, 4096.0), fLightDist.xy, fLightDist.z-farShadOff, farShadOff*0.5);\n\t\t} else if (dist > 0.4) {\n\t\t\tfloat lerp1 = shadowLerp(farLightDSampler, vec2(4096.0, 4096.0), fLightDist.xy, fLightDist.z-farShadOff, farShadOff*0.5);\n\t\t\tfloat lerp2 = shadowLerp(lightDSampler, vec2(2048.0, 2048.0), lightDist.xy, lightDist.z-shadOff, shadOff*0.5);\n\t\t\t\n\t\t\tshadIntensity = mix(lerp2, lerp1, (dist-0.4)*10.0);\n\t\t} else {\n\t\t\tshadIntensity = shadowLerp(lightDSampler, vec2(2048.0, 2048.0), lightDist.xy, lightDist.z-shadOff, shadOff*0.5);\n\t\t}\n\t\tshadIntensity = min(shadIntensity, max(0.0, dot(normalize(normal), lightDir) * 5.0));\n\t\tgl_FragColor = col*mix(vec4(0.5, 0.5, 0.7, 1.0), vec4(1.0, 1.0, 1.0, 1.0), min(1.0, shadIntensity + shadLighten));\n\t\t\n\t\tif (gl_FragColor.a == 0.0) discard;\n\t}\n\t",t._shadVert="\n\tattribute vec3 aVertexPosition;\n\tattribute vec2 aTextureCoord;\n\tattribute vec4 aColor;\n\tattribute float matrixID;\n\tattribute vec3 aNormal;\n\t\n\tuniform mat4 uMVMatrix;\n\tuniform mat4 uPMatrix;\n\tuniform mat3 texMatrix;\n\tuniform mat4 matStack[16];\n\tuniform float normalFlip;\n\t\n\tuniform vec4 colMult;\n\t\n\tuniform mat4 shadowMat;\n\tuniform mat4 farShadowMat;\n\tuniform float lightIntensity; \n\t\n\tvarying vec2 vTextureCoord;\n\tvarying vec4 color;\n\tvarying vec4 lightDist;\n\tvarying vec4 fLightDist;\n\tvarying vec3 normal;\n\t\n\t\n\tvoid main(void) {\n\t\tvec4 pos = uMVMatrix * matStack[int(matrixID)] * vec4(aVertexPosition, 1.0);\n\t\tgl_Position = uPMatrix * pos;\n\t\tvTextureCoord = (texMatrix * vec3(aTextureCoord, 1.0)).xy;\n\t\t\n\t\tlightDist = (shadowMat*pos + vec4(1, 1, 1, 0)) / 2.0;\n\t\tfLightDist = (farShadowMat*pos + vec4(1, 1, 1, 0)) / 2.0;\n\t\tvec3 adjNorm = normalize(vec3(uMVMatrix * matStack[int(matrixID)] * vec4(aNormal, 0.0))) * normalFlip;\n\t\tnormal = adjNorm; \n\t\tfloat diffuse = (1.0-lightIntensity)-dot(adjNorm, vec3(0.0, -1.0, 0.0))*lightIntensity;\n\t\t\n\t\tcolor = aColor*colMult;\n\t\tcolor = vec4(color.x*diffuse, color.y*diffuse, color.z*diffuse, color.w);\n\t}\n\t",t}(),_=function(){function t(){}return t.init=function(e){t._gl=e,t.billboardMat=mat4.create(),t.yBillboardMat=mat4.create(),t._defaultShader=v.compileDefaultShader(),t._shadowShader=v.compileShadowShader(),t.nitroShader=t._defaultShader,t.cullModes=[t._gl.FRONT_AND_BACK,t._gl.FRONT,t._gl.BACK],t._instructions[20]=function(e,i){t._curMat=e.getUint8(i)},t._instructions[32]=function(e,i){var s=e.getUint16(i,!0);t._color[0]=(31&s)/31,t._color[1]=(s>>5&31)/31,t._color[2]=(s>>10&31)/31},t._instructions[33]=function(e,i){var s=e.getUint32(i,!0);t._norm[0]=t._tenBitSign(s),t._norm[1]=t._tenBitSign(s>>10),t._norm[2]=t._tenBitSign(s>>20)},t._instructions[34]=function(e,i){t._texCoord[0]=e.getInt16(i,!0)/16/t._texWidth,t._texCoord[1]=e.getInt16(i+2,!0)/16/t._texHeight},t._instructions[35]=function(e,i){t._cVec[0]=e.getInt16(i,!0)/4096,t._cVec[1]=e.getInt16(i+2,!0)/4096,t._cVec[2]=e.getInt16(i+4,!0)/4096,t._pushVector()},t._instructions[36]=function(e,i){var s=e.getUint32(i,!0);t._cVec[0]=t._tenBitSign(s),t._cVec[1]=t._tenBitSign(s>>10),t._cVec[2]=t._tenBitSign(s>>20),t._pushVector()},t._instructions[37]=function(e,i){t._cVec[0]=e.getInt16(i,!0)/4096,t._cVec[1]=e.getInt16(i+2,!0)/4096,t._pushVector()},t._instructions[38]=function(e,i){t._cVec[0]=e.getInt16(i,!0)/4096,t._cVec[2]=e.getInt16(i+2,!0)/4096,t._pushVector()},t._instructions[39]=function(e,i){t._cVec[1]=e.getInt16(i,!0)/4096,t._cVec[2]=e.getInt16(i+2,!0)/4096,t._pushVector()},t._instructions[40]=function(e,i){var s=e.getUint32(i,!0);t._cVec[0]+=t._relativeSign(s),t._cVec[1]+=t._relativeSign(s>>10),t._cVec[2]+=t._relativeSign(s>>20),t._pushVector()},t._instructions[64]=function(e,i){var s=e.getUint32(i,!0);t._vecMode=s,t._optimiseTriangles||(t._vecPos=[],t._vecNorm=[],t._vecTx=[],t._vecCol=[],t._vecMat=[]),t._vecNum=0,t._stripAlt=0},t._instructions[65]=function(e,i){t._optimiseTriangles||t._pushStrip()}},t.prepareShader=function(){t._gl.enable(t._gl.BLEND),t._gl.blendFunc(t._gl.ONE,t._gl.ONE_MINUS_SRC_ALPHA),t.last={},t._gl.activeTexture(t._gl.TEXTURE0),t._gl.uniform1i(t.nitroShader.uniforms.samplerUniform,0)},t.setShadowMode=function(e,i,s,a,r){t.nitroShader=t._shadowShader;var n=t._shadowShader;t._gl.useProgram(n.program),vec3.normalize(r,r),t._gl.uniform3fv(n.uniforms.lightDirUniform,r),t._gl.uniformMatrix4fv(n.uniforms.shadowMatUniform,!1,s),t._gl.uniformMatrix4fv(n.uniforms.farShadowMatUniform,!1,a),t._gl.uniform1f(n.uniforms.lightIntensityUniform,.3),t.resetShadOff(),t.setNormalFlip(1),t._gl.activeTexture(t._gl.TEXTURE1),t._gl.bindTexture(t._gl.TEXTURE_2D,e),t._gl.uniform1i(n.uniforms.lightSamplerUniform,1),t._gl.activeTexture(t._gl.TEXTURE2),t._gl.bindTexture(t._gl.TEXTURE_2D,i),t._gl.uniform1i(n.uniforms.farLightSamplerUniform,2),t.setColMult([1,1,1,1]),t.prepareShader()},t.setLightIntensities=function(e,i){var s=t.nitroShader;t._gl.useProgram(t.nitroShader.program),t._gl.uniform1f(s.uniforms.lightIntensityUniform,e),t._gl.uniform1f(s.uniforms.shadLightenUniform,1-i)},t.setShadBias=function(e){var i=t.nitroShader;t._gl.useProgram(t.nitroShader.program),t._gl.uniform1f(i.uniforms.shadOffUniform,e),t._gl.uniform1f(i.uniforms.farShadOffUniform,e)},t.setNormalFlip=function(e){var i=t.nitroShader;t._gl.useProgram(t.nitroShader.program),t._gl.uniform1f(i.uniforms.normalFlipUniform,e)},t.resetShadOff=function(){var e=t.nitroShader;t._gl.useProgram(t.nitroShader.program),t._gl.uniform1f(e.uniforms.shadOffUniform,5e-4),t._gl.uniform1f(e.uniforms.farShadOffUniform,.002)},t.unsetShadowMode=function(){t.nitroShader=t._defaultShader,t._gl.useProgram(t.nitroShader.program),t.setColMult([1,1,1,1]),t.prepareShader()},t.pauseShadowMode=function(){t.nitroShader=t._defaultShader,t.nitroShader==t._shadowShader&&(t._paused=!0),t._gl.useProgram(t.nitroShader.program),t.setColMult([1,1,1,1]),t.prepareShader()},t.unpauseShadowMode=function(){t._paused&&(t.nitroShader=t._shadowShader,t._gl.useProgram(t.nitroShader.program),t.setColMult([1,1,1,1]),t.prepareShader())},t.setColMult=function(e){t._gl.useProgram(t.nitroShader.program),t._gl.uniform4fv(t.nitroShader.uniforms.colMultUniform,e)},t.updateBillboards=function(e){t.billboardID=(t.billboardID+1)%16777215;var i=mat4.clone(e);i[12]=0,i[13]=0,i[14]=0;var s=mat4.clone(i);t.billboardMat=mat4.invert(i,i),s[4]=0,s[5]=1,s[6]=0,t.yBillboardMat=mat4.invert(s,s)},t.renderDispList=function(e,i,s){t._modelBuffer={strips:[]},t._curMat=s;var a=0,r=new DataView(e);for(t._texWidth=i.width,t._texHeight=i.height,t._cVec=[],t._norm=[0,1,0],t._texCoord=[0,0],t._color=[1,1,1,t._alphaMul],t._vecMode=0,t._vecNum=0,t._stripAlt=0,t._vecPos=[],t._vecNorm=[],t._vecTx=[],t._vecCol=[],t._vecMat=[];a<e.byteLength;){var n=a;a+=4;for(var o=0;o<4;o++){var h=r.getUint8(n++);null!=t._instructions[h]?t._instructions[h](r,a):0!=h&&alert("invalid instruction 0x"+h.toString(16));var l=t._parameters[h];a+=null==l?0:4*l}}return t._optimiseTriangles&&t._pushStrip(),t._modelBuffer},t.setAlpha=function(e){t._alphaMul=e},t.getViewWidth=function(){return t._gl.viewportWidth},t.getViewHeight=function(){return t._gl.viewportHeight},t._pushStrip=function(){var e=t._optimiseTriangles?[t._gl.TRIANGLES,t._gl.TRIANGLES,t._gl.TRIANGLES,t._gl.TRIANGLES]:[t._gl.TRIANGLES,t._gl.TRIANGLES,t._gl.TRIANGLE_STRIP,t._gl.TRIANGLE_STRIP],i=t._gl.createBuffer(),s=t._gl.createBuffer(),a=t._gl.createBuffer(),r=t._gl.createBuffer(),n=t._gl.createBuffer(),o=new Float32Array(t._vecPos);if(t.forceFlatNormals&&e[t._vecMode]==t._gl.TRIANGLES)for(var h=0;h<t._vecPos.length;h+=9){var l=[t._vecPos[h],t._vecPos[h+1],t._vecPos[h+2]],c=[t._vecPos[h+3],t._vecPos[h+4],t._vecPos[h+5]],d=[t._vecPos[h+6],t._vecPos[h+7],t._vecPos[h+8]];vec3.sub(c,c,l),vec3.sub(d,d,l);var u=vec3.cross([0,0,0],c,d);vec3.normalize(u,u);for(var m=0;m<3;m++)for(var f=0;f<3;f++)t._vecNorm[h+3*m+f]=u[f]}t._gl.bindBuffer(t._gl.ARRAY_BUFFER,i),t._gl.bufferData(t._gl.ARRAY_BUFFER,o,t._gl.STATIC_DRAW),t._gl.bindBuffer(t._gl.ARRAY_BUFFER,a),t._gl.bufferData(t._gl.ARRAY_BUFFER,new Float32Array(t._vecTx),t._gl.STATIC_DRAW),t._gl.bindBuffer(t._gl.ARRAY_BUFFER,s),t._gl.bufferData(t._gl.ARRAY_BUFFER,new Float32Array(t._vecCol),t._gl.STATIC_DRAW),t._gl.bindBuffer(t._gl.ARRAY_BUFFER,r),t._gl.bufferData(t._gl.ARRAY_BUFFER,new Float32Array(t._vecMat),t._gl.STATIC_DRAW),t._gl.bindBuffer(t._gl.ARRAY_BUFFER,n),t._gl.bufferData(t._gl.ARRAY_BUFFER,new Float32Array(t._vecNorm),t._gl.STATIC_DRAW),t._modelBuffer.strips.push({posArray:o,vPos:i,vTx:a,vCol:s,vMat:r,vNorm:n,verts:t._vecPos.length/3,mode:e[t._vecMode]})},t._pushVector=function(){if(1==t._vecMode&&t._vecNum%4==3&&(t._vecPos=t._vecPos.concat(t._vecPos.slice(t._vecPos.length-9,t._vecPos.length-6)).concat(t._vecPos.slice(t._vecPos.length-3)),t._vecNorm=t._vecNorm.concat(t._vecNorm.slice(t._vecNorm.length-9,t._vecNorm.length-6)).concat(t._vecNorm.slice(t._vecNorm.length-3)),t._vecTx=t._vecTx.concat(t._vecTx.slice(t._vecTx.length-6,t._vecTx.length-4)).concat(t._vecTx.slice(t._vecTx.length-2)),t._vecCol=t._vecCol.concat(t._vecCol.slice(t._vecCol.length-12,t._vecCol.length-8)).concat(t._vecCol.slice(t._vecCol.length-4)),t._vecMat=t._vecMat.concat(t._vecMat.slice(t._vecMat.length-3,t._vecMat.length-2)).concat(t._vecMat.slice(t._vecMat.length-1))),t._optimiseTriangles&&t._vecMode>1&&t._vecNum>2){var e=t._vecMat.length-(t._stripAlt%2==0?1:3),i=t._vecMat.length-(t._stripAlt%2==0?2:1);t._vecPos=t._vecPos.concat(t._vecPos.slice(3*e,3*e+3)).concat(t._vecPos.slice(3*i,3*i+3)),t._vecNorm=t._vecNorm.concat(t._vecNorm.slice(3*e,3*e+3)).concat(t._vecNorm.slice(3*i,3*i+3)),t._vecTx=t._vecTx.concat(t._vecTx.slice(2*e,2*e+2)).concat(t._vecTx.slice(2*i,2*i+2)),t._vecCol=t._vecCol.concat(t._vecCol.slice(4*e,4*e+4)).concat(t._vecCol.slice(4*i,4*i+4)),t._vecMat=t._vecMat.concat(t._vecMat.slice(e,e+1)).concat(t._vecMat.slice(i,i+1)),t._stripAlt++}t._vecNum++,t._vecPos=t._vecPos.concat(t._cVec),t._vecTx=t._vecTx.concat(t._texCoord),t._vecCol=t._vecCol.concat(t._color),t._vecNorm=t._vecNorm.concat(t._norm),t._vecMat.push(t._curMat)},t._tenBitSign=function(t){return 512&(t&=1023)?(t-1024)/64:t/64},t._relativeSign=function(t){return 512&(t&=1023)?(t-1024)/4096:t/4096},t.cullModes=[],t.billboardID=0,t.lastMatStack=null,t.last={},t.flagShadow=!1,t.forceFlatNormals=!1,t._cVec=void 0,t._color=void 0,t._texCoord=void 0,t._norm=void 0,t._vecMode=void 0,t._vecPos=void 0,t._vecNorm=void 0,t._vecTx=void 0,t._vecCol=void 0,t._vecNum=void 0,t._vecMat=void 0,t._curMat=void 0,t._stripAlt=void 0,t._texWidth=void 0,t._texHeight=void 0,t._modelBuffer=void 0,t._instructions={},t._alphaMul=1,t._optimiseTriangles=!0,t._paused=!1,t._parameters={0:0,16:1,17:0,18:1,19:1,20:1,21:0,22:16,23:12,24:16,25:12,26:9,27:3,28:3,32:1,33:1,34:1,35:2,36:1,37:1,38:1,39:1,40:1,41:1,42:1,43:1,48:1,49:1,50:1,51:1,52:32,64:1,65:0,80:1,96:1,112:3,113:2,114:1},t}(),g=function(){function t(t,e,i){this.btx=e,this.bmd=t,this._loadedTex=void 0,this._texCanvas=void 0,this._tex=void 0,this._texAnim=void 0,this._texPAnim=void 0,this._texFrame=void 0,this._collisionModel=[],this._matBufEmpty=new Float32Array(496),this._temp=mat4.create(),this._off=0;for(var s=0;s<31;s++)this._matBufEmpty.set(this._temp,this._off),this._off+=16;for(this._temp=null,this._texMap=i||{tex:{},pal:{}},this.baseMat=mat4.create(),this._modelBuffers=[],this._matBuf=[],s=0;s<this.bmd.modelData.objectData.length;s++)this._modelBuffers.push(new Array(this.bmd.modelData.objectData[s].polys.objectData.length)),this._matBuf.push({built:!1,dat:new Float32Array(496)});null!=this.btx?this._loadTexture(this.btx):null!=this.bmd.tex?this._loadTexture(this.bmd.tex):this._loadWhiteTex()}return t.prototype.loadTexAnim=function(t){this._texAnim=t,this._texFrame=0},t.prototype.loadTexPAnim=function(t){this._texPAnim=t},t.prototype.setFrame=function(t){this._texFrame=t},t.prototype.setBaseMat=function(t){this.baseMat=t,this.billboardID=-1},t.prototype.draw=function(t,e,i){for(var s=this.bmd.modelData.objectData,a=0;a<s.length;a++)this._drawModel(s[a],t,e,a,i)},t.prototype.drawPoly=function(t,e,i,s,a){var r=this.bmd.modelData.objectData[i],n=r.polys.objectData;null==a&&(a=this._matBuf[i],(this.billboardID!=_.billboardID&&this.bmd.hasBillboards||!a.built)&&(_.lastMatStack=null,this._generateMatrixStack(r,a.dat),a.built=!0,this.billboardID=_.billboardID));var o=_.nitroShader;gl.uniformMatrix4fv(o.uniforms.mvMatrixUniform,!1,t),gl.uniformMatrix4fv(o.uniforms.pMatrixUniform,!1,e),a!=_.lastMatStack&&(gl.uniformMatrix4fv(o.uniforms.matStackUniform,!1,a.dat),_.lastMatStack=a),this._drawPoly(n[s],i,s)},t.prototype.drawModel=function(t,e,i){var s=this.bmd.modelData.objectData;this._drawModel(s[i],t,e,i)},t.prototype.getBoundingCollisionModel=function(t,e){var i=this.bmd.modelData.objectData[t],s=i.polys.objectData[e];null==this._modelBuffers[t][e]&&(this._modelBuffers[t][e]=_.renderDispList(s.disp,this._tex[s.mat],null==s.stackID?i.lastStackID:s.stackID));for(var a=this._modelBuffers[t][e].strips[0].posArray,r=a.length/3,n=0,o=[1/0,1/0,1/0],h=[-1/0,-1/0,-1/0],l=0;l<r;l++)for(var c=[a[n++],a[n++],a[n++]],d=0;d<3;d++)c[d]<o[d]&&(o[d]=c[d]),c[d]>h[d]&&(h[d]=c[d]);var u=[{Vertices:[[h[0],h[1],h[2]],[h[0],h[1],o[2]],[o[0],h[1],o[2]]],Normal:[0,1,0]},{Vertices:[[o[0],h[1],o[2]],[o[0],h[1],h[2]],[h[0],h[1],h[2]]],Normal:[0,1,0]},{Vertices:[[o[0],o[1],o[2]],[h[0],o[1],o[2]],[h[0],o[1],h[2]]],Normal:[0,-1,0]},{Vertices:[[h[0],o[1],h[2]],[o[0],o[1],h[2]],[o[0],o[1],o[2]]],Normal:[0,-1,0]},{Vertices:[[h[0],h[1],h[2]],[h[0],o[1],h[2]],[o[0],o[1],h[2]]],Normal:[0,0,1]},{Vertices:[[o[0],o[1],h[2]],[o[0],h[1],h[2]],[h[0],h[1],h[2]]],Normal:[0,0,1]},{Vertices:[[o[0],o[1],o[2]],[h[0],o[1],o[2]],[h[0],h[1],o[2]]],Normal:[0,0,-1]},{Vertices:[[h[0],h[1],o[2]],[o[0],h[1],o[2]],[o[0],o[1],o[2]]],Normal:[0,0,-1]},{Vertices:[[h[0],h[1],h[2]],[h[0],o[1],h[2]],[h[0],o[1],o[2]]],Normal:[1,0,0]},{Vertices:[[h[0],o[1],o[2]],[h[0],h[1],o[2]],[h[0],h[1],h[2]]],Normal:[1,0,0]},{Vertices:[[-h[0],o[1],o[2]],[-h[0],o[1],h[2]],[-h[0],h[1],h[2]]],Normal:[-1,0,0]},{Vertices:[[-h[0],h[1],h[2]],[-h[0],h[1],o[2]],[-h[0],o[1],o[2]]],Normal:[-1,0,0]}];return u.push(),{dat:u,scale:i.head.scale}},t.prototype.getCollisionModel=function(t,e,i){if(null==this._collisionModel[t]&&(this._collisionModel[t]=[]),null!=this._collisionModel[t][e])return this._collisionModel[t][e];var s=this.bmd.modelData.objectData[t],a=s.polys.objectData[e];null==this._modelBuffers[t][e]&&(this._modelBuffers[t][e]=_.renderDispList(a.disp,this._tex[a.mat],null==a.stackID?s.lastStackID:a.stackID));for(var r=this._modelBuffers[t][e].strips[0].posArray,n=[],o=r.length/9,h=0,l=0;l<o;l++){var c=[];c[0]=[r[h++],r[h++],r[h++]],c[1]=[r[h++],r[h++],r[h++]],c[2]=[r[h++],r[h++],r[h++]];var d=vec3.sub([0,0,0],c[1],c[0]),u=vec3.sub([0,0,0],c[2],c[0]);n.push({Normal:vec3.cross([0,0,0],d,u),CollisionType:i,Vertices:c})}return this._collisionModel[t][e]={dat:n,scale:s.head.scale},this._collisionModel[t][e]},t.prototype._loadWhiteTex=function(e){this._loadedTex=e,this._texCanvas=[],this._tex=[];for(var i=this.bmd.modelData.objectData,s=0;s<i.length;s++)for(var a=i[s].materials.objectData,r=0;r<a.length;r++){var n=a[r],o=document.createElement("canvas");o.width=2,o.height=2;var h=o.getContext("2d");h.fillStyle="black",h.globalAlpha=.33,h.fillRect(0,0,2,2),this._texCanvas.push(o);var l=t._loadTex(o,gl,!n.repeatX,!n.repeatY);l.realWidth=2,l.realHeight=2,this._tex.push(l)}},t.prototype._loadTexture=function(t){this._loadedTex=t,this._texCanvas=[],this._tex=[];for(var e=this.bmd.modelData.objectData,i=0;i<e.length;i++)for(var s=e[i].materials.objectData,a=0;a<s.length;a++)s[a].texInd=this._tex.length,this._loadMatTex(s[a],t)},t.prototype._loadMatTex=function(t,e,i){var s=t;i&&(s=i);var a=s.texName,r=s.palName;if(null!=a&&null!=r){var n=this._loadedTex.textureInfoNameToIndex["$"+a]||0,o=this._loadedTex.paletteInfoNameToIndex["$"+r]||0,h=n+":"+o;e.cache[h],this._tex[t.texInd]=this._cacheTex(e,n,o,t)}else console.warn("WARNING: material "+s+" in model could not be assigned a texture.")},t.prototype._cacheTex=function(e,i,s,a){var r=i+":"+s,n=e.cache[r];if(null==n){var o=e.readTexWithPal(i,s);if(a.flipX||a.flipY){var h=document.createElement("canvas"),l=h.getContext("2d");h.width=a.flipX?2*o.width:o.width,h.height=a.flipY?2*o.height:o.height,l.drawImage(o,0,0),l.save(),a.flipX&&(l.translate(2*o.width,0),l.scale(-1,1),l.drawImage(o,0,0),l.restore(),l.save()),a.flipY&&(l.translate(0,2*o.height),l.scale(1,-1),l.drawImage(h,0,0),l.restore()),this._texCanvas.push(h);var c=t._loadTex(h,gl,!a.repeatX,!a.repeatY);return c.realWidth=o.width,c.realHeight=o.height,e.cache[r]=c,c}this._texCanvas.push(o);var d=t._loadTex(o,gl,!a.repeatX,!a.repeatY);return d.realWidth=o.width,d.realHeight=o.height,e.cache[r]=d,d}return n},t.prototype._drawModel=function(t,e,i,s,a){var r=t.polys.objectData;null==a&&(a=this._matBuf[s],(this.billboardID!=_.billboardID&&this.bmd.hasBillboards||!a.built)&&(_.lastMatStack=null,this._generateMatrixStack(t,a.dat),a.built=!0,this.billboardID=_.billboardID));var n=_.nitroShader;gl.uniformMatrix4fv(n.uniforms.mvMatrixUniform,!1,e),gl.uniformMatrix4fv(n.uniforms.pMatrixUniform,!1,i),a!=_.lastMatStack&&(gl.uniformMatrix4fv(n.uniforms.matStackUniform,!1,a.dat),_.lastMatStack=a);for(var o=0;o<r.length;o++)this._drawPoly(r[o],s,o)},t.prototype._drawPoly=function(t,e,i){var s=_.nitroShader,a=this.bmd.modelData.objectData[e],r=t.mat,n=a.materials.names[r];if(null!=this._texPAnim){var o=this._texPAnim.animData.objectData[e],h=this._texPAnim.animData.objectData[e].data;if(-1!=(v=h.names.indexOf(n)))for(var l=this._texFrame%o.duration,c=h.objectData[v],d=c.frames.length-1;d>=0;d--)if(l>=c.frames[d].time){var u=null==this.btx?this.bmd.tex:this.btx,m=c.frames[d],f=a.materials.objectData[r];this._loadMatTex(f,u,m);break}}_.last.tex!=this._tex[r]&&(gl.bindTexture(gl.TEXTURE_2D,this._tex[r]),_.last.tex=this._tex[r]);var p=a.materials.objectData[r];if(_.setAlpha(p.alpha),null!=this._texAnim){n=a.materials.names[r];var v,g=this._texAnim.animData.objectData[e].data;if(-1!=(v=g.names.indexOf(n))){var T=g.objectData[v],b=this._matAtFrame(this._texFrame,T);gl.uniformMatrix3fv(s.uniforms.texMatrixUniform,!1,b)}else gl.uniformMatrix3fv(s.uniforms.texMatrixUniform,!1,p.texMat)}else gl.uniformMatrix3fv(s.uniforms.texMatrixUniform,!1,p.texMat);if(null==this._modelBuffers[e][i]&&(this._modelBuffers[e][i]=_.renderDispList(t.disp,this._tex[t.mat],null==t.stackID?a.lastStackID:t.stackID)),p.cullMode<3)gl.enable(gl.CULL_FACE),gl.cullFace(_.cullModes[p.cullMode]);else{if(_.forceFlatNormals)return gl.enable(gl.CULL_FACE),gl.cullFace(gl.BACK),this._drawModelBuffer(this._modelBuffers[e][i],gl,s),_.setNormalFlip(-1),gl.cullFace(gl.FRONT),this._drawModelBuffer(this._modelBuffers[e][i],gl,s),void _.setNormalFlip(1);gl.disable(gl.CULL_FACE)}this._drawModelBuffer(this._modelBuffers[e][i],gl,s)},t.prototype._frameLerp=function(t,e,i){if(1==i.length)return i[0];var s=t/(1<<e)%1,a=i.length;e>0&&(a-=1);var r=(t>>e)%a,n=i[r];return(i[r+1]||i[r])*s+n*(1-s)},t.prototype._matAtFrame=function(t,e){var i=mat3.create();return mat3.scale(i,i,[this._frameLerp(t,e.frameStep.scaleS,e.scaleS),this._frameLerp(t,e.frameStep.scaleT,e.scaleT)]),mat3.translate(i,i,[-this._frameLerp(t,e.frameStep.translateS,e.translateS),this._frameLerp(t,e.frameStep.translateT,e.translateT)]),i},t.prototype._generateMatrixStack=function(t,e){for(var i=[],s=t.objects.objectData,a=t.commands,r=mat4.clone(this.baseMat),n=0,o=-1,h=0;h<a.length;h++){var l=a[h];if(null==l.copy){null!=l.restoreID&&(r=mat4.clone(i[l.restoreID]));var c=s[l.obj];mat4.multiply(r,r,c.mat),1==c.billboardMode&&mat4.multiply(r,r,_.billboardMat),2==c.billboardMode&&mat4.multiply(r,r,_.yBillboardMat),null!=l.stackID?(i[l.stackID]=mat4.clone(r),(n=l.stackID)>o&&(o=n)):i[n]=mat4.clone(r)}else i[l.dest]=mat4.clone(i[l.copy])}t.lastStackID=n;var d=[t.head.scale,t.head.scale,t.head.scale];e.set(this._matBufEmpty);var u=0;for(h=0;h<=o;h++)null!=i[h]&&(mat4.scale(i[h],i[h],d),e.set(i[h],u)),u+=16;return e},t.prototype._drawModelBuffer=function(t,e,i){for(var s=0;s<t.strips.length;s++){var a=t.strips[s];a!=_.last.obj&&(e.bindBuffer(e.ARRAY_BUFFER,a.vPos),e.vertexAttribPointer(i.attributes.vertexPositionAttribute,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a.vTx),e.vertexAttribPointer(i.attributes.textureCoordAttribute,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a.vCol),e.vertexAttribPointer(i.attributes.colorAttribute,4,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a.vMat),e.vertexAttribPointer(i.attributes.matAttribute,1,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a.vNorm),e.vertexAttribPointer(i.attributes.normAttribute,3,e.FLOAT,!1,0,0),_.last.obj=a),e.drawArrays(a.mode,0,a.verts)}},t._loadTex=function(t,e,i,s){var a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),i&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),s&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.generateMipmap(e.TEXTURE_2D),a.width=t.width,a.height=t.height,e.bindTexture(e.TEXTURE_2D,null),a},t}(),T=function(){function t(t){var e,i;this.local=!1,this.kart=null,this.battleMode=null==t.sections.EPAT,this.paths=[],this.points=[],this.battleMode?(e=t.sections.MEPA,i=t.sections.MEPO):(e=t.sections.EPAT,i=t.sections.EPOI),this.points=i.entries,this.paths=e.entries,this.ePath=this.paths[0],this.ePoiInd=this.ePath.startInd,this.ePoi=this.points[this.ePath.startInd],this.posOffset=[0,0,0],this.destOff=[0,0,0],this.offTrans=0,this.chooseNewOff(),this.destNorm=null,this.destConst=null,this.destPoint=null,this.item=!1}return t.prototype.setKart=function(t){this.kart=t,this.calcDestNorm()},t.prototype.fetchInput=function(){var t=this.kart.local&&!!window.keysArray[65];vec3.dot(this.destNorm,this.kart.pos)+this.destConst<this.ePoi.pointSize&&this.advancePoint(),this.destPoint=vec3.add([0,0,0],this.ePoi.pos,vec3.scale([0,0,0],vec3.lerp([0,0,0],this.posOffset,this.destOff,this.offTrans),this.ePoi.pointSize));var e=Math.atan2(this.destPoint[0]-this.kart.pos[0],this.kart.pos[2]-this.destPoint[2]),i=this.kart.physicalDir;if(this.kart.physBasis){if(this.kart.physBasis.loop)return{accel:!0,decel:!1,drift:!1,item:t,turn:0,airTurn:0};var s=[Math.sin(i),0,-Math.cos(i)];vec3.transformMat4(s,s,this.kart.physBasis.mat),i=Math.atan2(s[0],-s[2])}var a=this.dirDiff(e,i),r=Math.min(Math.max(-1,3*a),1);return this.offTrans+=1/240,this.offTrans>=1&&this.chooseNewOff(),this.item=!this.item,{accel:!0,decel:!1,drift:!1,item:t,turn:r,airTurn:0}},t.prototype.chooseNewOff=function(){this.posOffset=this.destOff;var t=Math.random()*Math.PI*2,e=Math.random();this.destOff=[Math.sin(t)*e,0,Math.cos(t)*e],this.offTrans=0},t.prototype.calcDestNorm=function(){var t=vec3.sub([0,0,0],this.kart.pos,this.ePoi.pos);vec3.normalize(t,t),this.destNorm=t,this.destConst=-vec3.dot(this.ePoi.pos,t)},t.prototype.setRouteID=function(t){this.ePoiInd=t-1,this.advancePoint()},t.prototype.advancePoint=function(){if(++this.ePoiInd<this.ePath.startInd+this.ePath.pathLen)this.ePoi=this.points[this.ePoiInd];else if(this.battleMode){var t=Math.random()>.5&&this.ePath.source.length>0?this.ePath.source:this.ePath.dest,e=t[Math.floor(Math.random()*t.length)];this.ePoiInd=e;var i=this.points[this.ePoiInd];null!=i&&(this.ePoi=i,this.recomputePath())}else e=this.ePath.dest[Math.floor(Math.random()*this.ePath.dest.length)],this.ePath=this.paths[e],this.ePoi=this.points[this.ePath.startInd],this.ePoiInd=this.ePath.startInd;this.calcDestNorm()},t.prototype.recomputePath=function(){for(var t=0;t<this.paths.length;t++){var e=this.ePoiInd-this.paths[t].startInd;e>=0&&e<this.paths[t].pathLen&&(this.ePath=this.paths[t])}},t.prototype.fixDir=function(t){return this.posMod(t,2*Math.PI)},t.prototype.dirDiff=function(t,e){var i=this.fixDir(t-e);return i>Math.PI?-2*Math.PI+i:i},t.prototype.posMod=function(t,e){return(t%e+e)%e},t}(),b=function(){function t(){this.local=!0,this.kart=null}return t.prototype.setKart=function(t){this.kart=t},t.prototype.fetchInput=function(){var t=window.keysArray[37]?1:0,e=window.keysArray[39]?1:0,i=window.keysArray[38]?1:0,s=window.keysArray[40]?1:0;return{accel:!!window.keysArray[88],decel:!!window.keysArray[90],drift:!!window.keysArray[83],item:!!window.keysArray[65],turn:e-t,airTurn:i-s}},t}(),y=function(){function t(){this.local=!0,this.item=!1}return t.prototype.setKart=function(t){this.kart=t},t.prototype.searchForTouch=function(t){for(var e=window.touches,i=0;i<e.length;i++){var s=e[i],a=s.x>t[0]&&s.y>t[1]&&s.x<t[2]&&s.y<t[3],r=s.lastx>t[0]&&s.lasty>t[1]&&s.lastx<t[2]&&s.lasty<t[3],n=a&&!s.released;if(a==r&&a)return{touch:s,enterLeave:0,active:n};if(a)return{touch:s,enterLeave:1,active:n};if(r)return{touch:s,enterLeave:2,active:n}}return null},t.prototype.step=function(t,e,i){return Math.max(0,Math.min(1,(i-t)/(e-t)))},t.prototype.fetchInput=function(){var t=1136,e=this.searchForTouch([955/t,.5,1080/t,.6953125]),i=null!=e&&e.active,s=this.searchForTouch([780/t,.73125,1080/t,.9265625]),a=this.searchForTouch([50/t,.73125,350/t,.9265625]),r=this.searchForTouch([0,.653125,400/t,1.0828125]),n=0;null!=r&&r.active&&(n=this.step(0,400/t,r.touch.x),n=Math.floor(3*n)-1);var o=0;if(this.item){if(null==r||!r.active){if(null!=r){var h=r.touch.lasty-r.touch.y;h>2/640&&(o=-1),h<-2/640&&(o=1)}this.item=!1}}else null!=a&&a.active&&a.touch.pressed&&(this.item=!0);return{accel:!i,decel:i,drift:null!=s&&s.active,item:this.item,turn:n,airTurn:o}},t}();function M(){return window.mobile?y:b}var A=[{name:"cross_course",music:74},{name:"bank_course",music:16},{name:"beach_course",music:15},{name:"mansion_course",music:21,lightHeight:20/180,lightAngle:160/180},{name:"desert_course",music:38,lightHeight:40/180},{name:"town_course",music:17},{name:"pinball_course",music:19},{name:"ridge_course",music:36},{name:"snow_course",music:37},{name:"clock_course",music:39},{name:"mario_course",music:74},{name:"airship_course",music:18,lightHeight:40/180,lightAngle:140/180},{name:"stadium_course",music:19},{name:"garden_course",music:20},{name:"koopa_course",music:40},{name:"rainbow_course",music:41},{name:"old_mario_sfc",music:22},{name:"old_momo_64",music:30},{name:"old_peach_agb",music:26},{name:"old_luigi_gc",music:33},{name:"old_donut_sfc",music:24},{name:"old_frappe_64",music:31},{name:"old_koopa_agb",music:27},{name:"old_baby_gc",music:34},{name:"old_noko_sfc",music:23},{name:"old_choco_64",music:29},{name:"old_luigi_agb",music:26},{name:"old_kinoko_gc",music:35},{name:"old_choco_sfc",music:25},{name:"old_hyudoro_64",music:32},{name:"old_sky_agb",music:28,skyboxShadows:!0},{name:"old_yoshi_gc",music:33,lightHeight:30/180,lightAngle:111/180},{name:"mini_stage1",music:43,battle:!0},{name:"mini_stage2",music:43,battle:!0,lightHeight:20/180,lightAngle:160/180},{name:"mini_stage3",music:43,battle:!0},{name:"mini_stage4",music:43,battle:!0},{name:"mini_block_64",music:43,battle:!0},{name:"mini_dokan_gc",music:43,battle:!0}],w=parseInt(localStorage.getItem("CURRENTCOURSE"));Number.isInteger(w)&&w>=0&&w<=A.length||(w=Math.floor(Math.random()*A.length));var S=localStorage.getItem("CURRENTLANG")||"us",R=parseInt(localStorage.getItem("CURRENTLAPTYPE"));R=[3,5].includes(R)?R:3;var I=(localStorage.getItem("CONTROLTYPE")||"cpu").toUpperCase(),C={DAMAGE_SPIN:0,DAMAGE_FLIP:1,DAMAGE_EXPLODE:2,COURSEDIR:"/data/Course/",COURSES:A,CURRENTCOURSE:w,CURRENTLANG:S,MAX_LAP:R,CONTROLTYPE:I,USER_CONTROLLER:"MAN"===I?M():T},x=function(){function e(t){this.rom=t,this.kartPhys=new o(this.rom.getFile("/data/KartModelMenu/kartphysicalparam.bin")),this.kartOff=new n(this.rom.getFile("/data/KartModelMenu/kartoffsetdata.bin")),this.MapObj=new l(h.decompress(this.rom.getFile("/data/Main/MapObj.carc"))),this.MainRace=new l(h.decompress(this.rom.getFile("/data/MainRace.carc"))),this.MainEffect=new l(h.decompress(this.rom.getFile("/data/MainEffect.carc"))),this.Main2D=new l(h.decompress(this.rom.getFile("/data/Main2D.carc"))),this.Main2DLoc=new l(h.decompress(this.rom.getFile("/data/Main2D_".concat(C.CURRENTLANG,".carc")))),this.KartModelSub=new l(h.decompress(this.rom.getFile("/data/KartModelSub.carc"))),this.Race=new l(h.decompress(this.rom.getFile("/data/Scene/Race.carc"))),this.RaceLoc=new l(h.decompress(this.rom.getFile("/data/Scene/Race_".concat(C.CURRENTLANG,".carc")))),this.RaceEffect=new p(this.MainEffect.getFile("RaceEffect.spa")),this.MainFont=new d(this.Main2D.getFile("marioFont.NFTR")),this.MFont=new d(this.Main2D.getFile("LC_Font_m.NFTR")),this.SFont=new d(this.Main2D.getFile("LC_Font_s.NFTR")),this.toSoundOff=[4,0,1,2,5,6,7,3,10,8,9,11,12],this.charNames=["mario","donkey","kinopio","koopa","peach","wario","yoshi","luigi","karon","daisy","waluigi","robo","heyho"],this.charAbbrv=["MR","DK","KO","KP","PC","WR","YS","LG","KA","DS","WL","RB","HH"],this.characters=[],this.karts=[],this.letters=["a","b","c"],this._loadItems(),this._loadTires(),this._loadPlayerThumb()}return e.prototype.testFont=function(t,e,i){var s=Object.keys(t.charMap).join(""),a=document.createElement("h3");a.innerText=i,document.body.appendChild(a);for(var r=0;r<4;r++){var n=Math.floor(s.length*r/4),o=Math.floor(s.length*(r+1)/4),h=t.drawToCanvas(s.substring(n,o),[[0,0,0,0],[255,0,0,255],[255,255,255,255],[32,0,0,255],[64,0,0,255],[96,0,0,255],[128,0,0,255]],1);document.body.appendChild(h)}},e.prototype.listRecursive=function(t,e){e=e||"";for(var i=t.list(),s=0;s<i.length;s++){var a=i[s];a.toLowerCase().endsWith(".carc")&&this.listRecursive(new l(h.decompress(t.getFile(a))),e+a),a.toLowerCase().endsWith(".nftr")&&this.testFont(new d(t.getFile(a)),0,e+a)}},e.prototype._loadItems=function(){var t={banana:void 0,bomb:void 0,gesso:void 0,kinoko:void 0,kinoko_p:void 0,koura_g:void 0,koura_r:void 0,star:void 0,teresa:void 0,thunder:void 0,koura_w:void 0,f_box:void 0,killer:void 0};for(var e in t)t[e]=new g(new f(this.MainRace.getFile("/Item/it_"+e+".nsbmd")),null);var i=new g(new f(this.MainRace.getFile("/Item/koura_w.nsbmd")),null),s=new g(new f(this.MainRace.getFile("/Item/geso_sumi.nsbmd")),null),a=new g(new f(this.MainRace.getFile("/MapObj/box.nsbmd")),null);this.items={banana:t.banana,bomb:t.bomb,gesso:t.gesso,kinoko:t.kinoko,kinoko_p:t.kinoko_p,koura_g:t.koura_g,koura_r:t.koura_r,star:t.star,teresa:t.teresa,thunder:t.thunder,koura_w:t.koura_w,f_box:t.f_box,killer:t.killer,blueShell:i,splat:s,fakeBox:a}},e.prototype._loadTires=function(){var t="/data/KartModelMenu/kart/tire/",e={kart_tire_L:void 0,kart_tire_M:void 0,kart_tire_S:void 0};for(var i in e){var s=new f(this.rom.getFile(t+i+".nsbmd")),a=new m(this.rom.getFile(t+i+".nsbtx"),!1);e[i]=new g(s,a)}this.tireRes={kart_tire_L:e.kart_tire_L,kart_tire_M:e.kart_tire_M,kart_tire_S:e.kart_tire_S}},e.prototype._loadPlayerThumb=function(){var e=this.Main2DLoc.getFile("player_character_L.nce.ncgr"),i=this.Main2DLoc.getFile("player_character_L_o.NCLR"),n=this.Main2DLoc.getFile("player_character_L.nce.ncer"),o=new a(e),h=new r(i),l=new s(n);this.playerThumb=new t(h,o,l)},e.prototype.getChar=function(t){if(null!=this.characters[t])return this.characters[t];var e=this.rom.getFile("/data/KartModelMenu/emblem/".concat(this.charAbbrv[t],"_emblem.nsbtx")),i=this.playerThumb.toTexture(!0,t),s="/character/"+this.charNames[t]+"/P_"+this.charAbbrv[t],a=new f(this.KartModelSub.getFile(s+".nsbmd")),r=new m(this.KartModelSub.getFile(s+".nsbtx"),!1),n={model:new g(a,r,{tex:{1:2},pal:{1:2}}),driveA:new u(this.KartModelSub.getFile(s+"_drive.nsbca")),loseA:new u(this.KartModelSub.getFile(s+"_lose.nsbca")),spinA:new u(this.KartModelSub.getFile(s+"_spin.nsbca")),winA:new u(this.KartModelSub.getFile(s+"_win.nsbca")),sndOff:14*this.toSoundOff[t],emblem:new m(e,!1),thumb:i};return this.characters[t]=n,this.characters[t]},e.prototype.getKart=function(t){if(null!=this.karts[t])return this.karts[t];var e=Math.floor(t/3),i=t%3;0==i&&(e=0);var s=this.charAbbrv[e]+"_"+this.letters[i],a="/data/KartModelMenu/kart/"+this.charNames[e]+"/kart_"+s,r=new g(new f(this.rom.getFile(a+".nsbmd")),new m(this.rom.getFile(a+".nsbtx"),!1));return r.shadVol=new g(new f(this.rom.getFile("/data/KartModelMenu/kart/shadow/sh_"+s+".nsbmd")),null),this.karts[t]=r,this.karts[t]},e}(),D=function(){function t(t){this.kart=t,this.targetShadowPos=[0,0,0],this.mat=mat4.create(),this.camOffset=[0,32,-48],this.lookAtOffset=[0,16,0],this.camNormal=[0,1,0],this.forwardNormal=null,this.camAngle=0,this.boostOff=0}return t.prototype._tweenVec3=function(t,e){t[0]+=.075*(e[0]-t[0]),t[1]+=.075*(e[1]-t[1]),t[2]+=.075*(e[2]-t[2])},t.prototype.getView=function(t){var e=null!=this.kart.physBasis&&this.kart.physBasis.loop,i=this._buildBasis();this._tweenVec3(this.camOffset,e?[0,12,-57]:[0,32,-48]);var s=vec3.transformMat4([0,0,0],this.camOffset,i),a=vec3.transformMat4([0,0,0],this.lookAtOffset,i);vec3.scale(s,s,1/1024),vec3.scale(a,a,1/1024),this.mat=mat4.lookAt(mat4.create(),s,a,this.kart.physBasis?this.camNormal:[0,1,0]);var r=vec3.clone(this.kart.pos);if(this.kart.drifting&&!this.kart.driftLanded&&this.kart.ylock>0&&(r[1]-=this.kart.ylock),mat4.translate(this.mat,this.mat,vec3.scale([0,0,0],r,-1/1024)),this._tweenVec3(this.camNormal,this.kart.kartNormal),vec3.normalize(this.camNormal,this.camNormal),e){var n=this.kart.physicalDir+this.kart.driftOff/2,o=[Math.sin(n),0,-Math.cos(n)];vec3.transformMat4(o,o,this.kart.physBasis.mat),this.camAngle+=.075*this._dirDiff(Math.atan2(o[0],-o[2]),this.camAngle),null==this.forwardNormal?this.forwardNormal=[Math.sin(this.camAngle),0,-Math.cos(this.camAngle)]:this._tweenVec3(this.forwardNormal,o)}else this.camAngle+=.075*this._dirDiff(this.kart.physicalDir+this.kart.driftOff/2,this.camAngle),this.forwardNormal=null;this.camAngle=this._fixDir(this.camAngle),this.boostOff+=.075*((this.kart.boostNorm+this.kart.boostMT>0?5:0)-this.boostOff);var h=mat4.perspective(mat4.create(),(70+this.boostOff)/180*Math.PI,gl.viewportWidth/gl.viewportHeight,.01,1e4);return this.targetShadowPos=vec3.add([0,0,0],this.kart.pos,[192*Math.sin(this.kart.angle),0,192*-Math.cos(this.kart.angle)]),this.view={p:h,mv:this.mat,pos:vec3.scale([0,0,0],vec3.transformMat4([0,0,0],[0,0,0],mat4.invert(mat4.create(),this.mat)),1024)},this.view},t.prototype._buildBasis=function(){var t=null!=this.forwardNormal?this.forwardNormal:[Math.sin(this.camAngle),0,-Math.cos(this.camAngle)],e=vec3.cross([0,0,0],t,this.camNormal),i=this._gramShmidt(this.camNormal,e,t),s=i[0];return i[0]=i[1],i[1]=s,[i[0][0],i[0][1],i[0][2],0,i[1][0],i[1][1],i[1][2],0,i[2][0],i[2][1],i[2][2],0,0,0,0,1]},t.prototype._gramShmidt=function(t,e,i){var s=t,a=vec3.sub([0,0,0],e,this._project(s,e)),r=vec3.sub([0,0,0],vec3.sub([0,0,0],i,this._project(s,i)),this._project(a,i));return[vec3.normalize(s,s),vec3.normalize(a,a),vec3.normalize(r,r)]},t.prototype._project=function(t,e){return vec3.scale([0,0,0],t,vec3.dot(t,e)/vec3.dot(t,t))},t.prototype._fixDir=function(t){return this._posMod(t,2*Math.PI)},t.prototype._dirDiff=function(t,e){var i=this._fixDir(t-e);return i>Math.PI?-2*Math.PI+i:i},t.prototype._posMod=function(t,e){return(t%e+e)%e},t}(),P=function(){function t(t){this.kart=t,this.targetShadowPos=[0,0,0],this.mat=mat4.create(),this.curCamNum=-1,this.curCam=null,this.route=[],this.routePos=0,this.routeSpeed=0,this.routeProg=0,this.relPos=[0,0,0],this.posOff=[],this.normalFOV=70,this.zoomLevel=1,this.viewW=0,this.viewH=0,this.camAngle=0,this.camNormal=[0,1,0]}return t.prototype.initDashCam=function(t,e){var i=mat4.create();mat4.rotateY(i,i,(180-e.pos2[0])*(Math.PI/180)),mat4.rotateX(i,i,-e.pos2[1]*(Math.PI/180)),this.relPos=vec3.transformMat4([0,0,0],[0,0,-e.pos2[2]],i)},t.prototype.initCam1=function(t,e){var i=t.paths;this.route=i[e.camRoute],this.routePos=0,this.routeProg=0,this.recalcRouteSpeed()},t.prototype.initPointCam=function(t,e){var i=t.paths;this.route=i[e.camRoute],this.routePos=0,this.routeProg=0,this.recalcRouteSpeed()},t.prototype.pointCamFunc=function(t,e){var i=vec3.clone(e.pos1),s=vec3.transformMat4([0,0,0],[0,4,0],this.kart.mat);vec3.scale(i,i,1/1024),vec3.scale(s,s,1/1024);var a=mat4.lookAt(mat4.create(),i,s,[0,1,0]),r=mat4.perspective(mat4.create(),this.zoomLevel*this.normalFOV/180*Math.PI,this.viewW/this.viewH,.01,1e4);return this.targetShadowPos=this.kart.pos,{p:r,mv:a,pos:null}},t.prototype.camFunc1=function(t,e){var i=vec3.lerp([0,0,0],this.route[this.routePos].pos,this.route[(this.routePos+1)%this.route.length].pos,this.routeProg);this.routeProg+=this.routeSpeed,this.routeProg>1&&(this.routePos=(this.routePos+1)%this.route.length,this.routeProg=0,this.recalcRouteSpeed());var s=vec3.transformMat4([0,0,0],[0,4,0],this.kart.mat);vec3.scale(i,i,1/1024),vec3.scale(s,s,1/1024);var a=mat4.lookAt(mat4.create(),i,s,[0,1,0]),r=mat4.perspective(mat4.create(),this.zoomLevel*this.normalFOV/180*Math.PI,this.viewW/this.viewH,.01,1e4);return this.targetShadowPos=this.kart.pos,{p:r,mv:a,pos:null}},t.prototype.dashCamFunc=function(t,e){var i=this.kart.basis,s=vec3.transformMat4([0,0,0],this.relPos,i),a=vec3.transformMat4([0,0,0],[0,0,0],i);vec3.scale(s,s,1/1024),vec3.scale(a,a,1/1024);var r=mat4.lookAt(mat4.create(),s,a,[0,1,0]),n=mat4.create();mat4.translate(n,n,[-e.pos3[0]/1024,e.pos3[1]/1024,-e.pos3[2]/1024]),mat4.mul(r,n,r);var o=vec3.clone(this.kart.pos);this.kart.drifting&&!this.kart.driftLanded&&this.kart.ylock>0&&(o[1]-=this.kart.ylock),mat4.translate(r,r,vec3.scale([0,0,0],o,-1/1024));var h=mat4.perspective(mat4.create(),this.zoomLevel*this.normalFOV/180*Math.PI,this.viewW/this.viewH,.01,1e4);return this.targetShadowPos=this.kart.pos,{p:h,mv:r,pos:null}},t.prototype.getView=function(t,e,i){this.viewW=e,this.viewH=i;var s=t.nkm.sections.CAME.entries,a=this.getNearestArea(t.nkm.sections.AREA.entries,this.kart.pos);if(a.came!=this.curCamNum)switch(this.curCamNum=a.came,this.curCam=s[this.curCamNum],this.zoomLevel=this.curCam.zoomStart,this.curCam.camType){case 0:case 2:this.initPointCam(t,this.curCam);break;case 1:this.initCam1(t,this.curCam);break;case 5:this.initDashCam(t,this.curCam)}switch(this.zoomLevel<this.curCam.zoomMark1?this.zoomLevel+=this.curCam.zoomSpeedM1:this.zoomLevel>this.curCam.zoomMark2?this.zoomLevel+=this.curCam.zoomSpeedM2:this.zoomLevel+=this.curCam.zoomSpeed,this.zoomLevel>this.curCam.zoomEnd&&(this.zoomLevel=this.curCam.zoomEnd),this.curCam.camType){case 0:case 2:this.view=this.pointCamFunc(t,this.curCam);break;case 1:this.view=this.camFunc1(t,this.curCam);break;case 5:this.view=this.dashCamFunc(t,this.curCam)}return this.view.pos=vec3.scale([0,0,0],vec3.transformMat4([0,0,0],[0,0,0],mat4.invert(mat4.create(),this.view.mv)),1024),this.view},t.prototype.recalcRouteSpeed=function(){this.routeSpeed=this.curCam.routeSpeed/100/60},t.prototype.getNearestArea=function(t,e){for(var i=1/0,s=null,a=0;a<t.length;a++){var r=t[a],n=vec3.sub([0,0,0],r.pos,e);vec3.divide(n,n,r.dimensions);var o=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);o<i&&255!=r.came&&(i=o,s=r)}return s},t.prototype.buildBasis=function(){var t=this.gramShmidt(this.camNormal,[Math.cos(this.camAngle),0,Math.sin(this.camAngle)],[Math.sin(this.camAngle),0,-Math.cos(this.camAngle)]),e=t[0];return t[0]=t[1],t[1]=e,[t[0][0],t[0][1],t[0][2],0,t[1][0],t[1][1],t[1][2],0,t[2][0],t[2][1],t[2][2],0,0,0,0,1]},t.prototype.gramShmidt=function(t,e,i){var s=t,a=vec3.sub([0,0,0],e,this.project(s,e)),r=vec3.sub([0,0,0],vec3.sub([0,0,0],i,this.project(s,i)),this.project(a,i));return[vec3.normalize(s,s),vec3.normalize(a,a),vec3.normalize(r,r)]},t.prototype.project=function(t,e){return vec3.scale([0,0,0],t,vec3.dot(t,e)/vec3.dot(t,t))},t.prototype.fixDir=function(t){return this.posMod(t,2*Math.PI)},t.prototype.dirDiff=function(t,e){var i=this.fixDir(t-e);return i>Math.PI?-2*Math.PI+i:i},t.prototype.posMod=function(t,e){return(t%e+e)%e},t}(),U=function(){function t(t){this.kart=t,this.targetShadowPos=[0,0,0],this.mat=mat4.create(),this.curCamNum=-1,this.curCam=null,this.route=null,this.routePos=0,this.routeSpeed=0,this.routeProg=0,this.duration=0,this.pointInterp=0,this.normalFOV=70,this.zoomLevel=1,this.viewW=0,this.viewH=0}return t.prototype.camFunc=function(t,e){var i=vec3.lerp([0,0,0],this.route[this.routePos].pos,this.route[(this.routePos+1)%this.route.length].pos,this.routeProg);this.routeProg+=this.routeSpeed,this.routeProg>1&&(this.routePos=(this.routePos+1)%this.route.length,this.routeProg=0,this.recalcRouteSpeed()),this.pointInterp+=this.curCam.pointSpeed/100/60,this.pointInterp>1&&(this.pointInterp=1);var s=vec3.lerp([0,0,0],this.curCam.pos2,this.curCam.pos3,this.pointInterp);vec3.scale(i,i,1/1024),vec3.scale(s,s,1/1024);var a=mat4.lookAt(mat4.create(),i,s,[0,1,0]),r=mat4.perspective(mat4.create(),this.zoomLevel*this.normalFOV/180*Math.PI,this.viewW/this.viewH,.01,1e4);return this.targetShadowPos=s,{p:r,mv:a,pos:vec3.scale([0,0,0],vec3.transformMat4([0,0,0],[0,0,0],mat4.invert(mat4.create(),a)),1024)}},t.prototype.initCam=function(t,e){var i=t.paths;this.route=i[e.camRoute],this.routePos=0,this.routeProg=0,this.duration=e.duration,this.recalcRouteSpeed()},t.prototype.getView=function(t,e,i){if(null==this.curCam&&this.restartCam(t),this.viewW=e,this.viewH=i,this.zoomLevel<this.curCam.zoomMark1?this.zoomLevel+=this.curCam.zoomSpeedM1:this.zoomLevel>this.curCam.zoomMark2?this.zoomLevel+=this.curCam.zoomSpeedM2:this.zoomLevel+=this.curCam.zoomSpeed,this.zoomLevel>this.curCam.zoomEnd&&(this.zoomLevel=this.curCam.zoomEnd),this.duration--<0){var s=t.nkm.sections.CAME.entries;-1!=this.curCam.nextCam?(this.curCamNum=this.curCam.nextCam,this.curCam=s[this.curCamNum],this.zoomLevel=this.curCam.zoomStart,this.initCam(t,this.curCam)):this.restartCam(t)}return this.view=this.camFunc(t,this.curCam),this.view},t.prototype.restartCam=function(t){for(var e=t.nkm.sections.CAME.entries,i=0;i<e.length;i++)2==e[i].firstCam&&(this.curCamNum=i,this.curCam=e[this.curCamNum],this.zoomLevel=this.curCam.zoomStart,this.initCam(t,this.curCam))},t.prototype.recalcRouteSpeed=function(){this.routeSpeed=this.curCam.routeSpeed/100/60},t}(),k=function(){function t(){this.kart=null,this.local=!1,this.turn=0,this.airTurn=0,this.binput=0}return t.prototype.setKart=function(t){this.kart=t},t.prototype.fetchInput=function(){return{accel:!!(1&this.binput),decel:!!(2&this.binput),drift:!!(4&this.binput),item:!1,turn:this.turn,airTurn:this.airTurn}},t}(),E=function(){function t(t){var e=this;if(this.input=t,this.handlers={},this.handlers.BTAF=function(t,e,i){i.files=[];for(var s=0;s<i.numFiles;s++){var a=t.getUint32(e,!0),r=t.getUint32(e+4,!0);i.files.push({start:a,end:r}),e+=8}},this.handlers.BTNF=function(t,i,s){var a=i;s.directories=[];var r=a+t.getUint32(i,!0),n={firstFile:t.getUint16(i+4,!0),numDir:t.getUint16(i+6,!0)};e._populateDir(t,r,n),i+=8,s.directories.push(n);for(var o=n.numDir-1,h=0;h<o;h++){r=a+t.getUint32(i,!0);var l={firstFile:t.getUint16(i+4,!0),parent:t.getUint16(i+6,!0)};e._populateDir(t,r,l),i+=8,s.directories.push(l)}},null!=this.input)if("string"==typeof this.input){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",this.input,!0),i.onload=function(){e.load(i.response)},i.send()}else this.load(this.input)}return t.prototype.load=function(t){var e=new DataView(t);this.view=e,this.sections={},this.nameOff=e.getUint32(64,!0),this.fileOff=e.getUint32(72,!0),this.sections.BTNF={},this.handlers.BTNF(e,this.nameOff,this.sections.BTNF)},t.prototype.getFile=function(t){for(var e=t.split("/"),i=""==e[0]?1:0,s=this.sections.BTNF.directories,a=s[0].entries,r=i;r<e.length;r++){for(var n=!1,o=0;o<a.length;o++)if(a[o].name==e[r]){if(a[o].dir){n=!0,a=s[a[o].id-61440].entries;break}return this._readFileWithID(a[o].id)}if(!n)return console.error("File not found: "+t+", could not find "+e[r]),null}return console.error("Path is not a file: "+t),null},t.prototype.list=function(t,e,i){i=i||"/",t=t||[];var s=this.sections.BTNF.directories;e=e||s[0].entries;for(var a=0;a<e.length;a++)e[a].dir?this.list(t,s[e[a].id-61440].entries,i+e[a].name+"/"):t.push(i+e[a].name);return t},t.prototype._readFileWithID=function(t){var e=this.fileOff+8*t;return this.input.slice(this.view.getUint32(e,!0),this.view.getUint32(e+4,!0))},t.prototype._populateDir=function(t,e,i){var s=i.firstFile;for(i.entries=[];;){var a=t.getUint8(e++),r=127&a;if(128&a){var n=t.getUint16(e+r,!0);i.entries.push({dir:!0,id:n,name:this._readString(t,e,r)}),e+=r+2}else{if(0==r)return;i.entries.push({dir:!1,id:s++,name:this._readString(t,e,r)}),e+=r}}},t.prototype._readString=function(t,i,s){for(var a="",r=0;r<s;r++)a+=e.asciireadChar(t,i++);return a},t}(),F=function(){function t(t){this.input=t,this.mainOff=void 0,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var e,s=new DataView(t),a=i.readHeader(s);if("RCSN"!=a.stamp)throw"NSCR invalid. Expected RCSN, found "+a.stamp;if(1!=a.numSections)throw"NSCR invalid. Too many sections - should have 1.";e=a.sectionOffsets[0],this.sectionOffsets=a.sectionOffsets,this.sectionOffsets[0]=24,this.mainOff=e,this.scrn=this._loadSCRN(s)},t.prototype._loadSCRN=function(t){var i=this.sectionOffsets[0]-8,s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("NRCS"!=s)throw"SCRN invalid. Expected NRCS, found "+s;var a=t.getUint32(i+4,!0);this.sectionOffsets[1]=this.sectionOffsets[0]+a;var r=t.getUint16(i+8,!0),n=t.getUint16(i+10,!0),o=t.getUint32(i+12,!0),h=t.getUint32(i+16,!0);i+=20;for(var l=(a-20)/2,c=[],d=0;d<l;d++)c.push(t.getUint16(i,!0)),i+=2;return{type:s,blockSize:a,screenWidth:r,screenHeight:n,padding:o,screenDataSize:h,data:c}},t}(),N=function(){function t(t){this.input=t,this.data=void 0,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var i=new DataView(t),s=0,a=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3);if("SSEQ"!=a)throw"SSEQ invalid. Expected SSEQ, found "+a;s+=16;var r=e.asciireadChar(i,s)+e.asciireadChar(i,s+1)+e.asciireadChar(i,s+2)+e.asciireadChar(i,s+3);if("DATA"!=r)throw"SWAV invalid, expected DATA, found "+r;s+=8,this.data=new Uint8Array(t.slice(i.getUint32(s,!0)))},t}(),O=function(){function t(t){this.input=t,this.dataOff=void 0,this.data=void 0,this.entries=void 0,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var i=new DataView(t),s=0,a=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3);if("SSAR"!=a)throw"SSAR invalid. Expected SSAR, found "+a;s+=16;var r=e.asciireadChar(i,s)+e.asciireadChar(i,s+1)+e.asciireadChar(i,s+2)+e.asciireadChar(i,s+3);if("DATA"!=r)throw"SSAR invalid, expected DATA, found "+r;s+=8,this.dataOff=i.getUint32(s,!0),this.data=new Uint8Array(i.buffer.slice(this.dataOff));var n=i.getUint32(s+4,!0);this.entries=[],s+=8;for(var o=0;o<n;o++)this.entries.push(this._readSeqEntry(i,s)),s+=12},t.prototype._readSeqEntry=function(t,e){return{pc:t.getUint32(e,!0),seq:{data:this.data},bank:t.getUint16(e+4,!0),vol:t.getUint8(e+6),cpr:t.getUint8(e+7),ppr:t.getUint8(e+8),ply:t.getUint8(e+9)}},t}(),B=function(){return B=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},B.apply(this,arguments)},L=function(){function t(t){this.input=t,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var i=new DataView(t),s=0,a=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3);if("SBNK"!=a)throw"SWAV invalid. Expected SWAV, found "+a;s+=16;var r=e.asciireadChar(i,s)+e.asciireadChar(i,s+1)+e.asciireadChar(i,s+2)+e.asciireadChar(i,s+3);if("DATA"!=r)throw"SWAV invalid, expected DATA, found "+r;s+=8,s+=32;var n=i.getUint32(s,!0);this.instruments=[],s+=4;for(var o=0;o<n;o++){var h=i.getUint8(s),l=i.getUint16(s+1,!0);if(0==h)this.instruments.push({type:0});else if(h<16)this.instruments.push(B({type:1},this._readParams(i,l)));else if(16==h){for(var c=i.getUint8(l++),d=i.getUint8(l++),u=[],m=d-c+1,f=0;f<m;f++)u.push(this._readParams(i,l+2)),l+=12;this.instruments.push({type:2,lower:c,upper:d,entries:u})}else if(17==h){var p=[];for(f=0;f<8;f++){var v=i.getUint8(l+f);if(0==v)break;p.push(v)}for(u=[],l+=8,f=0;f<p.length;f++)u.push(this._readParams(i,l+2)),l+=12;this.instruments.push({type:3,regions:p,entries:u})}s+=4}},t.prototype._readParams=function(t,e){var i=t.getUint16(e,!0),s=t.getUint16(e+2,!0),a=t.getUint8(e+4);return{swav:i,swar:s,note:a,freq:this._noteToFreq(a),attack:t.getUint8(e+5),decay:t.getUint8(e+6),sustainLvl:t.getUint8(e+7),release:t.getUint8(e+8),pan:t.getUint8(e+9)}},t.prototype._noteToFreq=function(t){return 440*Math.pow(2,(t-49)/12)},t}(),V=function(){function t(t,e,i){this.input=t,this.hasHead=e,this.dataView=i,this.indChanges=[-1,-1,-1,-1,2,4,6,8],this.ADPCMTable=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767],null!=this.input&&this.load(this.input,this.hasHead,this.dataView)}return t.prototype.load=function(t,i,s){var a=s?t:new DataView(t),r=0;if(i){var n=e.asciireadChar(a,0)+e.asciireadChar(a,1)+e.asciireadChar(a,2)+e.asciireadChar(a,3);if("SWAV"!=n)throw"SWAV invalid. Expected SWAV, found "+n;r+=16;var o=e.asciireadChar(a,r)+e.asciireadChar(a,r+1)+e.asciireadChar(a,r+2)+e.asciireadChar(a,r+3);if("DATA"!=o)throw"SWAV invalid, expected DATA, found "+o;r+=8}if(this.waveType=a.getUint8(r),this.bLoop=a.getUint8(r+1),this.nSampleRate=a.getUint16(r+2,!0),this.nSampleRate<3e3)throw"BAD SAMPLE RATE! "+this.nSampleRate;switch(this.nTime=a.getUint16(r+4,!0),this.nLoopOff=a.getUint16(r+6,!0),this.nNonLoopLen=a.getUint32(r+8,!0),this.bytesize=4*(this.nLoopOff+this.nNonLoopLen),this.mul=1,r+=12,this.waveType){case 0:var h=this.bytesize;this.data=new Float32Array(h);for(var l=0;l<h;l++)this.data[l]=a.getInt8(r++)/127;this.loopSTime=4*this.nLoopOff/this.nSampleRate;break;case 1:for(h=this.bytesize/2,this.data=new Float32Array(h),l=0;l<h;l++)this.data[l]=a.getInt16(r,!0)/32767,r+=2;this.loopSTime=2*this.nLoopOff/this.nSampleRate;break;case 2:this.data=this._decodeADPCM(a,r),this.loopSTime=8*(this.nLoopOff-1)/this.nSampleRate}},t.prototype.getAudioBuffer=function(t){for(;;){try{var e=t.createBuffer(1,this.data.length,this.nSampleRate);return e.getChannelData(0).set(this.data),e}catch(t){this.nSampleRate*=2,this.loopSTime/=2,this.mul*=2}if(this.nSampleRate>96e3)return t.createBuffer(1,1,44e3)}},t.prototype._decodeADPCM=function(t,e){var i=t.getUint16(e,!0),s=t.getUint8(e+2);e+=4;for(var a=this.bytesize-4,r=new Float32Array(2*a),n=0,o=0;o<a;o++)for(var h=t.getUint8(e++),l=0;l<2;l++){var c=h>>4*l&15,d=Math.floor((2*(7&c)+1)*this.ADPCMTable[s]/8);i=8&c?Math.max(i-d,-32767):Math.min(i+d,32767),r[n++]=i/32767,s=Math.min(88,Math.max(0,s+this.indChanges[7&c]))}return r},t}(),j=function(){function t(t){this.input=t,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var i=new DataView(t),s=0,a=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3);if("SWAR"!=a)throw"SWAR invalid. Expected SWAR, found "+a;s+=16;var r=e.asciireadChar(i,s)+e.asciireadChar(i,s+1)+e.asciireadChar(i,s+2)+e.asciireadChar(i,s+3);if("DATA"!=r)throw"SWAV invalid, expected DATA, found "+r;s+=40;var n=i.getUint32(s,!0);s+=4,this.samples=[];for(var o=0;o<n;o++){var h=new DataView(t,i.getUint32(s,!0));this.samples.push(new V(h,!1,!0)),s+=4}},t}(),H=function(){function t(t){var e=this;this.input=t,this.sections={"$FAT ":void 0,$INFO:void 0,$FILE:void 0},this.sectionFunc={},this.sectionFunc.$INFO=function(t,i){for(var s=[],a=0;a<8;a++){var r=i+t.getUint32(i+4*a,!0)-8,n=t.getUint32(r,!0);s[a]=[],r+=4;for(var o=null,h=0;h<n;h++){var l=t.getUint32(r,!0);o=e.recordInfoFunc[a](t,i+l-8),s[a][h]=o,r+=4}}return s},this.sectionFunc["$FAT "]=function(t,e){var i=[],s=t.getUint32(e,!0);e+=4;for(var a=0;a<s;a++)i.push({off:t.getUint32(e,!0),size:t.getUint32(e+4,!0)}),e+=16;return i},this.sectionFunc.$FILE=function(t,e){},this.recordInfoFunc=[],this.recordInfoFunc[0]=function(t,i){var s=t.getUint16(i,!0);return{fileID:s,seq:new N(e._getFile(s)),pc:0,unknown:t.getUint16(i+2,!0),bank:t.getUint16(i+4,!0),vol:t.getUint8(i+6),cpr:t.getUint8(i+7),ppr:t.getUint8(i+8),ply:t.getUint8(i+9),nextOff:i+10}},this.recordInfoFunc[1]=function(t,i){var s=t.getUint16(i,!0);return{fileID:s,arc:new O(e._getFile(s)),unknown:t.getUint16(i+2,!0),nextOff:i+4}},this.recordInfoFunc[2]=function(t,i){var s=t.getUint16(i,!0),a=t.getUint16(i+2,!0),r=new L(e._getFile(s)),n=[];i+=4;for(var o=0;o<4;o++)n[o]=t.getUint16(i,!0),i+=2;return{fileID:s,unknown:a,bank:r,waveArcs:n,nextOff:i}},this.recordInfoFunc[3]=function(t,i){var s=t.getUint16(i,!0);return{fileID:s,unknown:t.getUint16(i+2,!0),arc:new j(e._getFile(s)),nextOff:i+4}},this.recordInfoFunc[4]=function(t,e){},this.recordInfoFunc[5]=function(t,e){},this.recordInfoFunc[6]=function(t,e){},this.recordInfoFunc[7]=function(t,e){return{fileID:t.getUint16(e,!0),unknown:t.getUint16(e+2,!0),vol:t.getUint8(e+4),pri:t.getUint8(e+5),ply:t.getUint8(e+6),nextOff:e+7}},null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){this.buffer=t;var i=new DataView(t),s=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3);if("SDAT"!=s)throw"SDAT invalid. Expected SDAT, found "+s;i.getUint32(4,!0),i.getUint32(8,!0),i.getUint16(12,!0),i.getUint16(14,!0);for(var a=3;a>-1;a--){var r=i.getUint32(16+8*a,!0);0!=i.getUint32(20+8*a,!0)&&this._readSection(i,r)}},t.prototype._readSection=function(t,i){var s="$"+e.asciireadChar(t,i)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if(null!=this.sectionFunc[s]){var a=s;this.sections[a]=this.sectionFunc[s](t,i+8)}else console.error("Invalid section in SDAT! No handler for section type "+s.substr(1,4))},t.prototype._getFile=function(t){var e=this.sections["$FAT "][t];if(null!=e)return this.buffer.slice(e.off,e.off+e.size)},t}(),z=function(){function t(t){this.input=t,this.mainOff=void 0,this.matOff=void 0,this.animData=void 0,this.prop=["scaleS","scaleT","rotation","translateS","translateT"],null!=this.input&&this.load(this.input),this.texTotal=void 0,this.palTotal=void 0,this.texNamesOff=void 0,this.palNamesOff=void 0,this.texNames=void 0,this.palNames=void 0}return t.prototype.load=function(t){var s,a,r=this,n=new DataView(t);if("BTP0"!=(s=i.readHeader(n)).stamp)throw"NSBTP invalid. Expected BTP0, found "+s.stamp;if(s.numSections>1)throw"NSBTP invalid. Too many sections - should have 1 maximum.";a=s.sectionOffsets[0],this.mainOff=a;var o=e.asciireadChar(n,a+0)+e.asciireadChar(n,a+1)+e.asciireadChar(n,a+2)+e.asciireadChar(n,a+3);if("PAT0"!=o)throw"NSBTP invalid. Expected PAT0, found "+o;this.animData=i.read3dInfo(n,this.mainOff+8,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r._animInfoHandler(t[0],t[1])}))},t.prototype._animInfoHandler=function(t,e){var i=t.getUint32(e,!0),s=this.mainOff+i,a=this._readAnimData(t,s);return a.nextoff=e+4,a},t.prototype._readAnimData=function(t,s){var a=this;this.matOff=s,e.asciireadChar(t,s+0),e.asciireadChar(t,s+1),e.asciireadChar(t,s+2),e.asciireadChar(t,s+3),s+=4;var r=t.getUint16(s,!0);this.texTotal=t.getUint8(s+2),this.palTotal=t.getUint8(s+3),this.texNamesOff=t.getUint16(s+4,!0),this.palNamesOff=t.getUint16(s+6,!0);var n=this.matOff+this.texNamesOff;this.texNames=[];for(var o=0;o<this.texTotal;o++){for(var h="",l=0;l<16;l++)h+=e.asciireadChar(t,n++);this.texNames[o]=h}for(n=this.matOff+this.palNamesOff,this.palNames=[],o=0;o<this.palTotal;o++){for(h="",l=0;l<16;l++)h+=e.asciireadChar(t,n++);this.palNames[o]=h}var c=i.read3dInfo(t,s+8,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return a._matInfoHandler(t[0],t[1])}));return{data:c,nextoff:c.nextoff,texTotal:this.texTotal,palTotal:this.palTotal,duration:r,texNames:this.texNames,palNames:this.palNames}},t.prototype._matInfoHandler=function(t,e){var i=[],s=t.getUint32(e,!0),a=t.getUint16(e+4,!0),r=t.getUint16(e+6,!0),n=e+=8;e=this.matOff+r;for(var o=0;o<s;o++){var h=t.getUint8(e+2),l=t.getUint8(e+3);i.push({time:t.getUint16(e,!0),texName:this.texNames[h],palName:this.palNames[l]}),e+=4}return{frames:i,flags:a,nextoff:n}},t}(),K=function(){return K=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},K.apply(this,arguments)},W=function(){function t(t){var e=this;if(this.input=t,this.load=this.load,this.handlers={},this.handlers.OBJI=function(t,e){var i=vec3.create();i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096;var s=vec3.create();s[0]=t.getInt32(e+12,!0)/4096,s[1]=t.getInt32(e+16,!0)/4096,s[2]=t.getInt32(e+20,!0)/4096;var a=vec3.create();return a[0]=t.getInt32(e+24,!0)/4096,a[1]=t.getInt32(e+28,!0)/4096,a[2]=t.getInt32(e+32,!0)/4096,{ID:t.getUint16(e+36,!0),routeID:t.getUint16(e+38,!0),setting1:t.getUint32(e+40,!0),setting2:t.getUint32(e+44,!0),setting3:t.getUint32(e+48,!0),setting4:t.getUint32(e+52,!0),timeTrials:t.getUint32(e+56,!0),nextOff:e+60,scale:a,pos:i,angle:s}},this.handlers.PATH=function(t,e){return{routeID:t.getUint8(e),loop:t.getUint8(e+1),numPts:t.getUint16(e+2,!0),nextOff:e+4}},this.handlers.POIT=function(t,e){var i=vec3.create();return i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096,{pos:i,pointInd:t.getUint16(e+12,!0),duration:t.getUint16(e+14,!0),unknown:t.getUint32(e+16,!0),nextOff:e+20}},this.handlers.KTPS=function(t,e){var i=vec3.create();i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096;var s=vec3.create();return s[0]=t.getInt32(e+12,!0)/4096,s[1]=t.getInt32(e+16,!0)/4096,s[2]=t.getInt32(e+20,!0)/4096,{pos:i,angle:s,id1:t.getInt16(e+24,!0),id2:t.getInt16(e+26,!0),nextOff:e+28}},this.handlers.KTPJ=function(t,e){var i=vec3.create();i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096;var s=vec3.create();return s[0]=t.getInt32(e+12,!0)/4096,s[1]=t.getInt32(e+16,!0)/4096,s[2]=t.getInt32(e+20,!0)/4096,{pos:i,angle:s,id1:t.getInt16(e+24,!0),id2:t.getInt16(e+26,!0),respawnID:t.getInt32(e+28,!0),nextOff:e+28+4}},this.handlers.CPOI=function(t,e){return{x1:t.getInt32(e,!0)/4096,z1:t.getInt32(e+4,!0)/4096,x2:t.getInt32(e+8,!0)/4096,z2:t.getInt32(e+12,!0)/4096,sinus:t.getInt32(e+16,!0)/4096,cosinus:t.getInt32(e+20,!0)/4096,distance:t.getInt32(e+24,!0)/4096,nextSection:t.getInt16(e+28,!0),currentSection:t.getInt16(e+30,!0),keyPoint:t.getInt16(e+32,!0),respawn:t.getUint8(e+34),unknown:t.getUint8(e+35),nextOff:e+36}},this.handlers.CPAT=function(t,e){var i=t.getInt16(e,!0),s=t.getInt16(e+2,!0),a=[t.getInt8(e+4)],r=t.getInt8(e+5);-1!=r&&a.push(r);var n=t.getInt8(e+6);-1!=n&&a.push(n);var o=[t.getInt8(e+7)],h=t.getInt8(e+8);-1!=h&&o.push(h);var l=t.getInt8(e+9);return-1!=l&&o.push(l),{startInd:i,pathLen:s,dest:a,source:o,sectionOrder:t.getInt16(e+10,!0),nextOff:e+12}},this.handlers.MEPA=function(t,e){for(var i=t.getInt16(e,!0),s=t.getInt16(e+2,!0),a=[],r=e+4,n=0;n<8;n++)-1!=(h=t.getInt8(r++))&&a.push(h);var o=[];for(n=0;n<8;n++){var h;-1!=(h=t.getInt8(r++))&&o.push(h)}return{startInd:i,pathLen:s,dest:a,source:o,nextOff:r}},this.handlers.IPOI=function(t,e){var i=vec3.create();return i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096,{pos:i,unknown1:t.getUint8(e+12),unknown2:t.getUint8(e+13),unknown3:t.getUint8(e+14),unknown4:t.getUint8(e+15),unknown5:t.getUint32(e+16,!0),nextOff:e+20}},this.handlers.EPOI=function(t,e){var i=vec3.create();return i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096,{pos:i,pointSize:t.getInt32(e+12,!0)/4096,cpuDrift:t.getUint16(e+16,!0),unknown1:t.getUint16(e+18,!0),unknown2:t.getUint32(e+20,!0),nextOff:e+24}},this.handlers.MEPO=function(t,e){var i=vec3.create();return i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096,{pos:i,pointSize:t.getInt32(e+12,!0)/4096,cpuDrift:t.getUint16(e+16,!0),unknown1:t.getUint16(e+18,!0),unknown2:t.getUint32(e+20,!0),nextOff:e+24}},this.handlers.AREA=function(t,e){var i=vec3.create();i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096;var s=vec3.create();return s[0]=t.getInt32(e+12,!0)/4096,s[1]=t.getInt32(e+16,!0)/4096,s[2]=t.getInt32(e+20,!0)/4096,{pos:i,dimensions:s,came:t.getUint8(e+67),one:t.getUint32(e+68,!0),nextOff:e+72}},this.handlers.CAME=function(t,e){var i=vec3.create();i[0]=t.getInt32(e,!0)/4096,i[1]=t.getInt32(e+4,!0)/4096,i[2]=t.getInt32(e+8,!0)/4096;var s=vec3.create();s[0]=t.getInt32(e+12,!0)/4096,s[1]=t.getInt32(e+16,!0)/4096,s[2]=t.getInt32(e+20,!0)/4096;var a=vec3.create();a[0]=t.getInt32(e+24,!0)/4096,a[1]=t.getInt32(e+28,!0)/4096,a[2]=t.getInt32(e+32,!0)/4096;var r=vec3.create();return r[0]=t.getInt32(e+36,!0)/4096,r[1]=t.getInt32(e+40,!0)/4096,r[2]=t.getInt32(e+44,!0)/4096,{pos1:i,pos2:a,pos3:r,angle:s,zoomSpeedM1:t.getInt16(e+48,!0)/4096,zoomStart:t.getInt16(e+50,!0)/4096,zoomEnd:t.getInt16(e+52,!0)/4096,zoomSpeedM2:t.getInt16(e+54,!0)/4096,zoomMark1:t.getInt16(e+56,!0)/4096,zoomMark2:t.getInt16(e+58,!0)/4096,zoomSpeed:t.getInt16(e+60,!0)/4096,camType:t.getInt16(e+62,!0),camRoute:t.getInt16(e+64,!0),routeSpeed:t.getInt16(e+66,!0),pointSpeed:t.getInt16(e+68,!0),duration:t.getInt16(e+70,!0),nextCam:t.getInt16(e+72,!0),firstCam:t.getUint8(e+74),one:t.getUint8(e+75),nextOff:e+76}},this.handlers.KTP2=this.handlers.KTPS,this.handlers.KTPC=this.handlers.KTPS,this.handlers.KTPM=this.handlers.KTPS,this.handlers.IPAT=this.handlers.CPAT,this.handlers.EPAT=this.handlers.CPAT,null!=this.input)if("string"==typeof this.input){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",this.input,!0),i.onload=function(){e.load(i.response)},i.send()}else this.load(this.input)}return t.prototype.load=function(t){var i=new DataView(t);this.stamp=e.asciireadChar(i,0)+e.asciireadChar(i,1)+e.asciireadChar(i,2)+e.asciireadChar(i,3),this.version=i.getUint16(4,!0);var s=i.getUint16(6,!0),a=8;this.sections={OBJI:void 0,PATH:void 0,POIT:void 0,KTPS:void 0,KTPJ:void 0,CPOI:void 0,CPAT:void 0,MEPA:void 0,IPOI:void 0,EPOI:void 0,MEPO:void 0,AREA:void 0,CAME:void 0,KTP2:void 0,KTPC:void 0,KTPM:void 0,IPAT:void 0,EPAT:void 0};for(var r=0;r<(s-8)/4;r++){var n=i.getUint32(a,!0),o=this._readSection(i,n+s);if(Object.prototype.hasOwnProperty.call(this.sections,o.type)){var h=o.type;this.sections[h]=o}a+=4}},t.prototype._readSTAG=function(t,e){return{courseID:t.getUint16(e+4,!0),laps:t.getUint16(e+6,!0),unknown:t.getUint8(e+8),fogEnable:t.getUint8(e+9),fogMode:t.getUint8(e+10),fogSlope:t.getUint8(e+11),fogDist:t.getInt32(e+20,!0)/4096,fogCol:this._readRGB(t,e+24),fogAlpha:t.getUint16(e+26,!0),kclCol:[this._readRGB(t,e+28),this._readRGB(t,e+30),this._readRGB(t,e+32),this._readRGB(t,e+34)]}},t.prototype._readSection=function(t,i){var s=e.asciireadChar(t,i+0)+e.asciireadChar(t,i+1)+e.asciireadChar(t,i+2)+e.asciireadChar(t,i+3);if("STAG"==s){var a=this._readSTAG(t,i);return K({type:s},a)}var r=this.handlers[s],n={type:s,entries:[]};if(null==r)return console.error("Unknown NKM section type "+s+"!"),n;var o=t.getUint32(i+4,!0);i+=8;for(var h=0;h<o;h++){var l=r(t,i);n.entries.push(l),i=l.nextOff}return n},t.prototype._readRGB=function(t,e){var i=t.getUint16(e,!0);return[31&i,i>>5&31,i>>10&31]},t}(),G=function(){function t(t){this.input=t,this.mainOff=void 0,this.animData=void 0,null!=this.input&&this.load(this.input)}return t.prototype.load=function(t){var s,a,r=this,n=new DataView(t);if("BTA0"!=(s=i.readHeader(n)).stamp)throw"NSBTA invalid. Expected BTA0, found "+s.stamp;if(s.numSections>1)throw"NSBTA invalid. Too many sections - should have 1 maximum.";a=s.sectionOffsets[0],this.mainOff=a;var o=e.asciireadChar(n,a+0)+e.asciireadChar(n,a+1)+e.asciireadChar(n,a+2)+e.asciireadChar(n,a+3);if("SRT0"!=o)throw"NSBTA invalid. Expected SRT0, found "+o;this.animData=i.read3dInfo(n,this.mainOff+8,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r._animInfoHandler(t[0],t[1])}))},t.prototype._animInfoHandler=function(t,e){var i=t.getUint32(e,!0),s=this.mainOff+i,a=this._readAnimData(t,s);return a.nextoff=e+4,a},t.prototype._readAnimData=function(t,s){var a=this,r=(e.asciireadChar(t,s+0),e.asciireadChar(t,s+1),e.asciireadChar(t,s+2),e.asciireadChar(t,s+3),t.getUint16(s+4,!0),t.getUint8(s+6),t.getUint8(s+7),i.read3dInfo(t,s+8,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return a._matInfoHandler(t[0],t[1],t[2])})));return{data:r,nextoff:r.nextoff}},t.prototype._matInfoHandler=function(t,e,i){var s=[],a=[],r={scaleS:void 0,scaleT:void 0,rotation:void 0,translateS:void 0,translateT:void 0},n={scaleS:[],scaleT:[],rotation:[],translateS:[],translateT:[]},o=0;for(var h in r){var l=t.getUint16(e,!0),c=t.getUint16(e+2,!0),d=t.getUint16(e+4,!0),u=t.getInt16(e+6,!0)/4096;if(r[h]=c>>14,s[o]=c,a[o]=l,8192&c)32768&d&&(d=65536-d),n[h].push(d/4096),2==o&&n[h].push(u);else{l>>=r[h],r[h]>0&&l++;for(var m=i+d-8,f=l*(2==o?2:1),p=0;p<f;p++)t.getInt16(m-2,!0),n[h].push(t.getInt16(m,!0)/4096),m+=2}e+=8,o++}return{flags:s,frames:a,scaleS:n.scaleS,scaleT:n.scaleT,rotation:n.rotation,translateS:n.translateS,translateT:n.translateT,frameStep:{scaleS:r.scaleS,scaleT:r.scaleT,rotation:r.rotation,translateS:r.translateS,translateT:r.translateT},nextoff:e}},t}(),X=function(){function t(t,e){var i=this;if(this.input=t,this.mkwii=e,this.vertexOffset=void 0,this.normalOffset=void 0,this.planeOffset=void 0,this.octreeOffset=void 0,this.unknown1=void 0,this.topLeftVec=void 0,this.xMask=void 0,this.yMask=void 0,this.zMask=void 0,this.coordShift=void 0,this.yShift=void 0,this.zShift=void 0,this.unknown2=void 0,this.trisMapped=0,this.planes=void 0,this.octree=void 0,this.end=void 0,this.mkwiiMode=void 0,this.sf=void 0,this.mouseX=0,this.mouseY=0,this.offx=void 0,this.offz=void 0,this.loaded=!1,this.Fixed32Point=4096,null!=this.input)if("string"==typeof this.input){var s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",this.input,!0),s.onload=function(){i.load(s.response,!1)},s.send()}else this.load(this.input,this.mkwii)}return t.prototype.load=function(t,e){null==e&&(e=!1),this.end=!e,this.mkwiiMode=e,Date.now();var i=new DataView(t);this.vertexOffset=i.getUint32(0,this.end),this.normalOffset=i.getUint32(4,this.end),this.planeOffset=i.getUint32(8,this.end),this.octreeOffset=i.getUint32(12,this.end),this.unknown1=this._readBigDec(i,16,e);var s=vec3.create();s[0]=this._readBigDec(i,20,e),s[1]=this._readBigDec(i,24,e),s[2]=this._readBigDec(i,28,e),this.topLeftVec=s,this.xMask=i.getUint32(32,this.end),this.yMask=i.getUint32(36,this.end),this.zMask=i.getUint32(40,this.end),this.coordShift=i.getUint32(44,this.end),this.yShift=i.getUint32(48,this.end),this.zShift=i.getUint32(52,this.end),this.unknown2=this._readBigDec(i,56,e);var a=this.planeOffset+16;this.planes=[null];for(var r=0,n=0,o=0,h=0;a<this.octreeOffset;){var l=this._readPlane(i,a);this.planes.push(l),a+=16;var c=this.planes[this.planes.length-1].Vertices[0];c[0]<r&&(r=c[0]),c[0]>n&&(n=c[0]),c[2]<o&&(o=c[2]),c[2]>h&&(h=c[2])}this.octree=[];for(var d=(1+(~this.xMask>>this.coordShift))*(1+(~this.yMask>>this.coordShift))*(1+(~this.zMask>>this.coordShift)),u=0;u<d;u++){var m=this.octreeOffset+4*u;this.octree.push(this._decodeCube(this.octreeOffset,m,i))}this.loaded=!0},t.prototype.getPlanesAt=function(t,e,i){if(t-=this.topLeftVec[0],e-=this.topLeftVec[1],i-=this.topLeftVec[2],t<0||e<0||i<0)return[];if(t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),(t&this.xMask)>0||(e&this.yMask)>0||(i&this.zMask)>0)return[];var s=t>>this.coordShift|e>>this.coordShift<<this.yShift|i>>this.coordShift<<this.zShift;return this._traverseOctree(this.octree[s],t,e,i,this.coordShift-1)},t.prototype._readBigDec=function(t,e,i){return i?t.getFloat32(e):t.getInt32(e,this.end)/this.Fixed32Point},t.prototype._traverseOctree=function(t,e,i,s,a){if(!1===t.leaf){var r=e>>a&1|(i>>a&1)<<1|(s>>a&1)<<2;return this._traverseOctree(t.items[r],e,i,s,a-1)}return t.realTris},t.prototype._decodeCube=function(t,e,i){var s=i.getUint32(e,this.end),a=t+(2147483647&s);if(a>=i.byteLength)return{leaf:!0,tris:[],realTris:[]};if(2147483648&s){a+=2;for(var r=[],n=[];;){var o=i.getUint16(a,this.end);if(0==o)break;r.push(o),n.push(this.planes[o]),this.trisMapped+=1,a+=2}return{leaf:!0,tris:r,realTris:n}}for(var h=[],l=a,c=0;c<8;c++)h.push(this._decodeCube(l,a,i)),a+=4;return{leaf:!1,items:h}},t.prototype._readPlane=function(t,e){var i=this._readBigDec(t,e,this.mkwiiMode),s=this._readNormal(t.getUint16(e+6,this.end),t),a=this._readNormal(t.getUint16(e+8,this.end),t),r=this._readNormal(t.getUint16(e+10,this.end),t),n=this._readNormal(t.getUint16(e+12,this.end),t),o=t.getUint16(e+14,this.end),h=vec3.cross(vec3.create(),a,s),l=vec3.cross(vec3.create(),r,s),c=this._readVert(t.getUint16(e+4,this.end),t);return{Len:i,Vertices:[c,vec3.scaleAndAdd(vec3.create(),c,l,i/vec3.dot(l,n)),vec3.scaleAndAdd(vec3.create(),c,h,i/vec3.dot(h,n))],Normal:s,NormalA:a,NormalB:r,NormalC:n,CollisionType:o}},t.prototype._readVert=function(t,e){var i=vec3.create(),s=this.vertexOffset+12*t;return i[0]=this._readBigDec(e,s,this.mkwiiMode),i[1]=this._readBigDec(e,s+4,this.mkwiiMode),i[2]=this._readBigDec(e,s+8,this.mkwiiMode),i},t.prototype._readNormal=function(t,e){var i=this.mkwiiMode,s=vec3.create();if(i){var a=this.normalOffset+12*t;s[0]=e.getFloat32(a),s[1]=e.getFloat32(a+4),s[2]=e.getFloat32(a+8)}else a=this.normalOffset+6*t,s[0]=e.getInt16(a,this.end)/4096,s[1]=e.getInt16(a+2,this.end)/4096,s[2]=e.getInt16(a+4,this.end)/4096;return s},t}(),Y=function(){function t(){}return t.saveKart=function(e,i,s){t._saveVec3(e,i,s.pos),t._saveVec3(e,i+12,s.vel),e.setFloat32(i+24,s.angle,!0),e.setFloat32(i+28,s.physicalDir,!0),e.setFloat32(i+32,s.driftOff,!0),null!=s.cannon?e.setUint16(i+36,s.cannon,!0):e.setUint16(i+36,65535,!0),e.setUint16(i+38,s.airTime,!0),e.setUint16(i+40,s._lastCollided,!0),e.setUint8(i+42,s.boostMT),e.setUint8(i+43,s.boostNorm),e.setUint8(i+46,s._wheelTurn),t.saveVec3(e,i+48,s.kartColVel),e.setUint8(i+60,s.kartColTimer),t.saveVec3(e,i+61,s.kartTargetNormal),t.saveVec3(e,i+73,s.trackAttach);var a=(s.drifting?1:0)|s.driftMode<<1|(s.driftLanded?8:0);e.setUint8(i+85,a),e.setUint8(i+86,t.animNames.indexOf(s.animMode));var r=(input.accel?1:0)|(input.decel?2:0)|(input.drift?4:0);e.setUint8(i+87,r),e.setFloat32(i+88,input.turn,!0),e.setFloat32(i+92,input.airTurn,!0)},t.saveVec3=function(t,e,i){throw new Error("Method not implemented.")},t.restoreKart=function(e,i,s){try{s.pos=t.readVec3(e,i,s.pos),s.vel=t.readVec3(e,i+12,s.vel),s.angle=e.getFloat32(i+24,!0),s.physicalDir=e.getFloat32(i+28,!0),s.driftOff=e.getFloat32(i+32,!0),s.cannon=e.getUint16(i+36,!0),65535==s.cannon&&(s.cannon=null),s.airTime=e.getUint16(i+38,!0),s._lastCollided=e.getUint16(i+40,!0),s.boostMT=e.getUint8(i+42),s.boostNorm=e.getUint8(i+43),s._wheelTurn=e.getUint8(i+46),s.kartColVel=t.readVec3(e,i+48,s.kartColVel),s.kartColTimer=e.getUint8(i+60),s.kartTargetNormal=t.readVec3(e,i+61,s.kartTargetNormal),e.getUint8(i+85),s.animMode=t.animNames[e.getUint8(i+86)]}catch(t){console.error("Kart restore failure:"+t.message)}},t.readVec3=function(t,e,i){throw new Error("Method not implemented.")},t._saveVec3=function(t,e,i){null==i&&(i=[NaN,NaN,NaN]),t.setFloat32(e,i[0],!0),t.setFloat32(e+4,i[1],!0),t.setFloat32(e+8,i[2],!0)},t._readVec3=function(t,e,i){var s=t.getFloat32(e,!0);return isNaN(s)?null:((i=vec3.create())[0]=s,i[1]=t.getFloat32(e+4,!0),i[2]=t.getFloat32(e+8,!0),i)},t.animNames=["drive","win","lose","spin"],t}(),q=function(){function t(t,e){this.bmd=t,this.bca=e,this.matBufEmpty=new Float32Array(496);var i=mat4.create();this.off=0,this.objMats=[];for(var s=0;s<31;s++)this.matBufEmpty.set(i,this.off),this.objMats.push(mat4.create()),this.off+=16;this.matBuf=new Float32Array(496),this.matStack={built:!0,dat:this.matBuf}}return t.prototype.setAnim=function(t){this.bca=t},t.prototype.getLength=function(t){return this.bca.animData.objectData[t].frames},t.prototype.getFrames=function(t,e,i,s){var a=Math.max(0,(Math.min(i,t.endFrame)-t.startFrame)*t.speed),r=Math.floor((t.endFrame-t.startFrame)*t.speed),n=Math.min(e-1,r);return[Math.min(n,Math.floor(a)),Math.min(n,Math.ceil(a)),a%1]},t.prototype.setFrame=function(t,e,i){var s=this.bca.animData.objectData[t],a=this.getLength(t);i%=this.getLength(t),Math.floor(i),Math.ceil(i);for(var r=this.bmd.modelData.objectData[e],n=r.objects.objectData,o=0;o<s.trans.length;o++){var h=this.objMats[o];mat4.identity(h);var l,c,d,u,m=s.trans[o],f=n[o];if(null!=m.translate){if(l=[0,0,0],null!=m.tlExtra[0]){var p=(u=this.getFrames(m.tlExtra[0],m.translate[0].length,i,a))[2];l[0]=m.translate[0][u[0]]*(1-p)+m.translate[0][u[1]]*p}else l[0]=m.translate[0][0];null!=m.tlExtra[1]?(p=(u=this.getFrames(m.tlExtra[1],m.translate[1].length,i,a))[2],l[1]=m.translate[1][u[0]]*(1-p)+m.translate[1][u[1]]*p):l[1]=m.translate[1][0],null!=m.tlExtra[2]?(p=(u=this.getFrames(m.tlExtra[2],m.translate[2].length,i,a))[2],l[2]=m.translate[2][u[0]]*(1-p)+m.translate[2][u[1]]*p):l[2]=m.translate[2][0]}else l=f.translate;if(null!=m.rotate)if(null!=m.rotExtra){p=(u=this.getFrames(m.rotExtra,m.rotate.length,i,a))[2];var v=this.parseRotation(m.rotate[u[0]]),_=this.parseRotation(m.rotate[u[1]]);c=this.lerpMat3(v,_,p)}else c=this.parseRotation(m.rotate[0]);else c=f.pivot;if(null!=m.scale)if(d=[0,0,0],null!=m.scExtra[0]?(p=(u=this.getFrames(m.scExtra[0],m.scale[0].length,i,a))[2],d[0]=m.scale[0][u[0]].s1*(1-p)+m.scale[0][u[1]].s1*p):d[0]=m.scale[0][0].s1,null!=m.scExtra[1]?(p=(u=this.getFrames(m.scExtra[1],m.scale[1].length,i,a))[2],d[1]=m.scale[1][u[0]].s1*(1-p)+m.scale[1][u[1]].s1*p):d[1]=m.scale[1][0].s1,null!=m.scExtra[2])p=(u=this.getFrames(m.scExtra[2],m.scale[2].length,i,a))[2],d[2]=m.scale[2][u[0]].s1*(1-p)+m.scale[2][u[1]].s1*p;else d[2]=m.scale[2][0].s1;else d=f.scale;mat4.translate(h,h,l),mat4.multiply(h,h,this.mat4FromMat3(c)),mat4.scale(h,h,d)}return this.generateMatrixStack(r,this.matBuf),this.matStack},t.prototype.generateMatrixStack=function(t,e){for(var i=[],s=t.objects.objectData,a=t.commands,r=mat4.create(),n=0,o=-1,h=0;h<a.length;h++){var l=a[h];if(null==l.copy){null!=l.restoreID&&(r=mat4.clone(i[l.restoreID]));var c=s[l.obj];mat4.multiply(r,r,this.objMats[l.obj]),1==c.billboardMode&&mat4.multiply(r,r,_.billboardMat),2==c.billboardMode&&mat4.multiply(r,r,_.yBillboardMat),null!=l.stackID?(i[l.stackID]=mat4.clone(r),(n=l.stackID)>o&&(o=n)):i[n]=mat4.clone(r)}else i[l.dest]=mat4.clone(i[l.copy])}t.lastStackID=n;var d=vec3.clone([t.head.scale,t.head.scale,t.head.scale]);e.set(this.matBufEmpty);var u=0;for(h=0;h<=o;h++)null!=i[h]&&(mat4.scale(i[h],i[h],d),e.set(i[h],u)),u+=16;return e},t.prototype.mat4FromMat3=function(t){var e=mat4.create();return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.prototype.parseRotation=function(t){if(!0===t.pivot){var e=t.param,i=mat3.clone([0,0,0,0,0,0,0,0,0]),s=15&e,a=e>>4&15,r=t.a,n=t.b;i[s]=1&a?-1:1;var o=s%3,h=Math.floor(s/3),l=0==o?1:0,c=3*(0==h?1:0),d=2==o?1:2,u=3*(2==h?1:2);return i[l+c]=r,i[d+c]=n,i[l+u]=2&a?-n:n,i[d+u]=4&a?-r:r,i}return t.mat},t.prototype.lerpMat3=function(t,e,i){var s=1-i;return[t[0]*s+e[0]*i,t[1]*s+e[1]*i,t[2]*s+e[2]*i,t[3]*s+e[3]*i,t[4]*s+e[4]*i,t[5]*s+e[5]*i,t[6]*s+e[6]*i,t[7]*s+e[7]*i,t[8]*s+e[8]*i]},t}(),$=function(){function t(){}return t.init=function(e){var i=t._getShader(t._shadFrag,"frag"),s=t._getShader(t._shadVert,"vert");t._shadowShader=e.createProgram(),e.attachShader(t._shadowShader,s),e.attachShader(t._shadowShader,i),e.linkProgram(t._shadowShader),e.getProgramParameter(t._shadowShader,e.LINK_STATUS)||alert("Could not initialise shaders"),t._vertexPositionAttribute=e.getAttribLocation(t._shadowShader,"aVertexPosition"),e.enableVertexAttribArray(t._vertexPositionAttribute),t.textureCoordAttribute=e.getAttribLocation(t._shadowShader,"aTextureCoord"),e.enableVertexAttribArray(t.textureCoordAttribute),t.colTexUniform=e.getUniformLocation(t._shadowShader,"cSampler"),t.depTexUniform=e.getUniformLocation(t._shadowShader,"depSampler"),t.lightTexUniform=e.getUniformLocation(t._shadowShader,"lightDSampler"),t.lightFarTexUniform=e.getUniformLocation(t._shadowShader,"farLightDSampler"),t.lightViewUniform=e.getUniformLocation(t._shadowShader,"shadowMat"),t.lightFarViewUniform=e.getUniformLocation(t._shadowShader,"farShadowMat"),t.camViewUniform=e.getUniformLocation(t._shadowShader,"invViewProj"),this._shadowShader=t._shadowShader,t._vecPosBuffer=e.createBuffer(),t._vecTxBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t._vecPosBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,-1,0,1,1,0,1,1,0,-1,1,0,-1,-1,0]),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,t._vecTxBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,1,1,0,1,0,0]),e.STATIC_DRAW)},t._getShader=function(t,e){var i;if("frag"==e)i=gl.createShader(gl.FRAGMENT_SHADER);else{if("vert"!=e)return null;i=gl.createShader(gl.VERTEX_SHADER)}return gl.shaderSource(i,t),gl.compileShader(i),gl.getShaderParameter(i,gl.COMPILE_STATUS)?i:(alert(gl.getShaderInfoLog(i)),null)},t.drawShadowed=function(e,i,s,a,r,n,o){gl.useProgram(t._shadowShader),gl.uniformMatrix4fv(t.lightViewUniform,!1,n),gl.uniformMatrix4fv(t.lightFarViewUniform,!1,o),gl.uniformMatrix4fv(t.camViewUniform,!1,mat4.invert(mat4.create(),r)),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,s),gl.uniform1i(t.lightTexUniform,0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,e),gl.uniform1i(t.colTexUniform,1),gl.activeTexture(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,i),gl.uniform1i(t.depTexUniform,2),gl.activeTexture(gl.TEXTURE3),gl.bindTexture(gl.TEXTURE_2D,a),gl.uniform1i(t.lightFarTexUniform,3),gl.bindBuffer(gl.ARRAY_BUFFER,t._vecPosBuffer),gl.vertexAttribPointer(t._vertexPositionAttribute,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,t._vecTxBuffer),gl.vertexAttribPointer(t.textureCoordAttribute,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLES,0,6)},t._shadFrag="\n\tprecision highp float;\n\t\n\tvarying vec2 vTextureCoord;\n\tvarying vec4 color;\n\t\n\tuniform sampler2D cSampler;\n\tuniform sampler2D depSampler;\n\tuniform sampler2D lightDSampler;\n\tuniform sampler2D farLightDSampler;\n\t\n\tuniform mat4 shadowMat;\n\tuniform mat4 farShadowMat;\n\tuniform mat4 invViewProj;\n\t\n\t\n\tvec3 positionFromDepth(vec2 vTex)\n\t{\n        float z = texture2D(depSampler, vTex).r * 2.0 - 1.0;\n        float x = vTex.x * 2.0 - 1.0;\n        float y = vTex.y * 2.0 - 1.0;\n        vec4 vProjectedPos = vec4(x, y, z, 1.0);\n\t\t\n        // Transform by the inverse projection matrix\n        vec4 vPositionVS = invViewProj*vProjectedPos;\n\t\t\n        // Divide by w to get the view-space position\n        return vPositionVS.xyz/vPositionVS.w;\n\t}\n\t\n\tvoid main(void) {\n\t\tvec3 pos = positionFromDepth(vTextureCoord);\n\t\tvec4 col = texture2D(cSampler, vTextureCoord);\n\t\t\n\t\tvec4 lightDist = (shadowMat*vec4(pos, 1.0) + vec4(1, 1, 1, 0)) / 2.0;\n\t\tif (lightDist.x<0.0 || lightDist.y<0.0 || lightDist.x>1.0 || lightDist.y>1.0) {\n\t\t\tvec4 flightDist = (farShadowMat*vec4(pos, 1.0) + vec4(1, 1, 1, 0)) / 2.0;\n\t\t\tif (texture2D(farLightDSampler, flightDist.xy).r+0.0005 < flightDist.z) {\n\t\t\t\tgl_FragColor = col*vec4(0.5, 0.5, 0.7, 1);\n\t\t\t} else {\n\t\t\t\tgl_FragColor = col;\n\t\t\t}\n\t\t} else {\n\t\t\t\n\t\t\tif (texture2D(lightDSampler, lightDist.xy).r+0.00005 < lightDist.z) {\n\t\t\t\tgl_FragColor = col*vec4(0.5, 0.5, 0.7, 1);\n\t\t\t} else {\n\t\t\t\tgl_FragColor = col;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (gl_FragColor.a == 0.0) discard;\n\t}\n\t",t._shadVert="\n\tattribute vec3 aVertexPosition;\n\tattribute vec2 aTextureCoord;\n\t\n\tvarying vec2 vTextureCoord;\n\t\n\tvoid main(void) {\n\t\tgl_Position = vec4(aVertexPosition, 1.0);\n\t\tvTextureCoord = vec3(aTextureCoord, 1.0).xy;\n\t}\n\t",t._shadowShader=null,t._vecPosBuffer=null,t._vecTxBuffer=null,t._vertexPositionAttribute=null,t.textureCoordAttribute=null,t}(),Z=function(){function t(t){this.scene=t,this.transparent=!1,this.pos=vec3.clone([0,0,0]),this.mat=mat4.create(),this.proj=mat4.create(),this.param=[-128,128,-96,96].map((function(t){return t/1024})),this.buildOrtho(_.getViewWidth(),_.getViewHeight()),this.lastWidth=0;var e=this.scene.gameRes.Race.getFile("count.nsbmd"),i=this.scene.gameRes.Race.getFile("count.nsbca"),s=this.scene.gameRes.Race.getFile("count.nsbtp");this.bmd=new f(e),this.bca=new u(i),this.btp=new z(s),this.anim=new q(this.bmd,this.bca),this.length=3*this.anim.getLength(0),this.animFrame=0,this.animMat=this.anim.setFrame(0,0,this.animFrame),this.model=new g(this.bmd,null),this.model.loadTexPAnim(this.btp)}return t.prototype.buildOrtho=function(t,e){this.lastWidth=t;var i=t/e,s=(this.param[3]-this.param[2])*i/2;mat4.ortho(this.proj,-s,s,this.param[2],this.param[3],-.001,10)},t.prototype.draw=function(t){if(!(_.flagShadow||this.animFrame<0)){var e=_.getViewWidth();e!=this.lastWidth&&this.buildOrtho(e,_.getViewHeight()),mat4.translate(this.mat,t,this.pos),_.pauseShadowMode(),this.model.draw(this.mat,this.proj,this.animMat),_.unpauseShadowMode()}},t.prototype.update=function(){null!=this.anim&&(this.model.setFrame(this.animFrame),this.animMat=this.anim.setFrame(0,0,Math.max(0,this.animFrame++))),this.animFrame>this.length&&this.scene.removeEntity(this)},t}(),J=function(){function t(t){this.scene=t,this.pos=vec3.clone([0,0,0]),this.mat=mat4.create(),this.proj=mat4.create(),this.param=[-128,128,-96,96].map((function(t){return t/1024})),this.buildOrtho(_.getViewWidth(),_.getViewHeight()),this.lastWidth=0;var e=this.scene.gameRes.RaceLoc.getFile("goal.nsbmd"),i=this.scene.gameRes.Race.getFile("goal.nsbca");this.bmd=new f(e),this.bca=new u(i),this.anim=new q(this.bmd,this.bca),this.length=this.anim.getLength(0),this.animFrame=0,this.animMat=this.anim.setFrame(0,0,this.animFrame),this.model=new g(this.bmd,null)}return t.prototype.buildOrtho=function(t,e){this.lastWidth=t;var i=t/e,s=(this.param[3]-this.param[2])*i/2;mat4.ortho(this.proj,-s,s,this.param[2],this.param[3],-.001,10)},t.prototype.draw=function(t){if(!(_.flagShadow||this.animFrame<0)){var e=_.getViewWidth();e!=this.lastWidth&&this.buildOrtho(e,_.getViewHeight()),mat4.translate(this.mat,t,this.pos),_.pauseShadowMode(),this.model.draw(this.mat,this.proj,this.animMat),_.unpauseShadowMode()}},t.prototype.update=function(){null!=this.anim&&(this.model.setFrame(this.animFrame),this.animMat=this.anim.setFrame(0,0,Math.max(0,this.animFrame++))),this.animFrame>this.length&&this.scene.removeEntity(this)},t}(),Q=function(){function e(e,i){this.scene=e,this.kart=i,this.transparent=!1,this.zoom=1.3,this.pos={x:10,y:10},this.buildOrtho(_.getViewWidth(),_.getViewHeight()),this.lastWidth=0;var n=this.scene.gameRes.RaceLoc.getFile("race_m_o.NCGR"),o=this.scene.gameRes.Race.getFile("race_m_o.NCLR"),h=this.scene.gameRes.Race.getFile("race_m.NCER");this.ncgr=new a(n),this.nclr=new r(o),this.ncer=new s(h),this.flattener=new t(this.nclr,this.ncgr,this.ncer),this.flattener.pos[2]=.1,this.flattener2=new t(this.nclr,this.ncgr,this.ncer),this.flattener2.pos[2]=.2,this.lap=0,this.assets=[],3===C.MAX_LAP?this.assets.push({padding:10,texture:this.flattener2.loadTextue(38)}):this.assets.push({padding:10,texture:this.flattener2.loadTextue(39)}),this.assets.push({padding:85,texture:this.flattener2.loadTextue(32)})}return e.prototype.buildOrtho=function(t,e){this.lastWidth=t,this.pos.x=t-30},e.prototype.draw=function(){if(!(_.flagShadow||this.animFrame<0)){var t=_.getViewWidth();t!=this.lastWidth&&this.buildOrtho(t,_.getViewHeight()),_.pauseShadowMode(),this.flattener.draw(this.pos.x-20,this.pos.y,1);for(var e=0;e<this.assets.length;e++)this.flattener2.drawTexture(this.assets[e].texture,this.assets[e].texture.width,this.assets[e].texture.height,this.pos.x-this.assets[e].padding,this.pos.y);_.unpauseShadowMode()}},e.prototype.update=function(){var t=this.kart.lapNumber<C.MAX_LAP?this.kart.lapNumber:C.MAX_LAP;t!=this.lap&&(this.lap=t,this.flattener.loadTextue(32+this.lap))},e}(),tt=function(){function e(e,i){this.scene=e,this.kart=i,this.transparent=!1,this.zoom=1,this.pos={x:10,y:0},this.buildOrtho(_.getViewWidth(),_.getViewHeight()),this.lastWidth=0;var n=this.scene.gameRes.RaceLoc.getFile("race_m_o.NCGR"),o=this.scene.gameRes.Race.getFile("race_m_o.NCLR"),h=this.scene.gameRes.Race.getFile("race_m.NCER");this.ncgr=new a(n),this.nclr=new r(o),this.ncer=new s(h),this.flattener=new t(this.nclr,this.ncgr,this.ncer),this.place=this.kart.placement}return e.prototype.buildOrtho=function(t,e){this.lastWidth=t,this.pos.y=e-50},e.prototype.draw=function(){if(!(_.flagShadow||this.animFrame<0)){var t=_.getViewWidth();t!=this.lastWidth&&this.buildOrtho(t,_.getViewHeight()),_.pauseShadowMode(),this.flattener.draw(this.pos.x,this.pos.y,this.zoom),_.unpauseShadowMode()}},e.prototype.update=function(){var t=this.kart.placement<8?this.kart.placement:8;t!=this.place&&(this.place=t,this.flattener.loadTextue(this.place-1))},e}(),et=function(){function t(t){this.scene=t,this.transparent=!1,this.pos=vec3.clone([0,0,0]),this.mat=mat4.create(),this.proj=mat4.create(),this.param=[-128,128,-96,96].map((function(t){return t/1024})),this.buildOrtho(_.getViewWidth(),_.getViewHeight()),this.lastWidth=0;var e=this.scene.gameRes.RaceLoc.getFile("start.nsbmd"),i=this.scene.gameRes.Race.getFile("start.nsbca");this.bmd=new f(e),this.bca=new u(i),this.anim=new q(this.bmd,this.bca),this.length=this.anim.getLength(0),this.animFrame=0,this.animMat=this.anim.setFrame(0,0,this.animFrame),this.model=new g(this.bmd,null)}return t.prototype.buildOrtho=function(t,e){this.lastWidth=t;var i=t/e,s=(this.param[3]-this.param[2])*i/2;mat4.ortho(this.proj,-s,s,this.param[2],this.param[3],-.001,10)},t.prototype.draw=function(t){if(!(_.flagShadow||this.animFrame<0)){var e=_.getViewWidth();e!=this.lastWidth&&this.buildOrtho(e,_.getViewHeight()),mat4.translate(this.mat,t,this.pos),_.pauseShadowMode(),this.model.draw(this.mat,this.proj,this.animMat),_.unpauseShadowMode()}},t.prototype.update=function(){null!=this.anim&&(this.model.setFrame(this.animFrame),this.animMat=this.anim.setFrame(0,0,Math.max(0,this.animFrame++))),this.animFrame>this.length&&this.scene.removeEntity(this)},t}(),it=function(){function t(t,e,i){this.scene=t,this.time=0,this.pos=vec3.clone(e.pos),this.vel=vec3.add([0,0,0],e.vel,[5*(Math.random()-.5),7*Math.random(),5*(Math.random()-.5)]),this.dirVel=[Math.random()-.5,Math.random()-.5,Math.random()-.5],this.dir=[2*Math.random()*Math.PI,2*Math.random()*Math.PI,2*Math.random()*Math.PI];var s=Math.random()+.5;this.scale=[s,s,s],this.model=i}return t.prototype.update=function(t){vec3.add(this.pos,this.pos,this.vel),vec3.add(this.vel,this.vel,[0,-.17,0]),vec3.add(this.dir,this.dir,this.dirVel),this.time++>30&&t.removeParticle(this)},t.prototype.draw=function(t,e,i){var s=mat4.translate(mat4.create(),t,this.pos);mat4.rotateZ(s,s,this.dir[2]),mat4.rotateY(s,s,this.dir[1]),mat4.rotateX(s,s,this.dir[0]),mat4.scale(s,s,vec3.scale([0,0,0],this.scale,16)),this.model.draw(s,e)},t}(),st=function(){function t(){}return t.cacheWaveArc=function(e){if(null==t.cache[e]){var i=t.sdat.sections.$INFO[3];if(null==i[e])return;var s=i[e].arc.samples;if(null==s)return;t.cache[e]=[];for(var a=0;a<s.length;a++){var r={info:s[a],buf:s[a].getAudioBuffer(t.ctx)};t.cache[e].push(r)}}},t.getWave=function(e,i){return t.cache[e][i]},t.init=function(e,i){t.cache=[],t.sdat=e,t.ctx=i},t.cache=[],t.sdat=void 0,t.ctx=void 0,t}(),at=function(){function t(t,e,i){var s=this;this._VOLMUL=1/4,this._pc=e,this._prog=t,this._player=i,this._comparisonResult=!1,this._force=!1,this._forceCommand=0,this._forceValue=0,this._forceSpecial=0,this.decay=void 0,this.buffer=10,this.wait=0,this.offT=0,this.program=0,this.pitchBendRange=1,this.pitchBend=0,this.portaKey=128,this.portaTime=0,this.sweepPitch=0,this.transpose=0,this.attack=null,this.delay=null,this.sustain=null,this.release=null,this.tie=0,this.noteWait=!0,this.loopPtr=0,this.loopTimes=0,this._ctx=this._player.ctx,this._gainL=this._ctx.createGain(),this._gainR=this._ctx.createGain(),this._gainL.gain.value=parseFloat("1"),this._gainR.gain.value=parseFloat("1"),this._merger=this._ctx.createChannelMerger(2),this._splitter=this._ctx.createChannelSplitter(2),this.pan=0,this.gain=this._player.ctx.createGain(),this.gain.connect(this._gainL),this.gain.connect(this._gainR),this.gain.gain.value=parseFloat("".concat(this._VOLMUL)),this._gainL.connect(this._merger,0,0),this._gainR.connect(this._merger,0,1),this._merger.connect(this._player.masterGain,0,0),this.lastNote=null,this.dead=!1,this.stack=[],this._InstArgs=[[this._readVariableLength],[this._readVariableLength],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[this._read8,this._read24],[this._read24],[this._read24],[],[],[],[],[],[],[],[],[],[],[this._read8,this._readSpecial,this._read16,this._read16],[this._read8,this._readSpecial],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[this._read8,this._read8],[],[],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[this._read8],[],[],[],[],[],[],[],[],[],[this._read16],[this._read16],[this._read16],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this._Instructions=[],this._Instructions[254]=function(){s._player.trackAlloc=s._read16()},this._Instructions[147]=function(){var t=s._prog[s._pc++],e=s._prog[s._pc++];e|=s._prog[s._pc++]<<8,e|=s._prog[s._pc++]<<16;var i=1<<t;!(s._player.trackStarted&i)&&s._player.trackAlloc&i&&(s._player.trackStarted|=i,s._player.startThread(e))},this._Instructions[128]=function(){var t=s._forcableValueFunc(!1,s._readVariableLength.bind(s));s.wait+=t},this._Instructions[129]=function(){var t=s._forcableValueFunc(!1,s._readVariableLength.bind(s));s.program=127&t;var e=t>>7;0!=e&&s._player.loadBank(e)},this._Instructions[148]=function(){var t=s._prog[s._pc++];t|=s._prog[s._pc++]<<8,t|=s._prog[s._pc++]<<16,s._pc=t},this._Instructions[149]=function(){var t=s._prog[s._pc++];t|=s._prog[s._pc++]<<8,t|=s._prog[s._pc++]<<16,s.stack.push(s._pc),s._pc=t},this._Instructions[253]=function(){0==s.stack.length&&s._Instructions[255].bind(s)(),s._pc=s.stack.pop()},this._Instructions[160]=function(){s._force=!0,s._forceCommand=s._prog[s._pc++],(s._forceCommand<128||s._forceCommand>=176&&s._forceCommand<=189)&&(s._forceSpecial=s._prog[s._pc++]);var t=s._reads16(),e=s._reads16();s._forceValue=Math.floor(Math.random()*(e-t+1))+t},this._Instructions[161]=function(){s._force=!0,s._forceCommand=s._prog[s._pc++],(s._forceCommand<128||s._forceCommand>=176&&s._forceCommand<=189)&&(s._forceSpecial=s._prog[s._pc++]),s._forceValue=s._player.vars[s._prog[s._pc++]]},this._varFunc=[function(t,e){s._player.vars[t]=e},function(t,e){s._player.vars[t]+=e},function(t,e){s._player.vars[t]-=e},function(t,e){s._player.vars[t]*=e},function(t,e){s._player.vars[t]=Math.floor(s._player.vars[t]/e)},function(t,e){s._player.vars[t]=e<0?s._player.vars[t]>>-e:s._player.vars[t]<<e},function(t,e){s._player.vars[t]=e<0?-Math.floor(256*Math.random())%(1-e):-Math.floor(256*Math.random())%(e+1)}],this._Instructions[176]=this._varInst,this._Instructions[177]=this._varInst,this._Instructions[178]=this._varInst,this._Instructions[179]=this._varInst,this._Instructions[180]=this._varInst,this._Instructions[181]=this._varInst,this._Instructions[182]=this._varInst,this._boolFunc=[function(t,e){return s._player.vars[t]==e},function(t,e){return s._player.vars[t]>=e},function(t,e){return s._player.vars[t]>e},function(t,e){return s._player.vars[t]<=e},function(t,e){return s._player.vars[t]<e},function(t,e){return s._player.vars[t]!=e}],this._Instructions[184]=this._boolInst,this._Instructions[185]=this._boolInst,this._Instructions[186]=this._boolInst,this._Instructions[187]=this._boolInst,this._Instructions[188]=this._boolInst,this._Instructions[189]=this._boolInst,this._Instructions[162]=function(){if(!s._comparisonResult){var t=s._prog[s._pc++];if(t<128)s._read8(),s._readVariableLength();else for(var e=s._InstArgs[t-128],i=0,a=0;a<e.length;a++)i=e[a].bind(s)(i)}},this._Instructions[192]=function(){var t=s._forcableValue();s._setPan((t-64)/64)},this._Instructions[193]=function(){var t=s._forcableValue();s.gain.gain.setValueAtTime(t/127*s._VOLMUL,s.calculateCurrentTime())},this._Instructions[194]=function(){var t=s._forcableValue();s._player.masterGain.gain.setValueAtTime(t/127,s.calculateCurrentTime())},this._Instructions[195]=function(){s.transpose=s._forcableValue(),128&s.transpose&&(s.transpose-=256)},this._Instructions[196]=function(){s.pitchBend=s._forcableValue(),128&s.pitchBend&&(s.pitchBend-=256),s.lastNote&&(s.lastNote.pitched=!0,s._player.updateNoteFreq(s,s.lastNote))},this._Instructions[197]=function(){s.pitchBendRange=s._prog[s._pc++]},this._Instructions[198]=function(){s._prog[s._pc++]},this._Instructions[199]=function(){s.noteWait=s._prog[s._pc++]>0},this._Instructions[200]=function(){s.tie=s._prog[s._pc++],null!=s.lastNote&&s._player.cutNoteShort(s,s.lastNote),s.lastNote=null},this._Instructions[201]=function(){s.portaKey=s._prog[s._pc++]},this._Instructions[202]=function(){s._forcableValue()},this._Instructions[203]=function(){s._forcableValue()},this._Instructions[204]=function(){s._prog[s._pc++]},this._Instructions[205]=function(){s._prog[s._pc++]},this._Instructions[206]=function(){s.portaKey=127&s.portaKey|+!s._prog[s._pc++]<<7},this._Instructions[207]=function(){s.portaTime=s._forcableValue()},this._Instructions[208]=function(){s.attack=s._forcableValue()},this._Instructions[209]=function(){s.decay=s._forcableValue()},this._Instructions[210]=function(){s.sustain=s._forcableValue()},this._Instructions[211]=function(){s.release=s._forcableValue()},this._Instructions[212]=function(){s.loopTimes=s._forcableValue(),s.loopPtr=s._pc},this._Instructions[252]=function(){s.loopTimes-- >0&&(s._pc=s.loopPtr)},this._Instructions[213]=function(){s._forcableValue()},this._Instructions[214]=function(){s._prog[s._pc++]},this._Instructions[224]=function(){s._prog[s._pc++],s._prog[s._pc++]},this._Instructions[225]=function(){var t=s._prog[s._pc++];t|=s._prog[s._pc++]<<8,s._player.setTempo(t)},this._Instructions[227]=function(){s.sweepPitch=s._forcableValueFunc(!1,s._reads16.bind(s))},this._Instructions[255]=function(){null!=s.lastNote&&s._player.cutNoteShort(s,s.lastNote),s._player.terminateThread(s),s.dead=!0}}return t.prototype._boolInst=function(t){var e=this._forcableValue(!0),i=this._forcableValue();128&i&&(i-=256),this._comparisonResult=this._boolFunc[t-184].bind(this)(e,i)},t.prototype._varInst=function(t){var e=this._forcableValue(!0),i=this._forcableValue();128&i&&(i-=256),180==t&&0==i||this._varFunc[t-176].bind(this)(e,i)},t.prototype.tick=function(t){this.wait-=t,this.offT=0;for(var e=0;this.wait<this.buffer&&!this.dead;){var i=this._force?this._forceCommand:this._prog[this._pc++];if(i<128)this._noteOn(i);else{if(null==this._Instructions[i])throw"bad instruction??";this._Instructions[i].bind(this)(i)}this._force&&160!=i&&161!=i&&(this._force=!1),++e>1e4&&(this._Instructions[255].bind(this)(),console.error("audio thread locked up"))}this.wait==1/0&&null!=this.lastNote&&this.lastNote.note.ended&&this._Instructions[255].bind(this)()},t.prototype._noteOn=function(t){if(0!=t){var e=this._forcableValue(!0),i=this._forcableValueFunc(!1,this._readVariableLength.bind(this));0==i&&(i=1/0),this.lastNote=this._player.playNote(this,e,i,t),this.noteWait&&(this.wait+=i)}},t.prototype._ticksToMs=function(t){return t/48*(6e4/this._player.properties.bpm)},t.prototype._readVariableLength=function(){for(var t=127&(e=this._prog[this._pc++]);128&e;){var e;t=t<<7|127&(e=this._prog[this._pc++])}return t},t.prototype.calculateCurrentTime=function(){return this._player.baseAudioTime+this._ticksToMs(this.wait-this._player.remainder)/1e3},t.prototype._read16=function(){return this._prog[this._pc++]|this._prog[this._pc++]<<8},t.prototype._reads16=function(){var t=this._read16();return 32768&t&&(t-=65536),t},t.prototype._read8=function(){return this._prog[this._pc++]},t.prototype._readSpecial=function(t){return t<128||t>=176&&t<189?this._prog[this._pc++]:0},t.prototype._read24=function(){var t=this._prog[this._pc++];return(t|=this._prog[this._pc++]<<8)|this._prog[this._pc++]<<16},t.prototype._forcableValueFunc=function(t,e){return this._force?t?this._forceSpecial:this._forceValue:e()},t.prototype._forcableValue=function(t){return this._force?t?this._forceSpecial:this._forceValue:this._prog[this._pc++]},t.prototype._setPan=function(t){this.pan=t,t>0?(this._gainR.gain.value=parseFloat("1"),this._gainL.gain.value=parseFloat("".concat(1-t))):(this._gainR.gain.value=parseFloat("".concat(1+t)),this._gainL.gain.value=parseFloat("1"))},t.prototype._noteToFreq=function(t){return 440*Math.pow(2,(t-49)/12)},t}(),rt=function(){function t(t,e,i,s,a){if(this.CYCLE_TIME=.0052,this._outputTarget=s,this.properties={bpm:120,bpmMultiplier:1,transpose:0,volume:1},null!=a)for(var r in a)if(a.hasOwnProperty(r)){var n=r;this.properties[n]=a[n]}this.ctx=i,this._sseqHead=t,this._sdat=e,this.lastNoteEnd=0,this.threads=[],this.trackAlloc=0,this.trackStarted=0,this.bank=null,this.vars=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.dead=!1,this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=parseFloat("".concat(this._sseqHead.vol*this.properties.volume/127)),this.masterGain.connect(null!=this._outputTarget?this._outputTarget:this.ctx.destination),this.startThread(this._sseqHead.pc),this.loadBank(this._sseqHead.bank),this.threadsToKill=[],this.baseAudioTime=this.ctx.currentTime,this.remainder=0,this.tick()}return t.prototype.tick=function(){var t=(this.ctx.currentTime-this.baseAudioTime)*(48*this.properties.bpm/60)+this.remainder;this.remainder=t%1,t=Math.floor(t),this.baseAudioTime=this.ctx.currentTime;for(var e=0;e<this.threads.length;e++)this.threads[e].tick(t);for(;this.threadsToKill.length>0;)this.threads.splice(this.threadsToKill.pop(),1);0==this.threads.length&&this.ctx.currentTime>this.lastNoteEnd&&(this.dead=!0)},t.prototype.startThread=function(t){var e=new at(this._sseqHead.seq.data,t,this);this.threads.push(e)},t.prototype.terminateThread=function(t){this.threadsToKill.push(this.threads.indexOf(t))},t.prototype.setTempo=function(t){this.properties.bpm=t*this.properties.bpmMultiplier},t.prototype.loadBank=function(t){if(this.bank=this._sdat.sections.$INFO[2][t],null!=this.bank)for(var e=0;e<4;e++)65535!=this.bank.waveArcs[e]&&st.cacheWaveArc(this.bank.waveArcs[e])},t.prototype.cutNoteShort=function(t,e){try{if(e.ended)return;var i=t.calculateCurrentTime(),s=i==1/0?this.ctx.currentTime:i;if(s>e.noteEndsAt)return;var a=e.relTime;e.note.gain.cancelScheduledValues(s),e.note.gain.linearRampToValueAtTime(0,s+a),e.src.stop(s+a),s+a>this.lastNoteEnd&&(this.lastNoteEnd=s+a)}catch(t){}},t.prototype.setTranspose=function(t){this.properties.transpose=t;for(var e=0;e<this.threads.length;e++){var i=this.threads[e].lastNote;null!=i&&this.updateNoteFreq(this.threads[e],i)}},t.prototype.updateNoteFreq=function(t,e){var i=(e.pitched?t.pitchBend/127*t.pitchBendRange:0)+t.transpose+this.properties.transpose;e.src.playbackRate.setValueAtTime(this._noteToFreq(e.start+i)/e.base/e.snd.info.mul,this.ctx.currentTime)},t.prototype.kill=function(){this.lastNoteEnd=0;for(var t=0;t<this.threads.length;t++){var e=this.threads[t].lastNote;null!=e&&this.cutNoteShort(this.threads[t],e),this.threads.splice(t--,1)}},t.prototype.playNote=function(t,e,i,s){if(e/=127,null!=this.bank.bank.instruments){var a=this.bank.bank.instruments[t.program];if(null==a)return null;if(null!=(a=this._getInst(a,s))){var r,n,o;t.tie&&null!=t.lastNote?(r=t.lastNote.note,n=t.lastNote.src,o=t.lastNote.snd):((r=this.ctx.createGain()).connect(t.gain),o=st.getWave(this.bank.waveArcs[a.swar],a.swav),(n=this.ctx.createBufferSource()).loop=1==o.info.bLoop,n.loopStart=o.info.loopSTime,n.loopEnd=o.buf.duration,n.buffer=o.buf,n.connect(r));var h=t.transpose+this.properties.transpose,l=t.calculateCurrentTime(),c=t.tie?1/0:this._ticksToMs(i)/1e3,d=this._noteToFreq(s+h)/a.freq/o.info.mul;if(128&t.portaKey)n.playbackRate.value=d;else{var u=t.sweepPitch+64*(t.portaKey-s);if(n.playbackRate.setValueAtTime(this._noteToFreq(t.portaKey+h)/a.freq/o.info.mul,l),0==t.portaTime&&i!=1/0)n.playbackRate.exponentialRampToValueAtTime(d,l+this._ticksToMs(i)/1e3);else{var m=t.portaTime*t.portaTime,f=this._ticksToMs(Math.abs(u)*m>>11)/1e3;n.playbackRate.exponentialRampToValueAtTime(d,l+f)}}var p=null!=t.attack?t.attack:a.attack,v=null!=t.decay?t.decay:a.decay,_=null!=t.sustain?t.sustain:a.sustainLvl,g=null!=t.release?t.release:a.release,T=this._calculateRequiredAttackCycles(this._convertAttToRate(p))*this.CYCLE_TIME,b=92544/this._convertFallToRate(v)*(1-_/127)*this.CYCLE_TIME/2,y=92544/this._convertFallToRate(g)*(_/127)*this.CYCLE_TIME/2;return t.tie&&null!=t.lastNote||(r.gain.value=0,r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(e,l+T),r.gain.linearRampToValueAtTime(e*_/127,l+T+b),n.start(l),n.onended=function(){r.ended=!0,n.disconnect()}),c!=1/0&&(l+T+b<l+c&&r.gain.linearRampToValueAtTime(e*_/127,l+c),r.gain.linearRampToValueAtTime(0,l+c+y),n.stop(l+c+y),l+c+y>this.lastNoteEnd&&(this.lastNoteEnd=l+c+y)),{src:n,base:a.freq,start:s,note:r,relTime:y,snd:o,noteEndsAt:l+c,ended:!1,pitched:!1}}}},t.prototype._calculateRequiredAttackCycles=function(t){for(var e=92544,i=0;e>0;)e=Math.floor(t*e/255),i++;return i},t.prototype._convertAttToRate=function(t){return 128&t?0:t>=111?[0,1,5,14,26,38,51,63,73,84,92,100,109,116,123,127,132,137,143][127-t]:255-t},t.prototype._convertFallToRate=function(t){return 128&t?0:127==t?65535:126==t?15360:t<50?1+(t<<1)&65535:7680/(126-t)&65535},t.prototype._noteToFreq=function(t){return 440*Math.pow(2,(t-49)/12)},t.prototype._getInst=function(t,e){switch(t.type){case 0:return null;case 1:return t;case 2:return t.entries[Math.max(t.lower,Math.min(t.upper,e))-t.lower];case 3:for(var i=0;i<t.regions.length;i++)if(e<=t.regions[i])return t.entries[i];return null}},t.prototype._ticksToMs=function(t){return t/48*(6e4/this.properties.bpm)},t}();window.AudioContext=window.AudioContext||window.webkitAudioContext;var nt=function(){function t(){}return t.init=function(e){t.ctx=new AudioContext,t.ctx=t.ctx,st.init(e,t.ctx),t.sdat=e},t.updateListener=function(e,i){var s=t.ctx.listener;null==s.positionX?(s.setPosition(e[0],e[1],e[2]),s.setOrientation(i[8],-i[9],-i[10],i[4],i[5],i[6])):(s.positionX.value=e[0],s.positionY.value=e[1],s.positionZ.value=e[2],s.forwardX.value=i[8],s.forwardY.value=-i[9],s.forwardZ.value=-i[10],s.upX.value=i[4],s.upY.value=i[5],s.upZ.value=i[6])},t.tick=function(){for(var e=0;e<t.sounds.length;e++)(i=t.sounds[e]).seq.tick(),null!=i.obj&&null!=i.obj.soundProps&&null!=i.panner&&t._updatePanner(i.panner,i.obj.soundProps);for(e=0;e<t.sounds.length;e++){var i;(i=t.sounds[e]).dead=i.seq.dead,i.dead&&(i.gainN.disconnect(),t.sounds.splice(e--,1))}},t.kill=function(t){t.killing||(t.killing=!0,t.seq.kill())},t.instaKill=function(e){if(null!=e){var i=t.sounds.indexOf(e);e.gainN.disconnect(),-1!=i&&t.sounds.splice(i,1)}},t.playSound=function(e,i,s,a){var r,n={dead:!1,killing:!1,obj:a,seq:void 0,panner:void 0,gainN:void 0};if(null!=a?(r=t.ctx.createPanner(),n.gainN=t.ctx.createGain(),n.gainN.connect(t.ctx.destination),r.connect(n.gainN),n.panner=r,null==n.obj.soundProps&&(n.obj.soundProps=a),t._updatePanner(n.panner,n.obj.soundProps)):(r=t.ctx.createGain(),n.gainN=r,r.connect(t.ctx.destination)),null==s){var o=t.sdat.sections.$INFO[0][e];if(null==o)return;n.seq=new rt(o,t.sdat,t.ctx,r,i)}else{var h=t.sdat.sections.$INFO[1][s];if(null==h)return;var l=h.arc.entries[e];if(null==l)return;n.seq=new rt(l,t.sdat,t.ctx,r,i)}return t.sounds.push(n),n},t._updatePanner=function(t,e){null!=t&&null!=e&&(null!=e.pos&&t.setPosition(e.pos[0],e.pos[1],e.pos[2]),t.refDistance=e.refDistance||192,null!=e.panningModel&&(t.panningModel=e.panningModel),t.rolloffFactor=e.rolloffFactor||1)},t.ctx=void 0,t.sounds=[],t.sdat=null,t}(),ot={DRIFT_ASPHALT:84,DRIFT_CONCRETE:85,DRIFT_EDGE:86,DRIFT_DIRT:87,DRIFT_ROAD:88,DRIFT_STONE:89,DRIFT_SAND:90,DRIFT_ICE:91,DRIFT_GLASS:92,DRIFT_WATER:93,DRIFT_BOARD:94,DRIFT_CARPET:95,DRIFT_METALGAUZE:96,DRIFT_PLASTIC:97,DRIFT_RAINBOW:99,DRIFT_MARSH:100,LAND_ASPHALT:103,LAND_SAND:104,LAND_DIRT:105,LAND_ICE:106,LAND_GRASS:107,LAND_SNOW:108,LAND_METALGAUZE:109,LAND_MARSH:110,LAND_WATER:111,LAND_WATERDEEP:112,LAND_CARPET:113,DRIVE_DIRT:114,DRIVE_GRASS:115,DRIVE_WATER:116,DRIVE_STONE:117,DRIVE_SAND:118,DRIVE_MARSH:119,DRIVE_CARPET:120,HIT_CAR:128,HIT_CONCRETE:129,HIT_FENCE:130,HIT_WOOD:131,HIT_TREE:132,HIT_BUSH:133,HIT_CLIFF:134,HIT_SIGN:135,HIT_ICE:136,HIT_SNOW:137,HIT_TABLE:138,HIT_BOUNCY:139,HIT_JELLY:140,HIT_METALGAUZE:141,HIT_METAL:142,HIT_STONE:134,HIT_RAINBOW:136,BRAKE:143,BRAKE_CONCRETE:144,BRAKE_DIRT:145,BRAKE_SAND:145,BRAKE_STONE:146,BRAKE_ICE:147,BRAKE_GLASS:148,BRAKE_WATER:149,BRAKE_BOARD:150,BRAKE_CARPET:151,BRAKE_METALGAUZE:152,BRAKE_PLASTIC:153,BRAKE_METAL:154,BRAKE_RAINBOW:155,BRAKE_MARSH:156,BRAKE_BOOST:158},ht=new Array(31);ht[0]=0,ht[2]=2,ht[3]=3,ht[5]=4,ht[1]=5,ht[6]=6,ht[7]=8,ht[18]=8,ht[17]=10,ht[19]=11;var lt,ct={drift:ot.DRIFT_WATER,brake:ot.BRAKE_WATER,land:ot.LAND_WATER,drive:ot.DRIVE_WATER,particle:30},dt={ROAD:0,OFFROADMAIN:1,OFFROAD3:2,OFFROAD2:3,RAINBOWFALL:4,OFFROAD1:5,SLIPPERY:6,BOOST:7,WALL:8,WALL2:9,OOB:10,FALL:11,JUMP_PAD:12,STICKY:13,SMALLJUMP:14,CANNON:15,WALLOOB:16,FALLSWATER:17,BOOST2:18,LOOP:19,SOUNDROAD:20,RR_SPECIAL_WALL:21,KNOCKBACK_DAMAGE:31,GROUP_ROAD:[0,5,3,2,0,6,7,12,13,14,17,18,19,20,10,1],GROUP_SOLID:[0,5,3,2,0,6,7,12,13,14,17,18,19,20,10,1,8,9,16,21,31],GROUP_WALL:[8,9,16,21,31],GROUP_BOOST:[7,18,19],GROUP_OOB:[10,11],PHYS_MAP:ht,SOUNDMAP:{0:[{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND},{drift:ot.DRIFT_STONE,brake:ot.BRAKE_STONE,land:ot.LAND_ASPHALT,drive:ot.DRIVE_STONE},{drift:ot.DRIFT_CONCRETE,brake:ot.BRAKE_CONCRETE,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_BOARD,brake:ot.BRAKE_BOARD,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_SNOW},{drift:ot.DRIFT_METALGAUZE,brake:ot.BRAKE_METALGAUZE,land:ot.LAND_METALGAUZE},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT}],1:[{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_WATER,brake:ot.BRAKE_WATER,land:ot.LAND_WATERDEEP,drive:ot.DRIVE_WATER,particle:30},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT},{},{},{}],2:[{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND},ct,{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_SNOW},{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND},{},{},{},{}],3:[{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND,particle:28},{drift:ot.DRIFT_DIRT,brake:ot.BRAKE_DIRT,land:ot.LAND_DIRT,drive:ot.DRIVE_DIRT,particle:15},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_GRASS,drive:ot.DRIVE_GRASS,particle:32},{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND,particle:40},{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND,particle:28},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_SNOW,particle:112},{},{}],5:[{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND,particle:28},{drift:ot.DRIFT_DIRT,brake:ot.BRAKE_DIRT,land:ot.LAND_DIRT,drive:ot.DRIVE_DIRT,particle:15},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_GRASS,drive:ot.DRIVE_GRASS,particle:32},{drift:ot.DRIFT_SAND,brake:ot.BRAKE_SAND,land:ot.LAND_SAND,drive:ot.DRIVE_SAND,particle:28},{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_GRASS,drive:ot.DRIVE_GRASS,particle:32},{},{},{}],6:[{drift:ot.DRIFT_ICE,brake:ot.BRAKE_ICE,land:ot.LAND_ICE},{drift:ot.DRIFT_MARSH,brake:ot.BRAKE_MARSH,land:ot.LAND_MARSH,drive:ot.DRIVE_MARSH,particle:24},{},{},{},{},{},{}],7:[{drift:ot.BRAKE_PLASTIC,brake:ot.BRAKE_PLASTIC,land:ot.LAND_ASPHALT},{drift:ot.BRAKE_PLASTIC,brake:ot.BRAKE_PLASTIC,land:ot.LAND_ASPHALT},{},{},{},{},{},{}],8:[{hit:ot.HIT_CONCRETE},{hit:ot.HIT_CLIFF},{hit:ot.HIT_SIGN},{hit:ot.HIT_WOOD},{hit:ot.HIT_BUSH},{},{hit:ot.HIT_JELLY},{hit:ot.HIT_ICE}],9:[{hit:ot.HIT_CONCRETE},{hit:ot.HIT_STONE},{hit:ot.HIT_METAL},{hit:ot.HIT_WOOD},{hit:ot.HIT_BUSH},{},{hit:ot.HIT_JELLY},{hit:ot.HIT_ICE}],16:[{hit:ot.HIT_CONCRETE},{},{},{},{},{},{},{}],21:[{hit:ot.HIT_CONCRETE},{hit:ot.HIT_STONE},{hit:ot.HIT_RAINBOW},{hit:ot.HIT_WOOD},{hit:ot.HIT_BUSH},{},{hit:ot.HIT_JELLY},{hit:ot.HIT_ICE}],17:[ct,ct,ct,ct,ct,ct,ct,ct],18:[{drift:ot.BRAKE_PLASTIC,brake:ot.BRAKE_PLASTIC,land:ot.LAND_ASPHALT},{},{},{},{},{},{},{}],19:[{drift:ot.DRIFT_ASPHALT,brake:ot.BRAKE,land:ot.LAND_ASPHALT},{drift:ot.DRIFT_RAINBOW,brake:ot.BRAKE_RAINBOW,land:ot.LAND_ASPHALT},{},{},{},{},{},{}],20:[{},{drift:ot.DRIFT_CARPET,brake:ot.BRAKE_CARPET,land:ot.LAND_CARPET,drive:ot.DRIVE_CARPET},{drift:ot.DRIFT_RAINBOW,brake:ot.BRAKE_RAINBOW,land:ot.LAND_ASPHALT},{},{},{},{},{}]}},ut=function(){function t(t,e,i){this.item=t,this.minimumMove=.17,this.canBeHeld=!0,this.canBeDropped=!0,this.isDestructive=!0,this.angle=0,this.speed=6,this.sound=null,this.soundCooldown=0,this.item.colRadius=3,this.gravity=[0,-.17,0]}return t.prototype.release=function(t){this.sound=nt.playSound(215,{volume:1.5},0,this.item),this.speed=6,this.angle=this.item.owner.physicalDir,t<0?(this.angle+=Math.PI,this.angle%=2*Math.PI):this.speed+=this.item.owner.speed},t.prototype.onDie=function(t){t||nt.playSound(214,{volume:2},0,this.item),this.sound&&(nt.instaKill(this.sound),this.sound=null)},t.prototype.collideKart=function(t){this.item.deadTimer=1,t.damage(C.DAMAGE_FLIP)},t.prototype.update=function(t){this.item.vel=[Math.sin(this.angle)*this.speed,this.item.vel[1],-Math.cos(this.angle)*this.speed],vec3.add(this.item.vel,this.item.vel,this.gravity),this.soundCooldown>0&&this.soundCooldown--},t.prototype.colResponse=function(t,e,i,s){var a=i.plane,r=a.CollisionType>>8&31;vec3.add(t,t,vec3.scale(vec3.create(),e,i.t));var n=i.normal;vec3.normalize(n,n);var o=Math.sqrt(vec3.dot(this.gravity,this.gravity)),h=(Math.acos(vec3.dot(vec3.scale(vec3.create(),this.gravity,-1/o),n)),!0);if(-1!=dt.GROUP_WALL.indexOf(r)){this.soundCooldown<=0&&(nt.playSound(213,{volume:2.5},0,this.item),this.soundCooldown=30),vec3.add(this.item.vel,vec3.scale(vec3.create(),n,vec3.dot(this.item.vel,n)/vec3.dot(n,n)*-2),this.item.vel),this.item.vel[1]=0;var l=this.item.vel;this.angle=Math.atan2(l[0],-l[2])}else if(r==dt.OOB||r==dt.FALL)0==this.item.deadTimer&&this.item.deadTimer++;else if(-1!=dt.GROUP_ROAD.indexOf(r)){var c=vec3.dot(this.item.vel,n);vec3.sub(this.item.vel,this.item.vel,vec3.scale(vec3.create(),n,c)),this.item.stuckTo=i.object}else h=!1,s.push(a);var d=Math.sqrt(vec3.dot(this.item.vel,this.item.vel));vec3.scale(this.item.vel,this.item.vel,this.speed/d),h&&vec3.add(t,t,vec3.scale(vec3.create(),n,this.minimumMove))},t}(),mt=function(){function t(t,e,i){this.item=t,this.minimumMove=.17,this.canBeHeld=!0,this.canBeDropped=!0,this.isDestructive=!0,this.angle=0,this.speed=6,this.sound=null,this.soundCooldown=0,this.item.colRadius=3,this.gravity=[0,-.17,0]}return t.prototype.release=function(t){this.sound=nt.playSound(215,{volume:1.5},0,this.item),this.speed=6,this.angle=this.item.owner.physicalDir,t<0?(this.angle+=Math.PI,this.angle%=2*Math.PI):this.speed+=this.item.owner.speed},t.prototype.onDie=function(t){t||nt.playSound(214,{volume:2},0,this.item),this.sound&&(nt.instaKill(this.sound),this.sound=null)},t.prototype.collideKart=function(t){this.item.deadTimer=1,t.damage(C.DAMAGE_FLIP)},t.prototype.update=function(t){this.item.vel=[Math.sin(this.angle)*this.speed,this.item.vel[1],-Math.cos(this.angle)*this.speed],vec3.add(this.item.vel,this.item.vel,this.gravity),this.soundCooldown>0&&this.soundCooldown--},t.prototype.colResponse=function(t,e,i,s){var a=i.plane,r=a.CollisionType>>8&31;vec3.add(t,t,vec3.scale(vec3.create(),e,i.t));var n=i.normal;vec3.normalize(n,n);var o=Math.sqrt(vec3.dot(this.gravity,this.gravity)),h=(Math.acos(vec3.dot(vec3.scale(vec3.create(),this.gravity,-1/o),n)),!0);if(-1!=dt.GROUP_WALL.indexOf(r)){this.soundCooldown<=0&&(nt.playSound(213,{volume:2.5},0,this.item),this.soundCooldown=30),vec3.add(this.item.vel,vec3.scale(vec3.create(),n,vec3.dot(this.item.vel,n)/vec3.dot(n,n)*-2),this.item.vel),this.item.vel[1]=0;var l=this.item.vel;this.angle=Math.atan2(l[0],-l[2])}else if(r==dt.OOB||r==dt.FALL)0==this.item.deadTimer&&this.item.deadTimer++;else if(-1!=dt.GROUP_ROAD.indexOf(r)){var c=vec3.dot(this.item.vel,n);vec3.sub(this.item.vel,this.item.vel,vec3.scale(vec3.create(),n,c)),this.item.stuckTo=i.object}else h=!1,s.push(a);var d=Math.sqrt(vec3.dot(this.item.vel,this.item.vel));vec3.scale(this.item.vel,this.item.vel,this.speed/d),h&&vec3.add(t,t,vec3.scale(vec3.create(),n,this.minimumMove))},t}(),ft=function(){function t(t,e,i){this.canBeHeld=!0,this.canBeDropped=!0,this.rotationPeriod=45,this.item=t,this.scene=e,this.type=i,this.item.colRadius=-1/0,this.children=[];var s="koura_g";if(this.itemCount=3,this.type.length>0){var a=this.type.split("-");1==a.length?s=this.type:2!=a.length||isNaN(+a[1])||(s=a[0],this.itemCount=+a[1])}this.phase=0,this.spinDist=6,this.remaining=this.itemCount,this.item.holdPos=[0,0,0];for(var r=0;r<this.itemCount;r++){var n=this.scene.items.createItem(s,this.item.owner);n.holdTime=7,this.children.push(n)}nt.playSound(231,{volume:2},0,this.item),this.sound=nt.playSound(227,{volume:1.5},0,this.item)}return t.prototype.onDie=function(t){this.sound&&(nt.instaKill(this.sound),this.sound=null)},t.prototype.update=function(t){for(var e=0;e<this.children.length;e++){var i=this.children[e];if(null!=i)if(i.deadTimer>0)this.children[e]=null,this.remaining--;else{var s=(e/this.itemCount+this.phase/this.rotationPeriod)*Math.PI*2,a=this.item.owner.params.colRadius,r=this.spinDist+a;i.holdPos=[-Math.sin(s)*r,-this.item.owner.params.colRadius,Math.cos(s)*r]}}this.phase++,this.phase%=this.rotationPeriod},t.prototype.release=function(t){for(var e,i=0;i<this.children.length;i++){var s=this.children[i];if(null!=s){if(!(s.deadTimer>0)){e=s,this.children[i]=null,this.remaining--;break}this.children[i]=null,this.remaining--}}null!=e&&e.release(t),0==this.remaining&&this.item.finalize()},t.prototype.draw=function(t,e){},t}(),pt=function(){function t(t,e,i){this.item=t,this.canBeHeld=!0,this.canBeDropped=!0,this.isDestructive=!1,this.item.floorBounce=0}return t.prototype.collideKart=function(t){this.item.deadTimer=1,t.damage(C.DAMAGE_SPIN)},t.prototype.onRest=function(t){nt.playSound(219,{volume:2},0,this.item)},t.prototype.update=function(t){if(!this.item.held&&this.item.colRadius<6&&(this.item.colRadius+=.2,this.item.colRadius>6&&(this.item.colRadius=6)),this.item.groundTime<30){var e=1-this.item.groundTime/29,i=Math.sin(this.item.groundTime*Math.PI/14),s=mat4.create();mat4.translate(s,s,[0,-1/6,0]),mat4.scale(s,s,[1+.6*i*e,1-.6*i*e,1]),mat4.translate(s,s,[0,1/6,0]),this.item.sprMat=s}else this.item.sprMat=null},t}(),vt=function(){function t(t,e,i){this.canBeHeld=!0,this.scene=e,this.item=t,this.canBeDropped=!0,this.isDestructive=!1,this.isSolid=!1,this.item.floorBounce=0,this.item.airResist=.98,this.xyScale=[1,1],this.dir=0}return t.prototype.collideKart=function(t){this.item.deadTimer=1,nt.playSound(250,{volume:2},0,this.item),t.damage(C.DAMAGE_FLIP)},t.prototype.onRest=function(t){nt.playSound(251,{volume:2},0,this.item)},t.prototype.update=function(t){if(this.item.held&&(this.dir=-(this.item.owner.physicalDir+this.item.owner.driftOff/4)),!this.item.held&&this.item.colRadius<8&&(this.item.colRadius+=.2,this.item.colRadius>8&&(this.item.colRadius=8)),this.item.groundTime<20){var e=1-this.item.groundTime/19,i=Math.sin(this.item.groundTime*Math.PI/8);this.xyScale=[1+.25*i*e,1-.25*i*e]}else this.xyScale=[1,1]},t.prototype.draw=function(t,e){var i=mat4.translate(mat4.create(),t,vec3.add(vec3.create(),this.item.pos,[0,1.5*this.item.colRadius*this.xyScale[1],0])),s=2*this.item.colRadius*(1-this.item.holdTime/7);mat4.scale(i,i,[s*this.xyScale[0],s*this.xyScale[1],s*this.xyScale[0]]),mat4.rotateY(i,i,this.dir),mat4.rotateZ(i,i,Math.PI/-6),mat4.rotateY(i,i,Math.PI/6),mat4.rotateX(i,i,Math.PI/-6),this.scene.gameRes.items.fakeBox.draw(i,e)},t}(),_t=function(){function t(t,e,i){this.item=t,this.canBeHeld=!0,this.canBeDropped=!0,this.isDestructive=!0,this.explodeTime=0}return t.prototype.collideKart=function(t){this.item.deadTimer=1,t.damage(C.DAMAGE_EXPLODE)},t.prototype.onRest=function(t){},t.prototype.update=function(t){this.item.deadTimer>0&&0==this.explodeTime&&(this.explodeTime=1),!this.item.held&&this.item.colRadius<6&&(this.item.colRadius+=.2,this.item.colRadius>6&&(this.item.colRadius=6))},t}(),gt=function(){function t(t,e,i,s,a,r,n,o,h){this._scene=t,this.emitter=e,this.time=0,this.duration=0|n,this.pos=vec3.add(i,i,[0,0,0]),this.vel=s,this.dirVel=r,this.dir=a,this.attached=h,this.scale=o,this.aScale=1,this.baseColor=this._convertCol(this.emitter.color),this.baseColor[3]=this.emitter.opacity/31,this.aColor=vec4.clone(this.baseColor),this.frame=this.emitter.textureId,this.emitter.texAnim&&(this.frame=this.emitter.texAnim.textures[0]),this._MAT3I=mat3.create(),this._MAT4I=mat4.create()}return t.prototype._convertCol=function(t){return[(31&t)/31,(t>>5&31)/31,(t>>10&31)/31,1]},t.prototype.update=function(t){var e=this.time/this.duration;if(this.pos[0]+=16*this.vel[0],this.pos[1]+=this.vel[1]*(this.emitter.yOffIntensity/128)*16,this.pos[2]+=16*this.vel[2],this.emitter.gravity){var i=vec3.clone([this.emitter.gravity[0],this.emitter.gravity[1],this.emitter.gravity[2]]);vec3.add(this.vel,this.vel,i)}if(this.emitter.colorAnim){var s=this.emitter.colorAnim,a=this._convertCol(s.colorFrom),r=this._convertCol(s.colorTo),n=s.framePct/65535;vec4.lerp(this.aColor,a,r,Math.max(0,(e-n)/(1-n))),this.aColor[3]=this.emitter.opacity/31}else this.aColor=vec4.clone(this.baseColor);if(this.emitter.opacityAnim){var o=this.emitter.opacityAnim.startFade/65535,h=1-Math.max(0,(e-o)/(1-o));this.aColor[3]=h}if(this.emitter.texAnim){var l=this.emitter.texAnim,c=0;c=(128&l.unknown1)>0?l.textures[Math.min(e*l.frames|0,l.frames-1)]:l.textures[this.time%l.frames],this.frame=c}this.dir+=this.dirVel,this.time++>=this.duration&&t.removeParticle(this)},t.prototype.draw=function(t,e,i){var s=this.time/this.duration,a=this.pos,r=this.vel;if(null!=this.attached){a=vec3.transformMat4([0,0,0],a,this.attached.mat);var n=this.attached.mat,o=[0,0,0];mat4.getTranslation(o,n),n[12]=0,n[13]=0,n[14]=0,r=vec3.transformMat4([0,0,0],r,n),n[12]=o[0],n[13]=o[1],n[14]=o[2]}var h=mat4.translate(mat4.create(),t,a),l=240&this.emitter.flag;if(16==l){var c=this._scene.camera.view.pos;c=vec3.sub([0,0,0],c,a),vec3.normalize(c,c);var d=vec3.sub([0,0,0],r,this.ovel);vec3.normalize(d,d),mat4.multiply(h,h,mat4.invert(mat4.create(),mat4.lookAt(mat4.create(),[0,0,0],c,d)))}else 32==l?mat4.rotateY(h,h,this.dir):48==l?(c=this._scene.camera.view.pos,c=vec3.sub([0,0,0],c,a),vec3.normalize(c,c),d=vec3.sub([0,0,0],r,this.ovel),vec3.normalize(d,d),mat4.multiply(h,h,mat4.invert(mat4.create(),mat4.lookAt(mat4.create(),[0,0,0],c,d))),mat4.rotateY(h,h,this.dir)):(mat4.multiply(h,h,_.billboardMat),mat4.rotateZ(h,h,this.dir));var u=1;if(this.emitter.scaleAnim){var m=this.emitter.scaleAnim;if(s<m.fromZeroTime){var f=s/m.fromZeroTime;u=m.scaleFrom*f}else{var p=Math.min(1,(s-m.fromZeroTime)/(1-(m.fromZeroTime+m.holdTime*(1-m.fromZeroTime))));u=m.scaleFrom*(1-p)+m.scaleTo*p}}mat4.scale(h,h,vec3.scale([0,0,0],[this.scale[0],this.scale[1],1],12*u)),mat4.translate(h,h,[this.emitter.xScaleDelta,this.emitter.yScaleDelta,0]),this._drawGeneric(h,e,i)},t.prototype._drawGeneric=function(t,e,i){var s=_.nitroShader;if(!_.flagShadow){var a=s;i.uniform1f(a.uniforms.shadOffUniform,.001),i.uniform1f(a.uniforms.lightIntensityUniform,0)}null==window.VTX_PARTICLE&&this._genGlobalVtx(i);var r=window.VTX_PARTICLE;_.setColMult(this.aColor),i.uniformMatrix4fv(s.uniforms.mvMatrixUniform,!1,t),i.uniformMatrix4fv(s.uniforms.pMatrixUniform,!1,e),i.uniformMatrix4fv(s.uniforms.matStackUniform,!1,this._MAT4I);var n=this.emitter.parent.getTexture(this.frame,i);i.bindTexture(i.TEXTURE_2D,n),i.uniformMatrix3fv(s.uniforms.texMatrixUniform,!1,this._MAT3I),r!=_.last.obj&&(i.bindBuffer(i.ARRAY_BUFFER,r.vPos),i.vertexAttribPointer(s.attributes.vertexPositionAttribute,3,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,r.vTx),i.vertexAttribPointer(s.attributes.textureCoordAttribute,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,r.vCol),i.vertexAttribPointer(s.attributes.colorAttribute,4,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,r.vMat),i.vertexAttribPointer(s.attributes.matAttribute,1,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,r.vNorm),i.vertexAttribPointer(s.attributes.normAttribute,3,i.FLOAT,!1,0,0),_.last.obj=r),i.disable(i.CULL_FACE),i.drawArrays(i.TRIANGLE_STRIP,0,4),_.setColMult([1,1,1,1]),_.flagShadow||(a=s,_.resetShadOff(),i.uniform1f(a.uniforms.lightIntensityUniform,.3))},t.prototype._genGlobalVtx=function(t){var e=[-1,-1,0,1,-1,0,-1,1,0,1,1,0],i=t.createBuffer(),s=t.createBuffer(),a=t.createBuffer(),r=t.createBuffer(),n=t.createBuffer(),o=new Float32Array(e);t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0]),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,0]),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0]),t.STATIC_DRAW),window.VTX_PARTICLE={posArray:o,vPos:i,vTx:a,vCol:s,vMat:r,vNorm:n,verts:e.length/3,mode:t.STATIC_DRAW}},t}(),Tt=function(){function t(t,e,i,s,a){this._scene=t,this._targ=e,this._emitterID=i,this.vector=s,this.offset=a,this._pRes=this._scene.gameRes.RaceEffect,this._emitter=-1==this._emitterID?null:this._pRes.particles[this._emitterID],this.attached=this._targ,null==this.vector&&(this.vector=[0,1,0]),null==this.offset&&(this.offset=[0,0,0]),this.pctParticle=0,this.time=0,this.dead=!1,this.curPrio=0,this.doNotDelete=null==this._emitter,this.pause=!1,this._particleList=[this._emitterID,-1,-1,-1]}return t.prototype.setEmitter=function(t,e){this._particleList[e]=t,this.curPrio<=e&&(this.curPrio=e,this.dead=!1,this._emitter=this._pRes.particles[t],this.time=0)},t.prototype.clearEmitter=function(t){t==this.curPrio?this._findNextEmitter():this._particleList[t]=-1},t.prototype._findNextEmitter=function(){this._particleList[this.curPrio]=-1;for(var t=this.curPrio-1;t>=0;){if(-1!=this._particleList[t])return this.dead=!1,this._emitter=this._pRes.particles[this._particleList[t]],this.time=0,void(this.curPrio=t);t--}-1==t&&(this.curPrio=0,this._emitter=null,this.dead=!0),this.curPrio=t},t.prototype.update=function(t){if(null!=this._emitter&&!this.dead&&!this.pause){if(this.time%this._emitter.frequency==0&&this.time>=this._emitter.delay){for(this.pctParticle+=this._emitter.particleChance;this.pctParticle>=1;){var e=(32768&this._emitter.flag)>0;this.pctParticle-=1;var i=vec3.create();vec3.add(i,i,this.offset),vec3.add(i,i,this._emitter.position);var s=vec3.clone([2*Math.random()-1,2*Math.random()-1,2*Math.random()-1]),a=15&this._emitter.flag;2==a&&(s[1]=0),vec3.normalize(s,s),0==a&&(s=[0,0,0]),vec3.scale(s,s,Math.random()*this._emitter.areaSpread*2),vec3.add(i,i,s),vec3.scale(i,i,16),e||(null!=this._targ.mat?vec3.transformMat4(i,i,this._targ.mat):vec3.add(i,i,this._targ.pos));var r=e?vec3.create():vec3.clone(this._targ.vel);vec3.scale(r,r,1/32);var n=vec3.clone(this.vector);if(!e&&null!=this._targ.mat){var o=this._targ.mat,h=[0,0,0];mat4.getTranslation(h,o),o[12]=0,o[13]=0,o[14]=0,vec3.transformMat4(n,n,o),o[12]=h[0],o[13]=h[1],o[14]=h[2]}vec3.normalize(n,n),vec3.add(r,r,vec3.scale([0,0,0],n,this._emitter.velocity));var l=vec3.clone([2*Math.random()-1,0,2*Math.random()-1]);vec3.normalize(l,l),vec3.scale(l,l,Math.random()*this._emitter.randomxz),vec3.add(r,r,l);var c=(this._emitter.rotVelFrom+(Math.random()*this._emitter.rotVelTo-this._emitter.rotVelFrom|0))/65535*Math.PI*2,d=(8192&this._emitter.flag)>0?Math.random()*Math.PI*2:0,u=this._emitter.duration+this._emitter.duration*this._emitter.varDuration/255*(2*Math.random()-1),m=this._emitter.varScale/255*(2*Math.random()-1)+1,f=[m*this._emitter.size,m*this._emitter.size*this._emitter.aspect],p=e?this.attached:null,v=new gt(t,this._emitter,i,r,d,c,u,f,p);v.ovel=e?vec3.create():vec3.scale([0,0,0],this._targ.vel,1/32),t.particles.push(v)}i=vec3.clone(this._targ.pos)}this.time++,this.time==this._emitter.emitterLifetime&&(this.dead=!0,this.doNotDelete?this._findNextEmitter():t.removeParticle(this))}},t.prototype.draw=function(t,e,i){},t}(),bt=function(){function t(t,e){this._obji=t,this._res=void 0,this._anim=void 0,this._animFrame=0,this._animMat=void 0,this._frames=0,this.pos=vec3.clone(this._obji.pos),this.scale=vec3.clone(this._obji.scale),this.soundProps={lastPos:this.pos,pos:this.pos,refDistance:192,rolloffFactor:1},this.mode=0,this.time=0}return t.prototype.update=function(t){switch(this.mode){case 0:for(var e=0;e<t.karts.length;e++){var i=t.karts[e];if(vec3.dist(vec3.add([0,0,0],this.pos,[0,1,0]),i.pos)<24){nt.playSound(212,{},0,this).gainN.gain.value=parseFloat("4");for(var s=0;s<10;s++)t.particles.push(new it(t,i,this._res.mdl[2]));t.particles.push(new Tt(t,i,47)),this.mode=1,this.time=0,i.items.getItem(null);break}}break;case 1:this.time++>30&&(this.mode=2,this.time=0);break;case 2:this.time++>30&&(this.mode=0,this.time=0)}this._animMat=this._anim.setFrame(0,0,this._animFrame),this._animFrame=(this._animFrame+1)%this._frames},t.prototype.draw=function(t,e,i){if(0==this.mode||2==this.mode){2==this.mode&&_.setColMult([1,1,1,this.time/30]);var s=mat4.translate(mat4.create(),t,this.pos);mat4.scale(s,s,vec3.scale([0,0,0],this.scale,16)),mat4.translate(s,s,[0,1,0]),i.enable(i.CULL_FACE),this._res.mdl[0].drawPoly(s,e,0,1,this._animMat),i.disable(i.CULL_FACE),i.depthRange(0,.99),this._res.mdl[0].drawPoly(s,e,0,0,this._animMat),i.depthRange(0,1),2==this.mode&&_.setColMult([1,1,1,1])}},t.prototype.sndUpdate=function(){this.soundProps.lastPos=this.soundProps.pos,this.soundProps.pos=this.pos,this.soundProps.refDistance=192,this.soundProps.rolloffFactor=1},t.prototype.requireRes=function(){return{mdl:[{nsbmd:"itembox.nsbmd"},{nsbmd:"obj_shadow.nsbmd"},{nsbmd:"itembox_hahen.nsbmd"}],other:["itembox.nsbca"]}},t.prototype.provideRes=function(t){this._res=t;var e=t.other[0],i=t.mdl[0].bmd;this._anim=new q(i,e),this._frames=e.animData.objectData[0].frames,this._animFrame=Math.floor(Math.random()*this._frames),this._animMat=this._anim.setFrame(0,0,this._animFrame)},t}(),yt=function(){function t(){}return t.raycast=function(e,i,s,a,r){a=null==a?0:a,t.t=1;var n=t._getTriList(e,i,s.kcl);t.colPlane=null,t.colPoint=null,t.colO=null,t._rayVTris(e,i,n,null,r,null,a);for(var o=0;o<s.colEnt.length;o++){var h=s.colEnt[o],l=h.getCollision();vec3.distance(e,h.pos)<h.colRad&&t._rayVTris(e,i,l.tris,l.mat,r,h,a,l.frame)}return null!=t.colPlane?{t:t.t,plane:t.colPlane,colPoint:t.colPoint,object:t.colO,normal:t.colPlane.Normal}:null},t.sweepEllipse=function(e,i,s,a,r){t.t=1;var n=vec3.divide([0,0,0],[1,1,1],a),o=t._getTriList(e,i,s.kcl),h=e;e=vec3.divide([0,0,0],e,a),i=vec3.divide([0,0,0],i,a),t.colPlane=null,t.colPoint=null,t.emb=!1,t.edge=!1,t._ellipseVTris(e,i,o,a,r,!0);for(var l=0;l<s.colEnt.length;l++){var c=s.colEnt[l],d=c.getCollision();vec3.distance(h,c.pos)<c.colRad&&t._ellipseVTris(e,i,d.tris,mat4.mul(mat4.create(),mat4.scale(mat4.create(),mat4.create(),n),d.mat),r,!1,c)}if(null!=t.colPlane){var u=vec3.scale([0,0,0],i,t.t);return vec3.add(u,e,u),vec3.sub(u,u,t.colPoint),Math.sqrt(vec3.dot(u,u))<.98&&(t.emb=!0),vec3.mul(t.colPoint,t.colPoint,a),{t:t.t,plane:t.colPlane,colPoint:t.colPoint,normal:u,pNormal:t.planeNormal,embedded:t.emb,object:t.colO}}return null},t.pointInTriangle=function(t,e,i){var s=vec3.sub([0,0,0],t.Vertices[2],t.Vertices[0]),a=vec3.sub([0,0,0],t.Vertices[1],t.Vertices[0]),r=vec3.sub([0,0,0],e,t.Vertices[0]),n=vec3.dot(s,s),o=vec3.dot(s,a),h=vec3.dot(s,r),l=vec3.dot(a,a),c=vec3.dot(a,r),d=1/(n*l-o*o),u=(l*h-o*c)*d,m=(n*c-o*h)*d;return u>=-i&&m>=-i&&u+m<1+i},t._rayVTris=function(e,i,s,a,r,n,o,h){for(var l=0;l<s.length;l++){var c=s[l];if(null!=a)if(c.colFrame===h&&c.cache)c=c.cache;else{var d=c;c=t._modTri(s[l],a),d.cache=c,d.colFrame=h}if(-1==r.indexOf(c)){var u=-vec3.dot(c.Normal,c.Vertices[0]),m=vec3.dot(c.Normal,e)+u,f=vec3.dot(c.Normal,i);if(!(m<0||0==f)){var p=-m/f;if(p>0&&p<t.t){var v=vec3.add([0,0,0],e,vec3.scale([0,0,0],i,p));t.pointInTriangle(c,v,o)&&(t.t=p,t.colPlane=c,t.colPoint=v,t.colO=n)}}}}},t._transformMat3Normal=function(t,e,i){var s=e[0],a=e[1],r=e[2];return t[0]=s*i[0]+a*i[4]+r*i[8],t[1]=s*i[1]+a*i[5]+r*i[9],t[2]=s*i[2]+a*i[6]+r*i[10],t},t._modTri=function(e,i){var s=[vec3.transformMat4([0,0,0],e.Vertices[0],i),vec3.transformMat4([0,0,0],e.Vertices[1],i),vec3.transformMat4([0,0,0],e.Vertices[2],i)],a=t._transformMat3Normal([0,0,0],e.Normal,i);return vec3.normalize(a,a),{Vertices:s,Normal:a,CollisionType:e.CollisionType}},t._scaleTri=function(t,e){return{Vertices:[vec3.divide([0,0,0],t.Vertices[0],e),vec3.divide([0,0,0],t.Vertices[1],e),vec3.divide([0,0,0],t.Vertices[2],e)],Normal:t.Normal,CollisionType:t.CollisionType}},t._ellipseVTris=function(e,i,s,a,r,n,o){for(var h=0;h<s.length;h++){var l=s[h];if(!r.includes(l)){var c=n?t._scaleTri(s[h],a):t._modTri(s[h],a),d=-vec3.dot(c.Normal,c.Vertices[0]),u=vec3.dot(c.Normal,e)+d,m=vec3.dot(c.Normal,i);if(!(u<0)){var f,p,v=!1;if(0==m?Math.abs(u)<1?(f=0,p=1,v=!0):(f=1e3,p=2e3):(f=(1-u)/m,p=(-1-u)/m),f>p){var _=p;p=f,f=_}if(!(f>1||p<0)){f<0&&(v=!0,f=0),p>1&&(p=1);var g=f,T=[0,0,0];if(v?vec3.sub(T,e,vec3.scale([0,0,0],c.Normal,u)):(vec3.add(T,e,vec3.scale([0,0,0],i,g)),vec3.sub(T,T,c.Normal)),t.pointInTriangle(c,T,0)&&g<t.t){t.t=g,t.colPlane=l,t.colPoint=T,t.colO=o,t.edge=!1,t.emb=v,t.planeNormal=c.Normal;continue}for(var b=0;b<=2;b++){var y=vec3.sub([0,0,0],e,c.Vertices[b]);null!=(M=t._getSmallestRoot(vec3.dot(i,i),2*vec3.dot(i,y),vec3.dot(y,y)-1,t.t))&&(t.t=M,t.colPlane=l,t.colO=o,t.colPoint=vec3.clone(c.Vertices[b]),t.planeNormal=c.Normal,t.edge=!1)}for(b=0;b<=2;b++){y=c.Vertices[b];var M,A=c.Vertices[(b+1)%3],w=vec3.sub([0,0,0],y,e),S=vec3.sub([0,0,0],A,y),R=vec3.dot(S,S),I=vec3.dot(S,i),C=vec3.dot(w,S);if(null!=(M=t._getSmallestRoot(-1*R*vec3.dot(i,i)+I*I,2*R*vec3.dot(i,w)-2*I*C,R*(1-vec3.dot(w,w))+C*C,t.t))){var x=(I*M-C)/R;x>=0&&x<=1&&(t.t=M,t.colPlane=l,t.colO=o,t.colPoint=vec3.add([0,0,0],y,vec3.scale(S,S,x)),t.planeNormal=c.Normal,t.edge=!0)}}}}}}},t._getSmallestRoot=function(t,e,i,s){var a=e*e-t*i*4;if(a<0)return null;var r=(-e-(a=Math.sqrt(a)))/(2*t),n=(-e+a)/(2*t);if(r>n){var o=r;r=n,n=o}return r>0&&r<s?r:n>0&&n<s?n:null},t._getTriList=function(t,e,i){var s=vec3.add([0,0,0],t,vec3.scale([0,0,0],e,.5));return i.getPlanesAt(s[0],s[1],s[2])},t.t=void 0,t.colPlane=void 0,t.colPoint=void 0,t.emb=void 0,t.edge=void 0,t.colO=void 0,t.planeNormal=void 0,t}(),Mt=(lt=function(t,e){return lt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},lt(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}lt(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),At=function(){function t(t,e){this.obji=t,this.scene=e,this.res=void 0,this.pos=vec3.clone(this.obji.pos),this.scale=vec3.clone(this.obji.scale),this.vel=vec3.create(),this.route=this.scene.paths[this.obji.routeID],this.routeSpeed=.01,this.unknown=65535&this.obji.setting1,this.routePos=this.obji.setting1>>16,this.variant=65535&this.obji.setting2,this.variant2=this.obji.setting2>>16,this.routePos=(this.routePos+1)%this.route.length;var i=this.routePos+this.route.length;this.nodes=[this.route[(i-2)%this.route.length].pos,this.route[(i-1)%this.route.length].pos,this.route[this.routePos].pos,this.route[(this.routePos+1)%this.route.length].pos],this.nextNode=this.route[this.routePos],this.prevPos=this.pos,this.elapsedTime=0,this.curNormal=[0,1,0],this.curFloorNormal=[0,1,0],this.floorNormal=[0,1,0],this.collidable=!0,this.colMode=0,this.colRad=512,this.colFrame=0,this.colRes=void 0,this.dirVel=0,this.prevMat=void 0,this.curMat=void 0,this.colMat=mat4.create(),this.prevMat=this.curMat}return t.prototype.moveWith=function(t){vec3.transformMat4(t.pos,t.pos,mat4.invert(mat4.create(),this.prevMat)),vec3.transformMat4(t.pos,t.pos,this.curMat)},t.prototype.requireRes=function(){throw new Error("Not implemented")},t.prototype.setMat=function(){this.prevMat=this.curMat;var t=mat4.create();mat4.translate(t,t,this.pos),mat4.scale(t,t,vec3.scale([0,0,0],this.scale,16)),mat4.mul(t,t,mat4.invert(mat4.create(),mat4.lookAt(mat4.create(),[0,0,0],this.curNormal,this.curFloorNormal))),mat4.scale(this.colMat,t,[this.colRes.scale,this.colRes.scale,this.colRes.scale]),this.colFrame++,this.curMat=t},t.prototype.getCollision=function(){return{tris:this.colRes.dat,mat:this.colMat,frame:this.colFrame}},t.prototype.provideRes=function(t){if(this.res=t,null!=t.other&&t.other.length>0&&null!=t.other[0]){var e=t.other[0];this.res.mdl[0].loadTexPAnim(e)}this.colRes=this.res.mdl[0].getBoundingCollisionModel(0,0);for(var i=0;i<this.colRes.dat.length;i++)this.colRes.dat[i].CollisionType=dt.KNOCKBACK_DAMAGE<<8},t.prototype.update=function(t){for(var e=this.elapsedTime+this.routeSpeed,i=0;i<(0==this.elapsedTime?3:1);i++)if(e<1){var s=this._cubic3D(this.nodes,e),a=vec3.dist(s,this.pos);this.routeSpeed*=2/a,this.routeSpeed>.2&&(this.routeSpeed=.2)}this.routeSpeed<=0&&(this.routeSpeed=.01),this.elapsedTime+=this.routeSpeed,i=this.elapsedTime;var r=this._cubic3D(this.nodes,i);vec3.sub(this.vel,r,this.pos),this.pos=r,this.elapsedTime>=1&&(this.elapsedTime-=1,this.routePos=(this.routePos+1)%this.route.length,this.nextNode=this.route[this.routePos],this.nodes.splice(0,1),this.nodes.push(this.route[(this.routePos+1)%this.route.length].pos),this.routeSpeed=.25),this.curNormal=vec3.sub([0,0,0],this.prevPos,this.pos),this.prevPos=vec3.clone(this.pos),vec3.normalize(this.curNormal,this.curNormal),isNaN(this.curNormal[0])&&(this.curNormal=[0,0,1]);var n=vec3.clone(this.pos);n[1]+=32;var o=yt.raycast(n,[0,-100,0],t,.05,[]);this.floorNormal=null!=o?o.normal:[0,1,0];var h=.025;this.curFloorNormal[0]+=(this.floorNormal[0]-this.curFloorNormal[0])*h,this.curFloorNormal[1]+=(this.floorNormal[1]-this.curFloorNormal[1])*h,this.curFloorNormal[2]+=(this.floorNormal[2]-this.curFloorNormal[2])*h,vec3.normalize(this.curFloorNormal,this.curFloorNormal),this.setMat()},t.prototype.draw=function(t,e){var i=mat4.translate(mat4.create(),t,this.pos);mat4.scale(i,i,vec3.scale([0,0,0],this.scale,16)),mat4.mul(i,i,mat4.invert(mat4.create(),mat4.lookAt(mat4.create(),[0,0,0],this.curNormal,this.curFloorNormal))),this.res.mdl[0].setFrame(this.variant),this.res.mdl[0].draw(i,e)},t.prototype._cubic1D=function(t,e,i,s,a){var r;return(-.5*t+1.5*e-1.5*i+.5*s)*a*(r=a*a)+(t-2.5*e+2*i-.5*s)*r+(-.5*t+.5*i)*a+e},t.prototype._cubic3D=function(t,e){var i=t[0],s=t[1],a=t[2],r=t[3];return[this._cubic1D(i[0],s[0],a[0],r[0],e),this._cubic1D(i[1],s[1],a[1],r[1],e),this._cubic1D(i[2],s[2],a[2],r[2],e)]},t}(),wt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Mt(e,t),e.prototype.requireRes=function(){return{mdl:[{nsbmd:"car_a.nsbmd"}],other:["car_a.nsbtp"]}},e}(At),St=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Mt(e,t),e.prototype.requireRes=function(){return{mdl:[{nsbmd:"truck_a.nsbmd"}],other:["truck_a.nsbtp"]}},e}(At),Rt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Mt(e,t),e.prototype.requireRes=function(){return{mdl:[{nsbmd:"bus_a.nsbmd"}]}},e}(At),It=function(){function t(t,e){this.scene=e,this.obji=t,this.res=void 0,this.pos=vec3.clone(this.obji.pos),this.scale=vec3.clone(this.obji.scale),this.frame=0,this.wheight=6.144,this.wosc=12.288,this.wstay=300,this.wchange=240,this.useAlpha=!0}return t.prototype.draw=function(t,e){if(!_.flagShadow){var i=mat4.create();gl.enable(gl.STENCIL_TEST),gl.stencilMask(255),gl.stencilFunc(gl.ALWAYS,1,255),gl.stencilOp(gl.KEEP,gl.KEEP,gl.REPLACE);var s=this.pos[1]+this.wheight+Math.sin(this.frame/150)*this.wosc;mat4.translate(i,t,[96*Math.sin(this.frame/180),s,96*Math.cos(this.frame/146)]),this.useAlpha&&_.setColMult([1,1,1,10/31]),this.res.mdl[0].drawPoly(mat4.scale(mat4.create(),i,[16,16,16]),e,0,0),gl.stencilFunc(gl.EQUAL,0,255),gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP),9!=this.obji.ID&&(mat4.translate(i,t,[0,s,0]),this.useAlpha&&_.setColMult([1,1,1,16/31]),this.res.mdl[0].drawPoly(mat4.scale(mat4.create(),i,[16,16,16]),e,0,1)),gl.disable(gl.STENCIL_TEST),null!=this.res.mdl[1]&&(mat4.translate(i,t,[96*-Math.sin((this.frame+30)/180),s,96*Math.cos((this.frame+100)/146)]),this.useAlpha&&_.setColMult([1,1,1,4/31]),this.res.mdl[1].draw(mat4.scale(mat4.create(),i,[16,16,16]),e)),_.setColMult([1,1,1,1])}},t.prototype.update=function(){this.frame=(this.frame+1)%197100},t.prototype.requireRes=function(){switch(this.obji.ID){case 1:return{mdl:[{nsbmd:"beach_waterC.nsbmd"},{nsbmd:"beach_waterA.nsbmd"}]};case 3:return this.useAlpha=!1,{mdl:[{nsbmd:"town_waterC.nsbmd"},{nsbmd:"town_waterA.nsbmd"}]};case 6:return this.useAlpha=!1,{mdl:[{nsbmd:"yoshi_waterC.nsbmd"}]};case 9:return this.useAlpha=!1,{mdl:[{nsbmd:"hyudoro_waterC.nsbmd"},{nsbmd:"hyudoro_waterA.nsbmd"}]};case 12:return this.wheight=38,this.wosc=16,{mdl:[{nsbmd:"mini_stage3_waterC.nsbmd"},{nsbmd:"mini_stage3_waterA.nsbmd"}]}}},t.prototype.provideRes=function(t){this.res=t},t}(),Ct=function(){function t(t,e){this.obji=t,this._res=void 0,this.collidable=!0,this.colMode=0,this.colRad=512,this.pos=vec3.clone(this.obji.pos),this.angle=vec3.clone(this.obji.angle),this.scale=vec3.clone(this.obji.scale),this.largerUpAngle=65535&this.obji.setting1,this.upDuration=this.obji.setting1>>16,this.statDuration=65535&this.obji.setting2,this.downDuration=this.obji.setting2>>16,this.upAngle=65535&this.obji.setting3,this.unknown=this.obji.setting4>>16,this.colFrame=0,this._genCol=void 0,this._prevMat=void 0,this._curMat=void 0,this._colMat=mat4.create(),this._anim=void 0,this._animMat=void 0,this._frame=0,this._mode=0}return t.prototype._setMat=function(){this._prevMat=this._curMat;var t=mat4.create();mat4.translate(t,t,this.pos),0!=this.angle[2]&&mat4.rotateZ(t,t,this.angle[2]*(Math.PI/180)),0!=this.angle[1]&&mat4.rotateY(t,t,this.angle[1]*(Math.PI/180)),0!=this.angle[0]&&mat4.rotateX(t,t,this.angle[0]*(Math.PI/180)),mat4.scale(t,t,vec3.scale([0,0,0],this.scale,16)),mat4.scale(this._colMat,t,[this._genCol.scale,this._genCol.scale,this._genCol.scale]),this.colFrame++,this._curMat=t},t.prototype.update=function(t){var e=0;switch(this._frame++,this._mode){case 0:var i=this._frame/this.upDuration;e=(.5-Math.cos(i*Math.PI)/2)*this.largerUpAngle,this._frame>=this.upDuration&&(this._mode=1,this._frame=0);break;case 1:case 3:e=1==this._mode?this.largerUpAngle:0,this._frame>=this.statDuration&&(this._mode=(this._mode+1)%4,this._frame=0);break;case 2:i=1-this._frame/this.downDuration,e=(.5-Math.cos(i*Math.PI)/2)*this.largerUpAngle,this._frame>=this.downDuration&&(this._mode=3,this._frame=0)}this.angle[0]=-e,this._animMat=this._anim.setFrame(0,0,1.5*e),this._setMat()},t.prototype.draw=function(t,e){var i=mat4.create();mat4.mul(i,t,this._curMat),this._res.mdl[0].draw(i,e,this._animMat)},t.prototype.requireRes=function(){return{mdl:[{nsbmd:"bridge.nsbmd"}],other:[null,"bridge.nsbca"]}},t.prototype.provideRes=function(t){this._res=t;var e=this._res.mdl[0].getCollisionModel(0,1,1792),i=this._res.mdl[0].getCollisionModel(0,0,0),s=t.other[1],a=t.mdl[0].bmd;this._anim=new q(a,s),this._genCol={dat:JSON.parse(JSON.stringify(e.dat.concat(i.dat))),scale:e.scale}},t.prototype.getCollision=function(){return{tris:this._genCol.dat,mat:this._colMat,frame:this.colFrame}},t.prototype.moveWith=function(t){vec3.transformMat4(t.pos,t.pos,mat4.invert(mat4.create(),this._prevMat)),vec3.transformMat4(t.pos,t.pos,this._curMat)},t}(),xt=function(){function t(t,e){console.log("ObjRoutePlatform"),this.collidable=!0,this.colMode=0,this.colRad=512,this._obji=t,this._res=void 0,this._genCol=void 0,this._scene=e,this._movVel=void 0,this.pos=vec3.clone(this._obji.pos),this.scale=vec3.clone(this._obji.scale),this._generateCol(),this.statDur=65535&this._obji.setting1,this.route=this._scene.paths[this._obji.routeID],this.routeSpeed=1/6,this.routePos=0,this.nextNode=this.route[this.routePos],this.prevPos=this.pos,this.elapsedTime=0,this.mode=0,this.colFrame=0}return t.prototype.update=function(t){this.colFrame++,0==this.mode?(this.elapsedTime+=this.routeSpeed,this._movVel=vec3.sub([0,0,0],this.nextNode.pos,this.prevPos),vec3.scale(this._movVel,this._movVel,this.routeSpeed/this.nextNode.duration),vec3.add(this.pos,this.pos,this._movVel),this.elapsedTime>=this.nextNode.duration&&(this.elapsedTime=0,this.prevPos=this.nextNode.pos,this.routePos=(this.routePos+1)%this.route.length,this.nextNode=this.route[this.routePos],this.mode=1)):(this.elapsedTime+=1,this._movVel=[0,0,0],this.elapsedTime>this.statDur&&(this.mode=0,this.elapsedTime=0))},t.prototype.draw=function(t,e){var i=mat4.translate(mat4.create(),t,this.pos);mat4.scale(i,i,vec3.scale([0,0,0],this.scale,16)),this._res.mdl[0].draw(i,e)},t.prototype.requireRes=function(){return{mdl:[{nsbmd:"koopa_block.nsbmd"}]}},t.prototype.provideRes=function(t){this._res=t},t.prototype._generateCol=function(){this._genCol={dat:[{Vertices:[[25,0,11],[25,0,-11],[-25,0,-11]],Normal:[0,1,0]},{Vertices:[[-25,0,-11],[-25,0,11],[25,0,11]],Normal:[0,1,0]}],scale:1}},t.prototype.getCollision=function(){var t=this._genCol,e=t.dat,i=mat4.translate(mat4.create(),mat4.create(),this.pos);return mat4.scale(i,i,vec3.mul([0,0,0],[16*t.scale,16*t.scale,16*t.scale],this.scale)),{mat:i,frame:this.colFrame,tris:e}},t.prototype.moveWith=function(t){vec3.add(t.pos,t.pos,this._movVel)},t}(),Dt=function(){function t(t,e){console.log("ObjRotaryRoom"),this._obji=t,this._res=void 0,this._dirVel=0,this.collidable=!0,this.colMode=0,this.colRad=512,this.pos=vec3.clone(this._obji.pos),this.scale=vec3.clone(this._obji.scale),this.speed=(65535&this._obji.setting1)/8192,this.angle=0}return t.prototype.update=function(t){this._dirVel=this.speed,this.angle+=this._dirVel},t.prototype.draw=function(t,e){var i=mat4.translate(mat4.create(),t,this.pos);mat4.scale(i,i,vec3.scale([0,0,0],this.scale,16)),mat4.rotateY(i,i,this.angle),this._res.mdl[0].draw(i,e)},t.prototype.requireRes=function(){return{mdl:[{nsbmd:"rotary_room.nsbmd"}]}},t.prototype.provideRes=function(t){this._res=t},t.prototype.getCollision=function(){var t=this._res.mdl[0].getCollisionModel(0,0,0),e=t.dat,i=mat4.translate(mat4.create(),mat4.create(),this.pos);return mat4.scale(i,i,vec3.mul([0,0,0],[16*t.scale,16*t.scale,16*t.scale],this.scale)),mat4.rotateY(i,i,this.angle),{tris:e,mat:i}},t.prototype.moveWith=function(t){var e=vec3.sub([0,0,0],t.pos,this.pos);vec3.transformMat4(e,e,mat4.rotateY(mat4.create(),mat4.create(),this._dirVel)),vec3.add(t.pos,this.pos,e)},t}(),Pt=function(){function t(t,e){this._forceBill=void 0,this._obji=t,this._res=void 0,this._mat=mat4.create(),this._anim=null,this._animFrame=0,this._animMat=null,this.pos=vec3.clone(this._obji.pos),this.angle=vec3.clone(this._obji.angle),this.scale=vec3.clone(this._obji.scale)}return t.prototype.draw=function(t,e){this._forceBill&&_.setShadBias(.001),mat4.translate(this._mat,t,this.pos),0!=this.angle[2]&&mat4.rotateZ(this._mat,this._mat,this.angle[2]*(Math.PI/180)),0!=this.angle[1]&&mat4.rotateY(this._mat,this._mat,this.angle[1]*(Math.PI/180)),0!=this.angle[0]&&mat4.rotateX(this._mat,this._mat,this.angle[0]*(Math.PI/180)),mat4.scale(this._mat,this._mat,vec3.scale([0,0,0],this.scale,16)),this._res.mdl[0].draw(this._mat,e,this._animMat),this._forceBill&&_.resetShadOff()},t.prototype.update=function(){this._res.mdl[0].setFrame(this._animFrame),null!=this._anim&&(this._animMat=this._anim.setFrame(0,0,this._animFrame)),this._animFrame++},t.prototype.requireRes=function(){switch(this._forceBill=!0,this._obji.ID){case 303:return{mdl:[{nsbmd:"earthen_pipe1.nsbmd"}]};case 304:return{mdl:[{nsbmd:"opa_tree1.nsbmd"}]};case 305:return{mdl:[{nsbmd:"OlgPipe1.nsbmd"}]};case 306:return{mdl:[{nsbmd:"OlgMush1.nsbmd"}]};case 307:return{mdl:[{nsbmd:"of6yoshi1.nsbmd"}]};case 308:return{mdl:[{nsbmd:"cow.nsbmd"}],other:[null,null,"cow.nsbtp"]};case 309:return this._forceBill=!1,{mdl:[{nsbmd:"NsKiller1.nsbmd"},{nsbmd:"NsKiller2.nsbmd"},{nsbmd:"NsKiller2_s.nsbmd"}]};case 312:case 319:return{mdl:[{nsbmd:"GardenTree1.nsbmd"}]};case 313:return{mdl:[{nsbmd:"kamome.nsbmd"}],other:[null,null,"kamome.nsbtp"]};case 314:return{mdl:[{nsbmd:"CrossTree1.nsbmd"}]};case 316:return this._forceBill=!1,{mdl:[{nsbmd:"bakubaku.nsbmd"}]};case 317:return this._forceBill=!1,{mdl:[{nsbmd:"teresa.nsbmd"}],other:[null,null,"teresa.nsbtp"]};case 318:return{mdl:[{nsbmd:"Bank_Tree1.nsbmd"}]};case 320:return{mdl:[{nsbmd:"chandelier.nsbmd"}],other:[null,"chandelier.nsbca"]};case 322:return{mdl:[{nsbmd:"MarioTree3.nsbmd"}]};case 325:return{mdl:[{nsbmd:"TownTree1.nsbmd"}]};case 326:return{mdl:[{nsbmd:"Snow_Tree1.nsbmd"}]};case 328:return{mdl:[{nsbmd:"DeTree1.nsbmd"}]};case 329:return{mdl:[{nsbmd:"BankEgg1.nsbmd"}]};case 331:return{mdl:[{nsbmd:"KinoHouse1.nsbmd"}]};case 332:return{mdl:[{nsbmd:"KinoHouse2.nsbmd"}]};case 333:return{mdl:[{nsbmd:"KinoMount1.nsbmd"}]};case 334:return{mdl:[{nsbmd:"KinoMount2.nsbmd"}]};case 335:return{mdl:[{nsbmd:"olaTree1c.nsbmd"}]};case 336:return{mdl:[{nsbmd:"osaTree1c.nsbmd"}]};case 337:return this._forceBill=!1,{mdl:[{nsbmd:"picture1.nsbmd"}],other:[null,"picture1.nsbca"]};case 338:return this._forceBill=!1,{mdl:[{nsbmd:"picture2.nsbmd"}],other:[null,"picture2.nsbca"]};case 339:return{mdl:[{nsbmd:"om6Tree1.nsbmd"}]};case 340:return this._forceBill=!1,{mdl:[{nsbmd:"RainStar.nsbmd"}],other:["RainStar.nsbta"]};case 341:case 342:return{mdl:[{nsbmd:"Of6Tree1.nsbmd"}]};case 343:return{mdl:[{nsbmd:"TownMonte.nsbmd"}],other:[null,null,"TownMonte.nsbtp"]};case 204:return this._forceBill=!1,{mdl:[{nsbmd:"bridge.nsbmd"}],other:[null,"bridge.nsbca"]};case 13:return this._forceBill=!1,{mdl:[{nsbmd:"puddle.nsbmd"}]};case 344:return this._forceBill=!1,{mdl:[{nsbmd:"airship.nsbmd"}]};case 401:return{mdl:[{nsbmd:"kuribo.nsbmd"}],other:[null,null,"kuribo.nsbtp"]};case 402:return this._forceBill=!1,{mdl:[{nsbmd:"rock.nsbmd"},{nsbmd:"rock_shadow.nsbmd"}]};case 403:return this._forceBill=!1,{mdl:[{nsbmd:"dossun.nsbmd"},{nsbmd:"dossun_shadow.nsbmd"}]};case 406:return this._forceBill=!1,{mdl:[{nsbmd:"wanwan.nsbmd"},{nsbmd:"wanwan_chain.nsbmd"},{nsbmd:"wanwan_kui.nsbmd"},{nsbmd:"rock_shadow.nsbmd"}]};case 408:return{mdl:[{nsbmd:"mkd_ef_bubble.nsbmd"}]};case 409:return this._forceBill=!1,{mdl:[{nsbmd:"choropu.nsbmd"}],other:[null,null,"choropu.nsbtp"]};case 411:return{mdl:[{nsbmd:"pukupuku.nsbmd"}]};case 413:return{mdl:[{nsbmd:"sman_top.nsbmd"},{nsbmd:"sman_bottom.nsbmd"}]};case 414:return this._forceBill=!1,{mdl:[{nsbmd:"kanoke_64.nsbmd"},{nsbmd:"basabasa.nsbmd"}],other:[null,"kanoke_64.nsbca"]};case 416:return{mdl:[{nsbmd:"basabasa.nsbmd"}],other:[null,null,"basabasa.nsbtp"]};case 417:return this._forceBill=!1,{mdl:[{nsbmd:"NsCannon1.nsbmd"}]};case 419:return this._forceBill=!1,{mdl:[{nsbmd:"move_tree.nsbmd"}],other:[null,"move_tree.nsbca"]};case 420:return this._forceBill=!1,{mdl:[{nsbmd:"mkd_ef_burner.nsbmd"}],other:["mkd_ef_burner.nsbta",null]};case 421:return this._forceBill=!1,{mdl:[{nsbmd:"wanwan.nsbmd"},{nsbmd:"wanwan_chain.nsbmd"},{nsbmd:"rock_shadow.nsbmd"}]};case 422:return{mdl:[{nsbmd:"ob_pakkun_sf.nsbmd"}],other:[null,null,"ob_pakkun_sf.nsbtp"]};case 423:return this._forceBill=!1,{mdl:[{nsbmd:"poo.nsbmd"},{nsbmd:"cover.nsbmd"},{nsbmd:"hole.nsbmd"}],other:[null,null,"poo.nsbtp"]};case 424:return this._forceBill=!1,{mdl:[{nsbmd:"bound.nsbmd"}],other:[null,null,"bound.nsbtp"]};case 425:return this._forceBill=!1,{mdl:[{nsbmd:"flipper.nsbmd"}],other:["flipper.nsbta",null,"flipper.nsbtp"]};case 426:return this._forceBill=!1,{mdl:[{nsbmd:"PakkunMouth.nsbmd"},{nsbmd:"PakkunBody.nsbmd"},{nsbmd:"FireBall.nsbmd"}],other:[null,"PakkunMouth.nsbca"]};case 428:return this._forceBill=!1,{mdl:[{nsbmd:"crab.nsbmd"},{nsbmd:"crab_hand.nsbmd"}],other:[null,null,"crab.nsbtp"]};case 429:return this._forceBill=!1,{mdl:[{nsbmd:"sun.nsbmd"},{nsbmd:"sun_LOD.nsbmd"}]};case 432:case 435:return{mdl:[{nsbmd:"IronBall.nsbmd"}]};case 433:return this._forceBill=!1,{mdl:[{nsbmd:"rock2.nsbmd"}]};case 434:return{mdl:[{nsbmd:"sanbo_h.nsbmd"},{nsbmd:"sanbo_b.nsbmd"}]};case 436:return this._forceBill=!1,{mdl:[{nsbmd:"cream.nsbmd"},{nsbmd:"cream_effect.nsbmd"}]};case 437:return this._forceBill=!1,{mdl:[{nsbmd:"berry.nsbmd"},{nsbmd:"cream_effect.nsbmd"}]}}},t.prototype.provideRes=function(t){if(this._res=t,this._forceBill){this.angle[1]=0;var e=t.mdl[0].bmd;e.hasBillboards=!0;for(var i=e.modelData.objectData,s=0;s<i.length;s++)for(var a=i[s].objects.objectData,r=0;r<a.length;r++)a[s].billboardMode=2}if(null!=t.other){if(t.other.length>0&&null!=t.other[0]){var n=t.other[0];this._res.mdl[0].loadTexAnim(n)}if(t.other.length>1&&null!=t.other[1]){var o=t.other[1];this._anim=new q(t.mdl[0].bmd,o)}if(t.other.length>2&&null!=t.other[2]){var h=t.other[2];this._res.mdl[0].loadTexPAnim(h)}}},t}(),Ut=function(){function t(t,e){console.log("rotatingGear"),this._obji=t,this._res=void 0,this.collidable=!0,this.colMode=0,this.colRad=512,this.pos=vec3.clone(this._obji.pos),this.scale=vec3.clone(this._obji.scale),this.speed=(65535&this._obji.setting1)/8192,this.duration=this._obji.setting1>>16,this.rampDur=65535&this._obji.setting2,this.statDur=this._obji.setting2>>16,this.wB1=65535&this._obji.setting3,this.wB2=this._obji.setting3>>16,this.time=0,this.mode=0,this.angle=0,this.dir=0==this.wB1,this.colFrame=0,this._colRes=void 0,this._dirVel=0,this._prevMat=void 0,this._curMat=void 0,this._colMat=mat4.create(),this._prevMat=this._curMat}return t.prototype._setMat=function(){this._prevMat=this._curMat;var t=mat4.create();mat4.translate(t,t,this.pos),mat4.scale(t,t,vec3.scale([0,0,0],this.scale,16)),mat4.rotateY(t,t,this._obji.angle[1]*(Math.PI/180)),mat4.rotateX(t,t,this._obji.angle[0]*(Math.PI/180)),mat4.rotateY(t,t,this.angle),mat4.scale(this._colMat,t,[this._colRes.scale,this._colRes.scale,this._colRes.scale]),this.colFrame++,this._curMat=t},t.prototype.update=function(t){switch(this.time++,this.mode){case 0:this._dirVel=this.speed*(this.time/this.rampDur)*(this.dir?-1:1),this.time>this.rampDur&&(this.time=0,this.mode=1);break;case 1:this._dirVel=this.speed*(this.dir?-1:1),this.time>this.duration&&(this.time=0,this.mode=2);break;case 2:this._dirVel=this.speed*(1-this.time/this.rampDur)*(this.dir?-1:1),this.time>this.rampDur&&(this.time=0,this.mode=3,this.dir=!this.dir);break;case 3:this._dirVel=0,this.time>this.statDur&&(this.time=0,this.mode=0)}this.angle+=this._dirVel,this._setMat()},t.prototype.draw=function(t,e){var i=mat4.translate(mat4.create(),t,this.pos);mat4.scale(i,i,vec3.scale([0,0,0],this.scale,16)),mat4.rotateY(i,i,this._obji.angle[1]*(Math.PI/180)),mat4.rotateX(i,i,this._obji.angle[0]*(Math.PI/180)),mat4.rotateY(i,i,this.angle),this._res.mdl[this.wB1].draw(i,e)},t.prototype.requireRes=function(){switch(this._obji.ID){case 203:return{mdl:[{nsbmd:"gear_white.nsbmd"},{nsbmd:"gear_black.nsbmd"}]};case 206:return{mdl:[{nsbmd:"test_cylinder.nsbmd"}]};case 209:return this.colRad=4096,{mdl:[{nsbmd:"rotary_bridge.nsbmd"}]}}},t.prototype._cloneKCL=function(t){return JSON.parse(JSON.stringify(t))},t.prototype.provideRes=function(t){this._res=t,this._colRes=this._cloneKCL(this._res.mdl[0].getCollisionModel(0,0,0))},t.prototype.getCollision=function(){return{tris:this._colRes.dat,mat:this._colMat,frame:this.colFrame}},t.prototype.moveWith=function(t){vec3.transformMat4(t.pos,t.pos,mat4.invert(mat4.create(),this._prevMat)),vec3.transformMat4(t.pos,t.pos,this._curMat)},t}(),kt=function(){function t(t,e){this.obji=t,this.pos=vec3.clone(this.obji.pos),this.soundProps={pos:this.pos,refDistance:1024,rolloffFactor:1},this.sound=null,this.sN=0,this.threshold=.2,this.gain=1,8===this.obji.ID&&(this.sN=259,this.gain=2,this.threshold=.2)}return t.prototype.draw=function(){},t.prototype.update=function(){},t.prototype.sndUpdate=function(t){this.soundProps.pos=this.pos,this.soundProps.refDistance=1024;var e=vec3.transformMat4([0,0,0],this.pos,t);this.soundProps.refDistance/(this.soundProps.refDistance+this.soundProps.rolloffFactor*(e[2]-this.soundProps.refDistance))<this.threshold?null!=this.sound&&(nt.instaKill(this.sound),this.sound=null):null==this.sound&&(this.sound=nt.playSound(this.sN,{},0,this),this.sound.gainN.gain.value=parseFloat("".concat(this.gain)))},t.prototype.requireRes=function(){return{mdl:[]}},t.prototype.provideRes=function(t){},t}(),Et=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}(),Ft=function(t){function e(e,i){var s=t.call(this,e,i)||this;return s._forceBill=!1,s}return Et(e,t),e.prototype.requireRes=function(){return{mdl:[{nsbmd:"BeachTree1.nsbmd"}]}},e}(Pt),Nt=function(){function t(){}return t.init=function(){t.idToType[1]=It,t.idToType[3]=It,t.idToType[6]=It,t.idToType[8]=kt,t.idToType[9]=It,t.idToType[12]=It,t.idToType[101]=bt,t.idToType[202]=xt,t.idToType[203]=Ut,t.idToType[206]=Ut,t.idToType[208]=Dt,t.idToType[209]=Ut,t.idToType[301]=Ft,t.idToType[302]=Ft,t.idToType[303]=Pt,t.idToType[304]=Pt,t.idToType[305]=Pt,t.idToType[306]=Pt,t.idToType[307]=Pt,t.idToType[308]=Pt,t.idToType[309]=Pt,t.idToType[312]=Pt,t.idToType[313]=Pt,t.idToType[316]=Pt,t.idToType[317]=Pt,t.idToType[314]=Pt,t.idToType[316]=Pt,t.idToType[319]=Pt,t.idToType[320]=Pt,t.idToType[322]=Pt,t.idToType[325]=Pt,t.idToType[326]=Pt,t.idToType[328]=Pt,t.idToType[329]=Pt,t.idToType[331]=Pt,t.idToType[332]=Pt,t.idToType[333]=Pt,t.idToType[334]=Pt,t.idToType[335]=Pt,t.idToType[336]=Pt,t.idToType[337]=Pt,t.idToType[338]=Pt,t.idToType[339]=Pt,t.idToType[340]=Pt,t.idToType[341]=Pt,t.idToType[342]=Pt,t.idToType[343]=Pt,t.idToType[412]=wt,t.idToType[410]=St,t.idToType[405]=Rt,t.idToType[204]=Ct,t.idToType[13]=Pt,t.idToType[344]=Pt,t.idToType[401]=Pt,t.idToType[402]=Pt,t.idToType[403]=Pt,t.idToType[406]=Pt,t.idToType[408]=Pt,t.idToType[409]=Pt,t.idToType[411]=Pt,t.idToType[413]=Pt,t.idToType[414]=Pt,t.idToType[416]=Pt,t.idToType[417]=Pt,t.idToType[419]=Pt,t.idToType[420]=Pt,t.idToType[421]=Pt,t.idToType[422]=Pt,t.idToType[423]=Pt,t.idToType[424]=Pt,t.idToType[425]=Pt,t.idToType[426]=Pt,t.idToType[428]=Pt,t.idToType[429]=Pt,t.idToType[432]=Pt,t.idToType[433]=Pt,t.idToType[434]=Pt,t.idToType[435]=Pt,t.idToType[436]=Pt,t.idToType[437]=Pt},t.idToType=new Array,t}(),Ot=function(){function t(t,e){this.kart=t,this.scene=e,this.heldItem=null,this.currentItem=null,this.empty=!0,this.cycleTime=0,this.totalTime=230,this._maxItemTime=230,this._minItemTime=80,this._carouselSfx=null,this._lastItemState=!1,this._specialItems=["star"]}return t.randomItem=function(){var e=Math.floor(Math.random()*t.items.length);return t.items[e]},t.prototype.update=function(e){var i=e.item&&!this._lastItemState,s=this._lastItemState&&!e.item;if(!this.empty)if(null==this.currentItem)if(this.cycleTime++,this.cycleTime>=this.totalTime){null!=this._carouselSfx&&nt.kill(this._carouselSfx);var a=t.randomItem();this.kart.local&&console.log(a),this._sfx(-1==this._specialItems.indexOf(a)?63:64),this.currentItem=a}else i&&null==this.heldItem&&(this.totalTime=Math.max(this._minItemTime,this.totalTime-20));else null==this.heldItem&&i&&(this.heldItem=this._createItem(),console.log("".concat(this.currentItem," drop")),this.currentItem=null,this.empty=!0,this.heldItem.canBeHeld()||this._release(e),i=!1);null!=this.heldItem&&(this.heldItem.dead?this.heldItem=null:s?this.heldItem.canBeHeld()&&this._release(e):i&&(this.heldItem.release(e.airTurn),this.kart.playCharacterSound(7),this.heldItem.dead&&(this.heldItem=null))),this._lastItemState=e.item},t.prototype.getItem=function(t){if(!this.empty)return!1;this.cycleTime=0,this.totalTime=this._maxItemTime,this.empty=!1,this._carouselSfx=this._sfx(62)},t.prototype._sfx=function(t){return this.kart.local?nt.playSound(t,{volume:2},0,null):null},t.prototype._createItem=function(){return this.scene.items.createItem(this.currentItem,this.kart)},t.prototype._release=function(t){null!=this.heldItem&&this.heldItem.release(t.airTurn),this.heldItem=null,this.kart.playCharacterSound(7)},t.items=["koura_g","koura_r"],t}(),Bt={$koura_g:mt,$koura_r:ut,$banana:pt,$bomb:_t,$f_box:vt,$koura_group:ft},Lt=function(){function t(t,e,i,s){this._minimumMove=.01,this._scene=t,this._owner=e,this._type=i,this._id=s,this.id=this._id,this.pos=vec3.transformMat4([0,0,0],[0,1-this._owner.params.colRadius,16],this._owner.mat),this.vel=vec3.create(),this.gravity=[0,-.17,0],this.minBounceVel=.5,this.airResist=.99,this.enablePhysics=!0,this.floorBounce=.5,this.held=!0,this.type=this._type,this.owner=this._owner,this.holdTime=20,this.dead=!1,this.angle=this._owner.angle,this.speed=10,this.yvel=0,this.xyScale=[1,1],this.colRadius=4,this.holdDist=2,this.safeKart=this._owner,this._safeTimeMax=4,this.safeTime=this._safeTimeMax,this.stuckTo=null,this.groundTime=0,this._deadTimerLength=30,this._throwVelocity=7,this._throwAngle=Math.PI/10*2,this._working=vec3.create(),this.deadTimer=0,this._subtypeInd=this._type.indexOf("-"),-1==this._subtypeInd&&(this._subtypeInd=this._type.length),this.controller=new(Bt["$"+this._type.substr(0,this._subtypeInd)])(this,this._scene,this._type.substr(this._subtypeInd+1)),this.update=this.update,this.draw=this.draw,this.updateHold=this.updateHold,this.release=this.release,this.canBeHeld=this.canBeHeld,this.canBeDropped=this.canBeDropped,this.isDestructive=this.isDestructive,this.isSolid=this.isSolid,this.finalize=this.finalize,this.collide=this.collide}return t.prototype.updateHold=function(t){var e,i=t.driftOff/4;if(null!=this.holdPos)e=vec3.clone(this.holdPos);else{var s=this.colRadius+t.params.colRadius+this.holdDist;e=vec3.clone([Math.sin(i)*s,-t.params.colRadius,-Math.cos(i)*s])}vec3.transformMat4(e,e,t.mat),vec3.sub(this.vel,e,this.pos),this.enablePhysics=!0},t.prototype.release=function(t){if(this.holdTime=0,this.canBeHeld()&&(this.updateHold(this._owner),this._updateCollision(this._scene)),this.enablePhysics=!0,this.controller.release)this.controller.release(t);else if(t>0){nt.playSound(218,{volume:2},0,this._owner);var e=this._owner.driftOff/4,i=vec3.clone([-Math.sin(e)*this._throwVelocity,Math.tan(this._throwAngle)*this._throwVelocity,Math.cos(e)*this._throwVelocity]),s=vec3.clone([0,0,0]);vec3.transformMat4(i,i,this._owner.mat),vec3.transformMat4(s,s,this._owner.mat),vec3.sub(i,i,s);var a=vec3.scale([0,0,0],this._owner.vel,2);vec3.add(i,i,a),this.vel=i}else this.vel=vec3.create(),this.safeKart=null;this.held=!1},t.prototype.canBeHeld=function(){return this.controller.canBeHeld||!1},t.prototype.canBeDropped=function(){return null==this.controller.canBeDropped||this.controller.canBeDropped},t.prototype.isDestructive=function(){return this.controller.isDestructive||!1},t.prototype.isSolid=function(){return null==this.controller.isSolid||this.controller.isSolid},t.prototype.finalize=function(){this.controller.onDie&&this.controller.onDie(!0),this.deadTimer=this._deadTimerLength,this._scene.items.removeItem(this),this.dead=!0},t.prototype._intensityMax=function(t,e){Math.abs(e[0])>.5*Math.abs(t[0])&&(t[0]=e[0]),Math.abs(e[1])>.5*Math.abs(t[1])&&(t[1]=e[1]),Math.abs(e[2])>.5*Math.abs(t[2])&&(t[2]=e[2])},t.prototype.collide=function(t){if(this.controller.collide)this.controller.collide(t);else if(t.hasOwnProperty("type")){var e=t;if(e.isDestructive()||this.isDestructive())this.deadTimer++,e.deadTimer++;else if(e.isSolid()&&this.isSolid()&&this.id<e.id){var i=vec3.sub(this._working,this.pos,e.pos);vec3.scale(i,i,.33),this._intensityMax(this.vel,i),vec3.scale(i,i,-1),this._intensityMax(e.vel,i),this.enablePhysics=!0,e.enablePhysics=!0}}else{var s=t;this.controller.collideKart&&this.controller.collideKart(s)}},t.prototype.update=function(t){if(this.controller.update&&this.controller.update(t),this.holdTime>0&&this.holdTime-- >7)7==this.holdTime&&nt.playSound(231,{volume:2},0,this._owner);else{if(this.pos[2]<-1e4&&this.finalize(),this.deadTimer>0)return 1==this.deadTimer&&this.controller.onDie&&this.controller.onDie(!1),this.deadTimer++,this.sprMat=mat4.create(),mat4.translate(this.sprMat,this.sprMat,[this.deadTimer/50,.5*Math.sin(this.deadTimer/30*Math.PI),0]),mat4.rotateZ(this.sprMat,this.sprMat,this.deadTimer/-15*Math.PI),void(this.deadTimer>=30&&this.finalize());this.held&&this.updateHold(this._owner);for(var e=!1,i=0;i<t.karts.length;i++){var s=t.karts[i];if(vec3.dist(vec3.add(this._working,this.pos,[0,this.colRadius/2,0]),s.pos)<this.colRadius+s.params.colRadius){if(s===this.safeKart){e=!0;continue}this.collide(s)}}if(!this.safeKart||e||this.held||(this.safeTime--,this.safeTime<=0&&(this.safeKart=null)),0==this.holdTime)for(i=0;i<t.items.items.length;i++){var a=t.items.items[i];a==this||this.held&&a.held||vec3.dist(this.pos,a.pos)<this.colRadius+a.colRadius&&a.holdTime<=7&&0==a.deadTimer&&this.collide(a)}this.groundTime>0&&this.groundTime++,this.stuckTo&&null!==this.stuckTo&&(null!=this.stuckTo.moveWith&&this.stuckTo.moveWith(this),this.enablePhysics=!0,this.stuckTo=null),this.enablePhysics&&this._updateCollision(t)}},t.prototype._updateCollision=function(t){this.held||(vec3.add(this.vel,this.vel,this.gravity),vec3.scale(this.vel,this.vel,this.airResist));for(var e=0,i=1,s=vec3.clone(this.vel),a=vec3.clone(this.pos),r=[];e++<10&&i>.01;){var n=yt.raycast(a,s,t,.05,r);null!=n?(this.controller.colResponse&&!this.held?this.controller.colResponse(a,s,n,r):this._colResponse(a,s,n,r),(i-=n.t)>.01&&(s=vec3.scale(s,this.vel,i))):(vec3.add(a,a,s),i=0)}this.pos=a},t.prototype.draw=function(t,e){if(!(this.holdTime>7)){if(this.deadTimer>0&&_.setColMult([1,1,1,1-this.deadTimer/this._deadTimerLength]),this.controller.draw)this.controller.draw(t,e);else{var i=mat4.translate(mat4.create(),t,vec3.add(vec3.create(),this.pos,[0,this.colRadius*this.xyScale[1],0]));this._spritify(i);var s=6*this.colRadius*(1-this.holdTime/7);mat4.scale(i,i,[s,s,s]);var a=this._scene.gameRes.items[this._type];if(this.sprMat){var r=a.baseMat;a.setBaseMat(this.sprMat),a.draw(i,e),a.setBaseMat(r)}else a.draw(i,e)}this.deadTimer>0&&_.setColMult([1,1,1,1])}},t.prototype._spritify=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]=e,t[1]=0,t[2]=0,t[4]=0,t[5]=e,t[6]=0,t[8]=0,t[9]=0,t[10]=e},t.prototype._colResponse=function(t,e,i,s){var a=i.plane,r=a.CollisionType>>8&31;vec3.add(t,t,vec3.scale(vec3.create(),e,i.t));var n=i.normal;vec3.normalize(n,n);var o=!0;if(-1!=dt.GROUP_WALL.indexOf(r)){var h=2*vec3.dot(this.vel,n);vec3.sub(this.vel,this.vel,vec3.scale(vec3.create(),n,h)),this.safeKart=null}else if(r==dt.OOB||r==dt.FALL)0==this.deadTimer&&this.deadTimer++;else if(-1!=dt.GROUP_ROAD.indexOf(r)){var l=this.held?0:this.floorBounce;h=vec3.dot(this.vel,n)*(1+l),vec3.sub(this.vel,this.vel,vec3.scale(vec3.create(),n,h)),!this.held&&(0==this.floorBounce||Math.abs(h)<this.minBounceVel)&&(this.vel[0]=0,this.vel[1]=0,this.vel[2]=0,this.enablePhysics=!1,0==this.groundTime&&(this.groundTime=1,this.controller.onRest&&this.controller.onRest(n))),this.stuckTo=i.object}else o=!1,s.push(a);o&&vec3.add(t,t,vec3.scale(vec3.create(),n,this._minimumMove))},t}(),Vt=function(){function t(){this.db=null,this.indexedDB=null,this.fileCallback=null}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.requestGameFiles=function(t){var e=this;this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.shimIndexedDB;var i=indexedDB.open("MKJS-DB",1);i.onerror=window.onerror,i.onsuccess=function(i){var s=i.target;e.db=s.result,e.loadGameFiles(t)},i.onupgradeneeded=function(i){var s=i.target;e.db=s.result,e.db.createObjectStore("files",{keyPath:"filename"}).transaction.oncomplete=function(i){e.loadGameFiles(t)}}},t.prototype.loadGameFiles=function(t){var e=this,i=this.db.transaction(["files"]);i.oncomplete=function(){console.log("Success transaction")};var s=i.objectStore("files").get("mkds.nds");s.onerror=function(t){alert("Fatal database error!")},s.onsuccess=function(i){null==s.result?e.downloadGame(null,t):t(s.result.data)}},t.prototype.validateFiles=function(){var t=this.db.transaction(["files"]);t.oncomplete=function(){console.log("Success transaction")};var e=t.objectStore("files").get("mkds.nds");e.onerror=function(){alert("Fatal database error!")},e.onsuccess=function(){null==e.result&&alert("Locally storing files failed!")}},t.prototype.downloadGame=function(t,e){var i=this;if("string"==typeof t){var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onload=function(){i.storeGame(s.response,e)},s.send()}else alert("You need to supply MKJS with a Mario Kart DS ROM to function. Click anywhere on the page to load a file."),this.fileCallback=e,document.getElementById("fileIn").onchange=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return i.fileInChange.apply(i,t)},this.waitForROM=!0},t.prototype.fileInChange=function(t){var e=this,i=t.target.files[0],s=new FileReader;s.onload=function(t){e.waitForROM=!1,e.storeGame(t.target.result,(function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return e.fileCallback.apply(e,t)}))},s.readAsArrayBuffer(i)},t.prototype.storeGame=function(t,e){var i=this,s=this.db.transaction(["files"],"readwrite");s.oncomplete=function(){console.log("Success transaction")};var a=s.objectStore("files").put({filename:"mkds.nds",data:t});a.onerror=function(){alert("Failed to store game locally!"),e(t)},a.onsuccess=function(){i.validateFiles(),e(t)}},t}(),jt=function(){function t(t){this.scene=t,this.items=[],this.curInd=0,this.cliID=0,this.time=0}return t.prototype.update=function(t){for(var e=this.items.slice(0),i=0;i<e.length;i++)e[i].update(t)},t.prototype.draw=function(t,e){_.setShadBias(.001);for(var i=0;i<this.items.length;i++)this.items[i].draw(t,e);_.resetShadOff()},t.prototype.createItem=function(t,e){var i=new Lt(this.scene,e,t,this.curInd++);return this.items.push(i),i},t.prototype.removeItem=function(t){var e=this.items.indexOf(t);-1!==e&&this.items.splice(e,1)},t}(),Ht=function(){return Ht=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},Ht.apply(this,arguments)},zt=function(){function t(t,e,i,s,a,r,n){this.pos=t,this.angle=e,this.speed=i,this.controller=r,this._scene=n,this._kartN=s,this._charN=a,this._minimumMove=.05,this._MAXSPEED=24,this._BOOSTTIME=90,this._kartSoundBase=170,this._COLBOUNCE_TIME=20,this._COLBOUNCE_STRENGTH=4,this._params=this._scene.gameRes.kartPhys.karts[this._kartN],this._offsets=this._scene.gameRes.kartOff.karts[this._kartN],this.wheelClass="L"==this._offsets.name[10]?2:"M"==this._offsets.name[10]?1:0,this.local=this.controller.local,this.active=!0,this.preboost=!0,this.items=new Ot(this,this._scene),this.soundProps={},this.vel=vec3.create(),this.weight=this._params.weight,this.params=this._params,this.drifting=!1,this.driftMode=0,this.driftLanded=!1,this.driftPSTick=0,this.driftPSMode=0,this.kartTargetNormal=[0,1,0],this.kartNormal=[0,1,0],this.airTime=0,this.driftOff=0,this.physicalDir=this.angle,this.mat=mat4.create(),this.basis=mat4.create(),this.ylock=0,this.cannon=null,this.gravity=[0,-.17,0],this.damageTime=0,this.damageType=-1,this.trackAttach=null,this.boostMT=0,this.boostNorm=0,this.kartColVel=vec3.create(),this.kartColTimer=0,this.kartWallTimer=0,this.charSoundTimer=0,this.placement=0,this.lastPlacement=0,this._charRes=this._scene.gameRes.getChar(this._charN),this._kartRes=this._scene.gameRes.getKart(this._kartN),this._kartPolys=[],this.profile={name:this._scene.gameRes.charNames[this._charN],emblem:this._charRes.emblem.readTexWithPal(0,0),thumb:this._scene.gameRes.playerThumb.toCanvas(!0,this._charN)},this._kObj=this._kartRes.bmd.modelData.objectData[0];for(var o=0;o<this._kObj.polys.objectData.length;o++)"kart_tire"!=this._kObj.materials.names[this._kObj.polys.objectData[o].mat]&&this._kartPolys.push(o);this._tireRes=this._scene.gameRes.tireRes,this.anim=new q(this._charRes.model.bmd,this._charRes.driveA),this.charRes=this._charRes,this.animMode="drive",this.driveAnimF=14,this.animFrame=0,this.animMat=null,this.lastInput=null,this.lapNumber=1,this.passedKTP2=!1,this.checkPointNumber=0,this.OOB=0,this.wheelParticles=[new Tt(this._scene,this,-1,[1,1.5,-1]),new Tt(this._scene,this,-1,[-1,1.5,-1])],this._scene.particles.push(this.wheelParticles[0]),this._scene.particles.push(this.wheelParticles[1]),this._nkm=this._scene.nkm,this._startLine=this._nkm.sections.KTPS.entries[0],this._passLine=this._nkm.sections.KTP2.entries[0]||this._startLine,this._respawns=this._nkm.sections.KTPJ.entries,this._checkpoints=this._nkm.sections.CPOI.entries,this._checkpoints.length<=0&&(this._checkpoints=this._nkm.sections.MEPO.entries.map((function(t){return Ht(Ht({},t),{respawn:1})}))),this._futureChecks=[1],this._hitGroundAnim=[1.07,1.13,1.17,1.19,1.2,1.19,1.17,1.13,1.07,1,.95,.92,.95],this._charGroundAnim=[1,1,1,1,1,1.08,1.14,1.18,1.14,1.06,.97,.96,.98],this._lastCollided=-1,this._lastBE=-1,this._lastColSounds={},this._ylvel=0,this._wheelTurn=0,this._onGround,this._kartAnim=0,this._groundAnim=-1,this._stuckTo=null,this._updateMat=!0,this._drawMat={kart:mat4.create(),wheels:[mat4.create(),mat4.create(),mat4.create(),mat4.create()],character:mat4.create()},this.controller.setKart(this),this._soundMode=-1,this._sounds={kart:null,drift:null,lastTerrain:-1,lastBE:-1,drive:null,boost:null,powerslide:null,boostSoundTrig:!0,transpose:0},this._updateKartSound(0,{turn:0,accel:!1,decel:!1,drift:!1,item:!1,airTurn:0}),this.lWheelParticle=null}return t.prototype._recalcMat=function(t){var e=mat4.mul(mat4.create(),t,this.mat),i=1+.015*Math.cos(this._kartAnim/4*Math.PI),s=1+.015*Math.cos((this._kartAnim+4)/4*Math.PI);-1!=this._groundAnim&&(s*=this._hitGroundAnim[this._groundAnim]),mat4.translate(e,e,[0,-this._params.colRadius,0]),mat4.scale(this._drawMat.kart,e,[16*i,16*s,16]);for(var a=0;a<4;a++){var r=16*(a<2?this._offsets.frontTireSize:1),n=mat4.translate(this._drawMat.wheels[a],e,[0,0,0]);-1!=this._groundAnim&&mat4.scale(n,n,[1,this._hitGroundAnim[this._groundAnim],1]),mat4.translate(n,n,this._offsets.wheels[a]),mat4.scale(n,n,[r,r,r]),a<2&&mat4.rotateY(n,n,(this.driveAnimF-14)/14*Math.PI/6),mat4.rotateX(n,n,this._wheelTurn),a>1&&(this.wheelParticles[a-2].offset=vec3.scale(this.wheelParticles[a-2].offset,vec3.add(this.wheelParticles[a-2].offset,this._offsets.wheels[a],[this.wheelClass*(a-2.5)*-2,-this._params.colRadius-2*this.wheelClass,0]),1/16))}r=16;var o=vec3.clone(this._offsets.chars[this._charN]);-1!=this._groundAnim&&(o[1]*=this._charGroundAnim[this._groundAnim]);var h=mat4.translate(this._drawMat.character,e,vec3.scale([0,0,0],o,16));mat4.scale(h,h,[r,r,r]),"drive"==this.animMode?this.animMat=this.anim.setFrame(0,0,this.driveAnimF):this.animMat=this.anim.setFrame(0,0,this.animFrame++),this._updateMat=!1},t.prototype.drawChar=function(t,e){this._charRes.model.draw(this._drawMat.character,e,this.animMat)},t.prototype.drawKart=function(t,e,i){this._updateMat&&this._recalcMat(t);for(var s=0;s<this._kartPolys.length;s++)this._kartRes.drawPoly(this._drawMat.kart,e,0,this._kartPolys[s],simpleMatStack)},t.prototype.drawWheels=function(t,e){this._updateMat&&this._recalcMat(t);for(var i=this._tireRes[this._offsets.name],s=0;s<4;s++)i.draw(this._drawMat.wheels[s],e,simpleMatStack)},t.prototype.draw=function(t,e){this.drawWheels(t,e),this.drawKart(t,e,gl),this.drawChar(t,e)},t.prototype.update=function(t){this.placement!=this.lastPlacement&&(this.placement<this.lastPlacement&&0==this.charSoundTimer&&(this.playCharacterSound(5),this.charSoundTimer=60),this.lastPlacement=this.placement);var e=vec3.clone(this.pos);this._updateMat=!0,-1!=this._groundAnim&&++this._groundAnim>=this._hitGroundAnim.length&&(this._groundAnim=-1),this._onGround=this.airTime<5,this._kartAnim=(this._kartAnim+1)%8;var i=this.controller.fetchInput();this.lastInput=i,this.items.update(i),i.turn>.3?this.driveAnimF>0&&this.driveAnimF--:i.turn<-.3?this.driveAnimF<28&&this.driveAnimF++:this.driveAnimF>14?this.driveAnimF--:this.driveAnimF<14&&this.driveAnimF++;var s=this._soundMode;i.accel?(0!=this._soundMode&&6!=this._soundMode||(s=2),4==this._soundMode&&(s=3)):0!=this._soundMode&&(2!=this._soundMode&&3!=this._soundMode||(s=4),4==s&&this.speed<.5&&(s=0)),this.boostMT+this.boostNorm>0?this.boostNorm==this._BOOSTTIME||this.boostMT==this._params.miniTurbo?this._sounds.boostSoundTrig&&(null!=this._sounds.boost&&nt.instaKill(this._sounds.boost),this._sounds.boost=nt.playSound(160,{},0,this),this._sounds.boost.gainN.gain.value=parseFloat("2"),this._sounds.boostSoundTrig=!1):this._sounds.boostSoundTrig=!0:null!=this._sounds.boost&&(nt.kill(this._sounds.boost),this._sounds.boost=null);var a=this._onGround&&this.speed>.5;if(a?(this._lastCollided==this._sounds.lastTerrain&&this._lastBE==this._sounds.lastBE&&null!=this._sounds.drive||(null!=this._sounds.drive&&nt.kill(this._sounds.drive),null!=this._lastColSounds.drive&&(this._sounds.drive=nt.playSound(this._lastColSounds.drive,{},0,this),this._sounds.drive.gainN.gain.value=parseFloat("2"))),this.drifting&&this.driftLanded?this._lastCollided==this._sounds.lastTerrain&&this._lastBE==this._sounds.lastBE&&null!=this._sounds.drift||(null!=this._sounds.drift&&nt.kill(this._sounds.drift),null!=this._lastColSounds.drift&&(this._sounds.drift=nt.playSound(this._lastColSounds.drift,{},0,this))):null!=this._sounds.drift&&(nt.kill(this._sounds.drift),this._sounds.drift=null),this._sounds.lastTerrain=this._lastCollided,this._sounds.lastBE=this._lastBE):(null!=this._sounds.drift&&(nt.kill(this._sounds.drift),this._sounds.drift=null),null!=this._sounds.drive&&(nt.kill(this._sounds.drive),this._sounds.drive=null)),this.wheelParticles[0].pause=!a,this.wheelParticles[1].pause=!a,this.preboost);else if(null!=this.cannon){var r=t.nkm.sections.KTPC.entries[this.cannon];if(-1!=r.id1&&-1!=r.id2){var n=t.nkm.sections.KTPC.entries[r.id2];r=n;var o=mat4.create();mat4.rotateY(o,o,r.angle[1]*(Math.PI/180)),mat4.rotateX(o,o,r.angle[0]*(-Math.PI/180)),this.pos=vec3.clone(n.pos),vec3.add(this.pos,this.pos,vec3.transformMat4([0,0,0],[0,16,32],o)),this.airTime=4,this.physicalDir=(180-n.angle[1])*(Math.PI/180),this.angle=this.physicalDir,this.cannon=null}else{o=mat4.create(),mat4.rotateY(o,o,r.angle[1]*(Math.PI/180));var h=vec3.sub([0,0,0],r.pos,this.pos),l=Math.sqrt(h[0]*h[0]+h[2]*h[2]),c=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]);mat4.rotateX(o,o,(h[1]>0?-1:1)*Math.acos(l/c));var d=[0,0,1],u=[0,1,0];this.vel=vec3.scale([0,0,0],vec3.transformMat4(d,d,o),this._MAXSPEED),this.speed=Math.min(this.speed+1,this._MAXSPEED),vec3.add(this.pos,this.pos,this.vel),this.physicalDir=(180-r.angle[1])*(Math.PI/180),this.angle=this.physicalDir,this.kartTargetNormal=vec3.transformMat4(u,u,o),this.airTime=0;var m=-vec3.dot(r.pos,d);vec3.dot(this.pos,d)+m>0&&(this.cannon=null,this.speed=this._params.topSpeed,this.vel=vec3.scale([0,0,0],vec3.transformMat4(d,d,o),this.speed))}}else{if(this.OOB>0){this.playCharacterSound(0);var f,p=this._checkpoints[this.checkPointNumber];f=null==p?this._respawns[Math.random()*this._respawns.length|0]:this._respawns[p.respawn],this.physicalDir=(180-f.angle[1])*(Math.PI/180),this.angle=this.physicalDir,this.speed=0,this.vel=vec3.create(),this.pos=vec3.clone(f.pos),vec3.add(this.pos,this.pos,[0,16,0]),null!=this.controller.setRouteID&&this.controller.setRouteID(f.id1),this.OOB=0}var v=0;-1!=this._lastCollided&&null==(v=dt.PHYS_MAP[this._lastCollided])&&(v=0);var _=this._params.colParam[v],g=this._params.topSpeed*_.topSpeedMul,T=this.boostNorm+this.boostMT>0;if(this.specialControlHandler)this._damagedControls();else{var b;if(T&&(this.boostNorm>0?(b=1.3*this._params.topSpeed,this.boostNorm--):b=this._params.topSpeed*(_.topSpeedMul>=1?1.3:_.topSpeedMul),this.boostMT>0&&this.boostMT--,this.speed<=b?(this.speed+=1,this.speed>b&&(this.speed=b)):this.speed*=.95),this.drifting){if(!this._onGround||i.accel&&i.drift&&(this.speed>2||!this.driftLanded)||(this._endDrift(),3==this.driftPSMode&&(this.boostMT=this._params.miniTurbo),this.driftPSMode=0,this.driftPSTick=0),0==this.driftMode)i.turn>.3?this.driftMode=2:i.turn<-.3&&(this.driftMode=1);else{if(this.driftLanded){var y=.05*((this.driftMode-1.5)*Math.PI/1.5-this.driftOff);this.driftOff+=y,this.physicalDir-=y}!this.driftLanded&&this.ylock>=0&&(this.physicalDir+=2*Math.PI/180*(2*this.driftMode-3))}if(this._onGround&&(this.driftLanded||(0==this.driftMode?this._endDrift():(this.driftPSMode=0,this.driftPSTick=0,this.driftLanded=!0,this.drifting&&this._setWheelParticles(20,1))),this.drifting)){T||(this.speed<=g?(this.speed+=this.speed/g>this._params.driftAccelSwitch?this._params.driftAccel2:this._params.driftAccel1,this.speed>g&&(this.speed=g)):this.speed*=.95);var M=(1==this.driftMode?i.turn-1:i.turn+1)/2;if(this.physicalDir+=this._params.driftTurnRate*M+(1==this.driftMode?-1:1)*(50/32768)*Math.PI,0!=i.turn){var A=i.turn>0==this.driftMode-1>0;switch(this.driftPSMode){case 0:A?this.driftPSTick>9?(this.driftPSMode++,this.driftPSTick=1,this._setWheelParticles(126,2),nt.playSound(210,{},0,this).gainN.gain.value=parseFloat("2")):this.driftPSTick=0:this.driftPSTick++;break;case 1:A?this.driftPSTick++:this.driftPSTick>9?(this.driftPSMode++,this.driftPSTick=1):this.driftPSTick=0;break;case 2:A?this.driftPSTick>9?(this.driftPSMode++,this.driftPSTick=1,this._setWheelParticles(22,2),this._setWheelParticles(17,1),this._sounds.powerslide=nt.playSound(209,{},0,this),this._sounds.powerslide.gainN.gain.value=parseFloat("2")):this.driftPSTick=0:this.driftPSTick++}}}}this.drifting||(this._onGround?(_=this._params.colParam[v],T||(i.accel?this.speed<=g?(this.speed+=this.speed/g>this._params.accelSwitch?this._params.accel2:this._params.accel1,this.speed>g&&(this.speed=g)):this.speed*=.95:this.speed*=this._params.decel),i.accel&&this.speed>=0||this.speed>.1?this.physicalDir+=this._params.turnRate*i.turn:this.speed<-.1&&(this.physicalDir-=this._params.turnRate*i.turn),i.drift&&(this._ylvel=1.25,this.vel[1]+=1.25,this.airTime=4,this.drifting=!0,this.driftLanded=!1,this.driftMode=0,this.ylock=0,this._onGround=!1,nt.playSound(207,{transpose:-4},0,this).gainN.gain.value=parseFloat("2"))):i.drift&&(this._ylvel=0,this.drifting=!0,this.driftLanded=!1,this.driftMode=0,this.ylock=-.001))}if(this.physicalDir=this._fixDir(this.physicalDir),0==this.driftOff||this.drifting&&this.driftLanded||(this.driftOff>0?(this.physicalDir+=this._params.driftOffRestore,this.driftOff-=this._params.driftOffRestore,this.driftOff<0&&(this.driftOff=0)):(this.physicalDir-=this._params.driftOffRestore,this.driftOff+=this._params.driftOffRestore,this.driftOff>0&&(this.driftOff=0))),this._checkKartCollision(t),this._onGround){this.angle+=this._dirDiff(this.physicalDir,this.angle)*_.handling,this.angle+=this._dirDiff(this.physicalDir,this.angle)*_.handling,this.angle=this._fixDir(this.angle);var w=Math.sin(this.physicalDir)*Math.sin(this.angle)+Math.cos(this.physicalDir)*Math.cos(this.angle);this.speed*=1-(1-w)*(1-this.params.decel),this.vel[1]+=this.gravity[1],this.vel=[Math.sin(this.angle)*this.speed,this.vel[1],-Math.cos(this.angle)*this.speed]}else this.kartTargetNormal=[0,1,0],null!=this.physBasis&&vec3.transformMat4(this.kartTargetNormal,this.kartTargetNormal,this.physBasis.mat),vec3.add(this.vel,this.vel,this.gravity),this.ylock>=0&&(this._ylvel+=this.gravity[1],this.ylock+=this._ylvel);this.kartColTimer>0&&this.kartColTimer--,this.kartWallTimer>0&&this.kartWallTimer--,this.charSoundTimer>0&&this.charSoundTimer--,this._wheelTurn+=this.speed/16,this._wheelTurn=this._fixDir(this._wheelTurn),this.airTime++,null!=this._stuckTo&&(null!=this._stuckTo.moveWith&&this._stuckTo.moveWith(this),this._stuckTo=null);var S=0,R=1,I=this.vel;null!=this.physBasis&&(this.physBasis.time--<0?this.exitBasis():(I=vec3.transformMat4([0,0,0],I,this.physBasis.mat),this.vel[1]=-1));var C=vec3.clone(I);this.kartColTimer>0&&vec3.add(C,C,vec3.scale([0,0,0],this.kartColVel,this.kartColTimer/this._COLBOUNCE_TIME));for(var x=vec3.clone(this.pos),D=[];S++<10&&R>.01;){var P=yt.sweepEllipse(x,C,t,[this._params.colRadius,this._params.colRadius,this._params.colRadius],D);null!=P?(this._colResponse(x,C,P,D),(R-=P.t)>.01&&(null!=this.physBasis&&(I=vec3.transformMat4([0,0,0],this.vel,this.physBasis.mat)),C=vec3.scale(vec3.create(),I,R))):(vec3.add(x,x,C),R=0)}this.pos=x}var U=this._onGround?.15:.025;this.kartNormal[0]+=(this.kartTargetNormal[0]-this.kartNormal[0])*U,this.kartNormal[1]+=(this.kartTargetNormal[1]-this.kartNormal[1])*U,this.kartNormal[2]+=(this.kartTargetNormal[2]-this.kartNormal[2])*U,vec3.normalize(this.kartNormal,this.kartNormal),this.basis=this._buildBasis(),o=mat4.create(),mat4.translate(o,o,this.pos),this.mat=mat4.mul(o,o,this.basis),null!=this.damageMat&&mat4.mul(o,o,this.damageMat),this._updateKartSound(s,i),this._positionChanged(e,this.pos)},t.prototype._endDrift=function(){this.drifting=!1,this._clearWheelParticles(),null!=this._sounds.powerslide&&(nt.instaKill(this._sounds.powerslide),this._sounds.powerslide=null)},t.prototype.damage=function(t){if(!(this.damageType>=t))switch(this.specialControlHandler=!0,this.playCharacterSound(0==t?1:0),this.damageType=t,this.ylock=0,this.anim.setAnim(this.charRes.spinA),this.animMode="spin",this.drifting&&this._endDrift(),this.boostMT=0,this.boostNorm=0,t){case 0:this.damageTime=40;break;case 1:this.damageTime=80,this.vel[1]+=3,this._ylvel=3,this.airTime=4;break;case 2:this.damageTime=105,this.vel[1]+=8,this._ylvel=8,this.airTime=4}},t.prototype._damagedControls=function(){0==--this.damageTime&&(this.anim.setAnim(this.charRes.driveA),this.animMode="drive",this.specialControlHandler=!1,this.damageType=-1,this.damageMat=null),vec3.scale(this.vel,this.vel,.98),this.speed*=.98;var t=40;switch(this.damageType){case 1:t=80;break;case 2:t=105}var e=1-this.damageTime/t;this.damageMat=mat4.create();var i=this.damageType%2==1?1:-1,s=Math.min(1,1.75*e);mat4.rotateX(this.damageMat,this.damageMat,2*Math.PI*s*this.damageType*i),0==this.damageType?mat4.rotateY(this.damageMat,this.damageMat,-2*Math.PI*e):mat4.rotateY(this.damageMat,this.damageMat,Math.PI/12*Math.sin(s*Math.PI))},t.prototype._triggerCannon=function(t){if(null==this.cannon){this.cannon=t;var e=this._scene.nkm.sections.KTPC.entries[this.cannon];-1!=e.id1&&-1!=e.id2?nt.playSound(345,{volume:2.5},0,this):(nt.playSound(347,{volume:2.5},0,this),this.local&&(0==e.id2?nt.playSound(380,{volume:2},0,null):nt.playSound(456,{volume:2},0,null)))}},t.prototype.playCharacterSound=function(t,e){null==e&&(e=1),nt.playSound(t+this._charRes.sndOff,{volume:2*e},2,this)},t.prototype._clearWheelParticles=function(t){for(var e=0;e<2;e++)null==t?this.wheelParticles[e].clearEmitter(1):this.wheelParticles[e].clearEmitter(0)},t.prototype._setWheelParticles=function(t,e){for(var i=0;i<2;i++)this.wheelParticles[i].setEmitter(t,e)},t.prototype._genFutureChecks=function(){var t=[],e=this._checkpoints[this.checkPointNumber].nextSection;this._futureChecks=[];for(var i=this.checkPointNumber+1;i<this._checkpoints.length;i++){var s=this._checkpoints[i];-1!=e&&s.currentSection!=e||t.includes(s.currentSection)||(this._futureChecks.push(i),t.push(s.currentSection))}},t.prototype._positionChanged=function(t,e){if(0!=this._checkpoints.length){for(var i=0;i<this._futureChecks.length;i++){var s=this._checkpoints[this._futureChecks[i]],a=vec2.sub([0,0],[s.x1,s.z1],[t[0],t[2]]),r=vec2.sub([0,0],[s.x1,s.z1],[e[0],e[2]]),n=vec2.dot(r,[s.sinus,s.cosinus]),o=vec2.dot(a,[s.sinus,s.cosinus]),h=vec2.sub([0,0],[s.x1,s.z1],[s.x2,s.z2]),l=vec2.dot(r,h);if(l>0&&l<vec2.sqrLen(h)&&n<0&&o>=0){this.checkPointNumber=this._futureChecks[i],this._genFutureChecks();break}}!this.passedKTP2&&this._forwardCrossedKTP(this._passLine,t,e)&&(this.passedKTP2=!0),this.passedKTP2&&0==this._futureChecks.length&&this._forwardCrossedKTP(this._startLine,t,e)&&(this.lapNumber++,this.checkPointNumber=0,this.passedKTP2=!1,this._futureChecks=[1],this._scene.lapAdvance(this))}},t.prototype.getPosition=function(){if(0==this._checkpoints.length||0==this._futureChecks.length)return 0;var t=this._checkpoints[this._futureChecks[0]],e=vec2.sub([0,0],[t.x1,t.z1],[this.pos[0],this.pos[2]]),i=vec2.dot(e,[t.sinus,t.cosinus]);return this.checkPointNumber+(1-Math.abs(i)/65535)+this.lapNumber*this._checkpoints.length},t.prototype._forwardCrossedKTP=function(t,e,i){var s=vec2.sub([0,0],[t.pos[0],t.pos[2]],[e[0],e[2]]),a=vec2.sub([0,0],[t.pos[0],t.pos[2]],[i[0],i[2]]),r=t.angle[1]/180*Math.PI,n=Math.sin(r),o=Math.cos(r),h=vec2.dot(a,[n,o]),l=vec2.dot(s,[n,o]);return h<0&&l>=0},t.prototype._checkKartCollision=function(t){for(var e=0;e<t.karts.length;e++){var i=t.karts[e];i.active&&this!=i&&vec3.dist(this.pos,i.pos)<16&&(this.kartBounce(i),i.kartBounce(this))}},t.prototype.kartBounce=function(t){0==this.kartColTimer&&(nt.playSound(208,{volume:2},0,this),nt.playSound(193+this._charRes.sndOff/14,{volume:1.5},0,this)),this.kartColTimer=this._COLBOUNCE_TIME;var e=this._COLBOUNCE_STRENGTH*(t.weight-this.weight+1.5)*(t.boostNorm>0||t.boostMT>0?2:1)*(this.boostNorm>0||this.boostMT>0?.5:1);vec3.sub(this.kartColVel,this.pos,t.pos),vec3.normalize(this.kartColVel,this.kartColVel),vec3.scale(this.kartColVel,this.kartColVel,e),vec3.length(this.vel)<vec3.length(t.vel)&&vec3.add(this.kartColVel,this.kartColVel,vec3.sub([0,0,0],t.vel,this.vel)),this.kartColVel[1]=0},t.prototype._fixDir=function(t){return this._posMod(t,2*Math.PI)},t.prototype._dirDiff=function(t,e){var i=this._fixDir(t-e);return i>Math.PI?-2*Math.PI+i:i},t.prototype._posMod=function(t,e){return(t%e+e)%e},t.prototype._updateKartSound=function(t,e){if(this.local){var i=this._onGround&&!this.drifting?1-Math.abs(e.turn)/11:1,s=0==t?0:22*i*Math.min(1.3,this.speed/this._params.topSpeed);this._sounds.transpose+=(s-this._sounds.transpose)/15,t!=this._soundMode&&(this._soundMode=t,null!=this._sounds.kart&&nt.instaKill(this._sounds.kart),this._sounds.kart=nt.playSound(this._kartSoundBase+this._soundMode,{transpose:this._sounds.transpose,volume:1},0,this))}},t.prototype._buildBasis=function(){var t=this.physicalDir+this.driftOff+Math.sin((this._COLBOUNCE_TIME-this.kartColTimer)/3)*(Math.PI/6)*(this.kartColTimer/this._COLBOUNCE_TIME),e=[Math.sin(t),0,-Math.cos(t)],i=[-Math.cos(t),0,-Math.sin(t)];null!=this.physBasis&&(vec3.transformMat4(e,e,this.physBasis.mat),vec3.transformMat4(i,i,this.physBasis.mat));var s=this._gramShmidt(this.kartNormal,i,e),a=s[0];return s[0]=s[1],s[1]=a,[s[0][0],s[0][1],s[0][2],0,s[1][0],s[1][1],s[1][2],0,s[2][0],s[2][1],s[2][2],0,0,0,0,1]},t.prototype._enterBasis=function(t){var e,i,s=this.angle;null!=this.physBasis?(e=vec3.transformMat4([0,0,0],[-Math.sin(s),0,Math.cos(s)],this.physBasis.mat),i=vec3.transformMat4([0,0,0],[Math.cos(s),0,Math.sin(s)],this.physBasis.mat)):(e=[-Math.sin(s),0,Math.cos(s)],i=[Math.cos(s),0,Math.sin(s)]);var a=this._gramShmidt(t,i,e),r=a[0];a[0]=a[1],a[1]=r;var n=mat4.clone([a[0][0],a[0][1],a[0][2],0,a[1][0],a[1][1],a[1][2],0,a[2][0],a[2][1],a[2][2],0,0,0,0,1]);this.physicalDir=this._dirDiff(this.physicalDir,this.angle),this.angle=0,this.vel=[Math.sin(this.angle)*this.speed,this.vel[1],-Math.cos(this.angle)*this.speed],this.physBasis={mat:n,inv:mat4.invert(mat4.create(),n),normal:t,time:15,loop:!1}},t.prototype.exitBasis=function(){var t=vec3.transformMat4([0,0,0],this.vel,this.physBasis.mat);this.physicalDir=this._dirDiff(this.physicalDir,this.angle),this.angle=Math.atan2(t[0],-t[2]),this.physicalDir+=this.angle,this.vel=t,this.physBasis=null},t.prototype.sndUpdate=function(t){this.soundProps.lastPos=this.soundProps.pos,this.soundProps.pos=this.pos,this.soundProps.refDistance=192,this.soundProps.rolloffFactor=1,this.soundProps.refDistance,this.soundProps.refDistance,this.soundProps.rolloffFactor,Math.sqrt(vec3.dot(this.soundProps.pos,this.soundProps.pos)),this.soundProps.refDistance},t.prototype._gramShmidt=function(t,e,i){var s=t,a=vec3.sub([0,0,0],e,this._project(s,e)),r=vec3.sub([0,0,0],vec3.sub([0,0,0],i,this._project(s,i)),this._project(a,i));return[vec3.normalize(s,s),vec3.normalize(a,a),vec3.normalize(r,r)]},t.prototype._colSound=function(t,e){var i=t;return null==dt.SOUNDMAP[i]?{}:dt.SOUNDMAP[i][e]||{}},t.prototype._colParticle=function(t,e){var i=t;return null==dt.SOUNDMAP[i]||null==dt.SOUNDMAP[i][e]?null:dt.SOUNDMAP[i][e].particle||null},t.prototype._project=function(t,e){return vec3.scale([0,0,0],t,vec3.dot(t,e)/vec3.dot(t,t))},t.prototype._colResponse=function(t,e,i,s){var a=i.plane,r=a.CollisionType>>8&31,n=a.CollisionType>>5&7,o=r!=this._lastCollided;this._lastCollided=r,this._lastBE=n,this._lastColSounds=this._colSound(this._lastCollided,n);var h=vec3.normalize([0,0,0],i.normal),l=h;null!=this.physBasis&&(l=vec3.transformMat4([0,0,0],h,this.physBasis.inv));var c=Math.sqrt(vec3.dot(this.gravity,this.gravity)),d=(Math.acos(vec3.dot(vec3.scale(vec3.create(),this.gravity,-1/c),h)),!0);if(-1!=dt.GROUP_OOB.indexOf(r)&&(this.OOB=1),-1!=dt.GROUP_WALL.indexOf(r)){var u=Math.sqrt(l[0]*l[0]+l[2]*l[2]),m=[l[0]/u,0,l[2]/u];if((_=vec3.dot(this.vel,m))<-1){if(0==this.kartWallTimer){null!=this._lastColSounds.hit&&nt.playSound(this._lastColSounds.hit,{volume:1},0,this);var f={pos:t,vel:vec3.clone([0,0,0]),mat:mat4.fromTranslation(mat4.create(),t)};this._scene.particles.push(new Tt(this._scene,f,13)),this._scene.particles.push(new Tt(this._scene,f,14))}this.kartWallTimer=15}vec3.sub(this.vel,this.vel,vec3.scale(vec3.create(),m,_)),r==dt.KNOCKBACK_DAMAGE&&-1==this.damageType&&(i.object.vel&&vec3.add(this.vel,this.vel,i.object.vel),vec3.add(this.vel,this.vel,vec3.scale(vec3.create(),m,1.25)),this.damage(C.DAMAGE_FLIP));var p=this.vel;this.speed=Math.sqrt(p[0]*p[0]+p[2]*p[2]),this.angle=Math.atan2(p[0],-p[2]),this._stuckTo=i.object}else if(-1!=dt.GROUP_ROAD.indexOf(r)){-1!=dt.GROUP_BOOST.indexOf(r)&&(this.boostNorm=this._BOOSTTIME);var v=r==dt.STICKY||r==dt.LOOP;this.vel[1]>0&&(this.vel[1]=0);var _=vec3.dot(this.vel,l);if(this.damageType>0?_*=1.7:!v&&_<-4&&this.vel[1]<-2&&(_-=1.5),vec3.sub(this.vel,this.vel,vec3.scale(vec3.create(),l,_)),v?(this._enterBasis(i.pNormal),this.physBasis.loop=r==dt.LOOP):null!=this.physBasis&&this.exitBasis(),this.kartTargetNormal=i.pNormal,o){var g=this._colParticle(this._lastCollided,n);null==g?this._clearWheelParticles(0):this._setWheelParticles(g,0)}this._onGround||v||(this._groundAnim=0,null!=this._lastColSounds.land&&nt.playSound(this._lastColSounds.land,{volume:1},0,this)),this.airTime=0,this._stuckTo=i.object}else r==dt.CANNON?this._triggerCannon(n):(d=!1,s.push(a));d?(vec3.add(t,t,vec3.scale(vec3.create(),e,i.t)),vec3.add(t,vec3.scale([0,0,0],h,this._params.colRadius+this._minimumMove),i.colPoint)):vec3.add(t,t,vec3.scale(vec3.create(),e,i.t))},t}(),Kt=function(){function t(t,e,i,s,a,r){this.mainNarc=t,this.texNarc=e,this.courseObj=i,this.chars=s,this.options=a,this.gameRes=r,this.music=this.courseObj.music,this.startSetups=[{maxplayers:12,toAline:4,xspacing:32,yspacing:32,liney:160},{maxplayers:24,toAline:4,xspacing:32,yspacing:32,liney:80},{maxplayers:36,toAline:6,xspacing:21,yspacing:21,liney:80},{maxplayers:48,toAline:6,xspacing:21,yspacing:21,liney:54},{maxplayers:64,toAline:8,xspacing:16,yspacing:16,liney:54},{maxplayers:112,toAline:8,xspacing:16,yspacing:16,liney:32}],this.fileBank={},this.typeRes=[],this.lightMat=mat4.create(),this.farShadMat=mat4.create(),this.shadMat=mat4.create(),this.mode={id:-1,mode:-1,time:0},this.musicRestartTimer=-1,this.musicRestart=210,this.musicRestartType=0,this.finishers=[],this.courseTx=new m(this.texNarc.getFile("/course_model.nsbtx"),!1);var n=this.mainNarc.getFile("/course_model.nsbta");if(null!=n)var o=new G(n);var h=this.mainNarc.getFile("/course_model.nsbtp");if(null!=h)var l=new z(h);var c=new f(this.mainNarc.getFile("/course_model.nsbmd")),d=new g(c,this.courseTx);null!=n&&d.loadTexAnim(o),null!=h&&d.loadTexPAnim(l);var u=new m(this.texNarc.getFile("/course_model_V.nsbtx"),!1),p=this.mainNarc.getFile("/course_model_V.nsbta");if(null!=p)var v=new G(p);var _=new f(this.mainNarc.getFile("/course_model_V.nsbmd")),T=new g(_,u);null!=p&&T.loadTexAnim(v);var b=new X(this.mainNarc.getFile("/course_collision.kcl"),!1),y=new W(this.mainNarc.getFile("/course_map.nkm"));this.course=d,this.sky=T,this.kcl=b,this.nkm=y,this.entities=[],this.karts=[],this.items=new jt(this),this.particles=[],this.colEnt=[],this.musicPlayer=null,this.startCourse(),this.frame=0,this.entsToRemove=[],this.finishPercents=[[0,66,46,58,9],[.5,66,47,56,10],[1.1,67,48,57,11]]}return t.prototype.draw=function(t,e,i){t.cullFace(t.BACK);var s=mat4.create();if(_.setAlpha(1),!i){var a=mat4.scale(mat4.create(),s,[1/64,1/64,1/64]);this.sky.setFrame(this.frame),this.courseObj.skyboxShadows||_.setLightIntensities(0,0),this.sky.draw(a,e),this.courseObj.skyboxShadows||_.setLightIntensities(.3,1)}var r=mat4.scale(mat4.create(),s,[1/64,1/64,1/64]);this.course.setFrame(this.frame),_.forceFlatNormals=!0,_.setLightIntensities(0,1),this.course.draw(r,e),_.setLightIntensities(.3,1),_.forceFlatNormals=!1;var n=[];mat4.scale(s,s,[1/1024,1/1024,1/1024]);for(var o=0;o<this.karts.length;o++)this.karts[o].active&&this.karts[o].drawKart(s,e,t);for(o=0;o<this.karts.length;o++)this.karts[o].active&&this.karts[o].drawWheels(s,e);for(o=0;o<this.karts.length;o++)this.karts[o].active&&this.karts[o].drawChar(s,e);for(o=0;o<this.entities.length;o++)(h=this.entities[o]).transparent?n.push(h):h.draw(s,e,t);for(_.setLightIntensities(0,1),o=0;o<this.particles.length;o++){var h;(h=this.particles[o]).draw(s,e,t)}this.items.draw(s,e),_.setLightIntensities(.3,1)},t.prototype.sndUpdate=function(t){var e=mat4.create();mat4.scale(e,e,[1/1024,1/1024,1/1024]),t=mat4.mul(mat4.create(),t,e);for(var i=0;i<this.karts.length;i++){var s=this.karts[i];null!=s.sndUpdate&&s.sndUpdate(t)}for(i=0;i<this.entities.length;i++){var a=this.entities[i];null!=a.sndUpdate&&a.sndUpdate(t)}},t.prototype.update=function(){var t=.25,e=vec3.transformMat4([0,0,0],this.camera.targetShadowPos,this.lightMat);vec3.scale(e,e,1/1024),mat4.mul(this.shadMat,mat4.ortho(mat4.create(),e[0]-t,e[0]+t,e[1]-t,e[1]+t,-e[2]-2.5,2.5-e[2]),this.lightMat);for(var i=[],s=0;s<this.karts.length;s++)i.push(this.karts[s]);for(i.sort((function(t,e){return e.getPosition()-t.getPosition()})),s=0;s<i.length;s++)i[s].placement=s+1;for(s=0;s<this.karts.length;s++){var a=this.karts[s];a.active&&a.update(this)}var r=this.entities.slice(0);for(s=0;s<r.length;s++)r[s].update(this);var n=this.particles.slice(0);for(s=0;s<n.length;s++)n[s].update(this);for(this.items.update(this),this.musicRestartTimer>-1&&(this.musicRestartTimer++,this.musicRestartTimer>this.musicRestart&&(this.musicPlayer=nt.playSound(this.music,{volume:2,bpmMultiplier:0==this.musicRestartType?1.25:1},null,null),this.musicRestartTimer=-1)),s=0;s<this.entsToRemove.length;s++)this.entities.splice(this.entities.indexOf(this.entsToRemove[s]),1);this.entsToRemove=[];var o=this.camera.getView(this,_.getViewWidth(),_.getViewHeight());nt.updateListener(o.pos,o.mv),this.frame++},t.prototype.removeParticle=function(t){this.particles.splice(this.particles.indexOf(t),1)},t.prototype.removeEntity=function(t){this.entsToRemove.push(t)},t.prototype.compilePaths=function(){for(var t=this.nkm.sections.PATH.entries,e=this.nkm.sections.POIT.entries,i=[],s=0,a=0;a<t.length;a++){for(var r=[],n=0;n<t[a].numPts;n++)r.push(e[s++]);i.push(r)}this.paths=i},t.prototype.getLightCenter=function(){for(var t=vec3.create(),e=this.nkm.sections.OBJI.entries,i=0;i<e.length;i++)vec3.add(t,t,e[i].pos);return vec3.scale(t,t,1/e.length/-1024),t},t.prototype.startCourse=function(){this.lightMat=mat4.create(),mat4.rotateX(this.lightMat,this.lightMat,Math.PI*(this.courseObj.lightHeight||61/180)),mat4.rotateY(this.lightMat,this.lightMat,Math.PI*(this.courseObj.lightAngle||21/180)),this.lightDir=[0,0,1],vec3.transformMat3(this.lightDir,this.lightDir,mat3.invert(mat3.create(),mat3.fromMat4(mat3.create(),this.lightMat))),this.farShadMat=mat4.create(),mat4.translate(this.farShadMat,this.lightMat,this.getLightCenter()),mat4.mul(this.farShadMat,mat4.ortho(mat4.create(),-5,5,-5,5,-5,5),this.farShadMat),this.compilePaths();for(var t=null,e=0;e<this.startSetups.length;e++)if(this.chars.length<this.startSetups[e].maxplayers){t=this.startSetups[e];break}var i=this.nkm.sections.KTPS.entries[0];for(e=0;e<this.chars.length;e++){var s=this.chars[e],a=s.controller,r=new zt(vec3.add([0,0,0],i.pos,this.startPosition(t.toAline,t.xspacing,t.yspacing,t.liney,i.angle[1],e)),(180-i.angle[1])*(Math.PI/180),0,s.kartN,s.charN,new a(this.nkm),this);this.karts.push(r),s.raceCam&&(this.camera=new D(r));var n=document.createElement("div");n.setAttribute("charname",r.profile.name),n.appendChild(r.profile.emblem),n.appendChild(r.profile.thumb),document.body.appendChild(n)}var o=this.nkm.sections.OBJI.entries;for(e=0;e<o.length;e++){var h=o[e],l=Nt.idToType[h.ID];if(null!=l){var c=new l(h,this);null==this.typeRes[h.ID]&&this.loadRes(c.requireRes(),h.ID),c.provideRes(this.typeRes[h.ID]),this.entities.push(c),c.collidable&&this.colEnt.push(c)}}},t.prototype.loadOrGet=function(t){var e=t.split(".").pop();null==this.fileBank["$"+e]&&(this.fileBank["$"+e]={});var i=this.fileBank["$"+e]["$"+t];if(null!=i)return i;if(["nsbmd","nsbtx","nsbca","nsbta","nsbtp"].includes(e)){var s,a=this.mainNarc.getFile(t);if(null==a&&(a=this.gameRes.MapObj.getFile(t.split("/").pop())),null==a)throw"COULD NOT FIND RESOURCE "+t+"!";switch(e){case"nsbmd":s=new f(a);break;case"nsbtx":s=new m(a,!1);break;case"nsbca":s=new u(a);break;case"nsbta":s=new G(a);break;case"nsbtp":s=new z(a)}return this.fileBank["$"+e]["$"+t]=s,s}},t.prototype.lapAdvance=function(t){var e=this.finishers.length/this.karts.length;if(t.local)if(console.log("lap ".concat(t.lapNumber)),t.lapNumber===C.MAX_LAP)this.musicRestartTimer=0,nt.instaKill(this.musicPlayer),this.musicPlayer=nt.playSound(62,{volume:2},null,null);else if(t.lapNumber===C.MAX_LAP+1){for(var i=[],s=0;s<this.finishPercents.length&&(i=this.finishPercents[s],!(this.finishPercents[s][0]>=e));s++);t.controller=new T(this.nkm),t.controller.setKart(t),t.anim.setAnim(e>.5?t.charRes.loseA:t.charRes.winA),t.animMode="raceEnd",this.camera=new P(t),nt.playSound(i[1],{volume:2},0,null),nt.playSound(i[2],{volume:2},null,null),nt.instaKill(this.musicPlayer),t.playCharacterSound(i[4],2),this.musicRestartTimer=0,this.musicRestart=450,this.musicRestartType=1,this.music=i[3],this.entities.push(new J(this))}else t.lapNumber<=C.MAX_LAP&&nt.playSound(65,{volume:2},0,null);t.lapNumber===C.MAX_LAP+1&&this.finishers.push(t)},t.prototype.startPosition=function(t,e,i,s,a,r){var n=r%t,o=Math.floor(r/t),h=[(n-t/2-.25)*e+o%2*.5,8,-(n*i+o*s)],l=mat4.rotateY(mat4.create(),mat4.create(),a*(Math.PI/180));return vec3.transformMat4(h,h,l),h},t.prototype.loadRes=function(t,e){for(var i=[],s=0;s<t.mdl.length;s++){var a=t.mdl[s],r=this.loadOrGet("/MapObj/"+a.nsbmd),n=null==a.nsbtx?null:this.loadOrGet("/MapObj/"+a.nsbtx),o=new g(r,n);i.push(o)}var h=[];if(null!=t.other)for(s=0;s<t.other.length;s++)h.push(this.loadOrGet("/MapObj/"+t.other[s]));this.typeRes[e]={mdl:i,other:h}},t.prototype.updateMode=function(t){if(this.mode.id!=t.id)switch(t.id){case 0:nt.playSound(this.courseObj.battle?12:11,{volume:2},null,null);break;case 1:this.entities.push(new Z(this));break;case 2:for(var e=0;e<this.karts.length;e++)this.karts[e].preboost=!1;nt.playSound(40,{volume:2,bpmMultiplier:16},0,null),this.entities.push(new et(this))}if(this.mode.time!=t.time)switch(t.id){case 0:break;case 1:t.time>0&&nt.playSound(39,{bpmMultiplier:16},0,null);break;case 2:1==t.time&&(this.musicPlayer=nt.playSound(this.music,{volume:2},null,null))}this.mode=t},t}(),Wt=function(){function t(){this.gl=null,this.shadowTarg=null,this.shadowRes=2048}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.init=function(t){this.gl=t,this.shadowTarg=this.createRenderTarget(t,this.shadowRes,this.shadowRes,!0)},t.prototype.drawWithShadow=function(t,e,i,s,a,r){e.lastWidth==a&&e.lastHeight==r||(e.lastWidth=a,e.lastHeight=r,e.renderTarg=this.createRenderTarget(t,a,r,!0));var n=e.camera.getView(e,a,r),o=mat4.mul(n.p,n.p,n.mv),h=e.shadMat;null==e.farShad&&(e.farShad=this.createRenderTarget(t,2*this.shadowRes,2*this.shadowRes,!0),t.viewport(0,0,2*this.shadowRes,2*this.shadowRes),t.bindFramebuffer(t.FRAMEBUFFER,e.farShad.fb),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.colorMask(!1,!1,!1,!1),e.draw(t,e.farShadMat,!0)),t.viewport(0,0,this.shadowRes,this.shadowRes),t.bindFramebuffer(t.FRAMEBUFFER,this.shadowTarg.fb),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.colorMask(!1,!1,!1,!1),e.draw(t,h,!0),t.viewport(0,0,a,r),t.bindFramebuffer(t.FRAMEBUFFER,e.renderTarg.fb),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.colorMask(!0,!0,!0,!0),e.draw(t,o,!1),e.sndUpdate(n.mv),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(i,s,a,r),$.drawShadowed(e.renderTarg.color,e.renderTarg.depth,this.shadowTarg.depth,e.farShad.depth,o,h,e.farShadMat)},t.prototype.drawTest=function(t,e,i,s,a,r){var n=e.shadMat,o=mat4.mul(mat4.create(),e.camera.view.p,e.camera.view.mv),h={p:o,mv:e.camera.view.mv};_.unsetShadowMode(),_.flagShadow=!0,_.updateBillboards(e.lightMat),null==e.farShad&&(e.farShad=this.createRenderTarget(t,2*this.shadowRes,2*this.shadowRes,!0),t.viewport(0,0,2*this.shadowRes,2*this.shadowRes),t.bindFramebuffer(t.FRAMEBUFFER,e.farShad.fb),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.colorMask(!1,!1,!1,!1),e.draw(t,e.farShadMat,!0)),t.viewport(0,0,this.shadowRes,this.shadowRes),t.bindFramebuffer(t.FRAMEBUFFER,this.shadowTarg.fb),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.colorMask(!1,!1,!1,!1),e.draw(t,n,!0),_.setShadowMode(this.shadowTarg.depth,e.farShad.depth,n,e.farShadMat,e.lightDir),_.flagShadow=!1,_.updateBillboards(h.mv),t.viewport(i,s,a,r),t.bindFramebuffer(t.FRAMEBUFFER,null),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.colorMask(!0,!0,!0,!0),e.draw(t,o,!1),e.sndUpdate(h.mv)},t.prototype.createRenderTarget=function(t,e,i,s){t.getExtension("WEBGL_depth_texture")||alert("depth texture not supported! we're DOOMED! jk we'll just have to add a fallback for people with potato gfx");var a=t.createTexture();t.bindTexture(t.TEXTURE_2D,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null);var r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT,e,i,0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null);var n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,a,0),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,r,0),{color:a,depth:r,fb:n}},t}(),Gt=function(){return Gt=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},Gt.apply(this,arguments)},Xt=function(){function t(t,e,i){this.res=i,this.mode=void 0,this.activeScene=null,this.myKart=null,this.mchar=Math.floor(12*Math.random()),this.mkart=Math.floor(36*Math.random()),this.advanceTimes=[3,4,-1,-1],this.begin(t)}return t.prototype.update=function(){null!=this.activeScene&&(this.activeScene.update(),this.updateServer())},t.prototype.updateServer=function(){var t=this.mode;if(t.frameDiv++,60==t.frameDiv){t.frameDiv-=60,t.time++;var e=this.advanceTimes[t.id];-1!=e&&t.time>=e&&(t.id++,t.time=0)}this.activeScene.updateMode(Gt({},this.mode))},t.prototype.render=function(){null!=this.activeScene&&Wt.getInstance().drawTest(gl,this.activeScene,0,0,gl.viewportWidth,gl.viewportHeight)},t.prototype.begin=function(t){if("mkds/"!=t.substr(0,5))throw"custom tracks are not implemented yet!";var e=Number(t.substr(5)),i=C.COURSES[e],s=C.COURSEDIR+i.name,a=new l(h.decompress(gameROM.getFile(s+".carc"))),r=new l(h.decompress(gameROM.getFile(s+"Tex.carc")));this.setUpCourse(a,r,i)},t.prototype.setUpCourse=function(t,e,i){var s=[];s.push({charN:this.mchar,kartN:this.mkart,controller:C.USER_CONTROLLER,raceCam:!0,extraParams:[{k:"name",v:"single"},{k:"active",v:!0}]});for(var a=0;a<7;a++){var r=Math.floor(12*Math.random()),n=Math.floor(36*Math.random());s.push({charN:r,kartN:n,controller:T,raceCam:!1,extraParams:[{k:"name",v:"no"},{k:"active",v:!0}]})}this.activeScene=new Kt(t,e,i,s,{},this.res),this.myKart=this.activeScene.karts[0],this.myKart.local=!0,this.mode={id:0,time:0,frameDiv:0,mode:0},this.activeScene.updateMode(Gt({},this.mode)),this.activeScene.entities.push(new tt(this.activeScene,this.myKart),new Q(this.activeScene,this.myKart))},t}();Object.assign(window,{TileFlattener:t,cameraIngame:D,cameraSpectator:P,cameraIntro:U,getPlayerControls:M,controlDefault:b,controlMobile:y,controlRaceCPU:T,controlNetwork:k,kartoffsetdata:n,ncer:s,ncgr:a,nclr:r,nscr:F,narc:l,narcGroup:c,ndsFS:E,sseq:N,ssar:O,nsbca:u,sbnk:L,swav:V,swar:j,spa:p,sdat:H,nsbtx:m,nsbtp:z,kartphysicalparam:o,nftr:d,nitro:i,lz77:h,nkm:W,nsbmd:f,nsbta:G,nitroAnimator:q,shadowRender:$,kcl:X,netKart:Y,nitroModel:g,nitroRender:_,nitroShaders:v,IngameRes:x,CountD3DUI:Z,Goal3DUI:J,LapCountUI:Q,PlacementUI:tt,Start3DUI:et,ItemShard:it,RedShellC:ut,GreenShellC:mt,ShellGroupC:ft,BananaGroupC:null,MushroomC:null,MushroomGroupC:null,QueenMushroomC:null,StarC:null,ThunderC:null,BlooperC:null,BooC:null,KillerC:null,BlueShellC:null,BananaC:pt,FakeBoxC:vt,BombC:_t,nitroAudio:nt,SSEQWaveCache:st,SSEQPlayer:rt,ItemBox:bt,ObjTruck:wt,ObjCar:St,ObjBus:Rt,ObjWater:It,ObjBridge:Ct,ObjRoutePlatform:xt,ObjRotaryRoom:Dt,ObjDecor:Pt,ObjGear:Ut,ObjSoundMaker:kt,objDatabase:Nt,MKDS_COLSOUNDS:ot,KartItems:Ot,Item:Lt,fileStore:Vt,ItemController:jt,NitroEmitter:Tt,NitroParticle:gt,Kart:zt,courseScene:Kt,MKDSCONST:C,sceneDrawer:Wt,singleScene:Xt,BeachTree:Ft,MKDS_COLTYPE:dt,SSEQThread:at,setupHUD:function(){var t=document.querySelector("#kcls");t.onchange=function(){localStorage.setItem("CURRENTCOURSE",t.value),location.reload()};for(var e=0;e<C.COURSES.length;e++){var i=C.COURSES[e],s=document.createElement("option");s.textContent=i.name,s.value="".concat(e),t.appendChild(s),e===C.CURRENTCOURSE&&(s.selected=!0)}var a=document.querySelector("#klang");a.onchange=function(){localStorage.setItem("CURRENTLANG",a.value),location.reload()},["us","fr","es","ge","it"].map((function(t){var e=document.createElement("option");e.textContent=t,e.value=t,a.appendChild(e),t===C.CURRENTLANG&&(e.selected=!0)}));var r=document.querySelector("#kcontrols");r.onchange=function(){localStorage.setItem("CONTROLTYPE",r.value),location.reload()},["CPU","MAN"].map((function(t){var e=document.createElement("option");e.textContent=t,e.value=t,r.appendChild(e),t===C.CONTROLTYPE&&(e.selected=!0)}));var n=document.querySelector("#klaptype");n.onchange=function(){localStorage.setItem("CURRENTLAPTYPE",n.value),location.reload()},[3,5].map((function(t){var e=document.createElement("option");e.textContent="".concat(t),e.value="".concat(t),n.appendChild(e),t===C.MAX_LAP&&(e.selected=!0)}))},getRequestAnimationFrameFnct:function(t){return t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame},mobilecheck:function(t){var e,i=!1;return e=navigator.userAgent||navigator.vendor||t.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(i=!0),i}})})();